<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Celltypist细胞注释</title>
    <link href="/2024/06/05/Celltypist%E7%BB%86%E8%83%9E%E6%B3%A8%E9%87%8A/"/>
    <url>/2024/06/05/Celltypist%E7%BB%86%E8%83%9E%E6%B3%A8%E9%87%8A/</url>
    
    <content type="html"><![CDATA[<p>运行celltypeist进行细胞注释</p><blockquote><p>参考地址:<a href="https://www.celltypist.org/tutorials">https://www.celltypist.org/tutorials</a></p></blockquote><p><strong>应该选择哪种参考数据集？</strong></p><ul><li>Cells_Fetal_Lung.pkl，人类胚胎和胎儿肺的146种细胞类型；</li><li>Cells_Intestinal_Tract.pkl，来自胎儿、儿童和成人肠道的134种肠道细胞类型；</li><li>Cells_Lung_Airway.pkl，来自人类肺部和呼吸道五个位置的scRNA的78种细胞群；</li><li>COVID19_Immune_Landscape.pkl，从COVID-19患者和健康对照者的肺和血液中提取的64种免疫亚型；</li><li>Developing_Mouse_Brain.pkl，从原肠形成到出生的小鼠胚胎大脑的174种细胞类型；</li><li>Healthy_COVID19_PBMC.pkl，健康和COVID-19个体的外周血51种单核细胞类型；</li><li>Human_Lung_Atlas.pkl，整合了46个人类呼吸系统数据集的人类肺细胞图谱（HLCA），共计58种细胞类型；</li><li>Immune_All_AddPIP.pkl，来自人的大于20个组织的免疫细胞类型(Immune_All_Low + Immune_All_PIP)；</li><li>mmune_All_High.pkl，来自19项研究的20个组织中的32个免疫细胞亚群；</li><li>Immune_All_Low.pkl，来自19项研究的20个组织中的90个免疫细胞亚群；</li><li>Immune_All_PIP.pkl，来自16个成人组织的41种免疫细胞类型；</li><li>Nuclei_Lung_Airway.pkl，来自人类肺和呼吸道五个位置的78个亚群</li><li>Pan_Fetal_Human.pkl，来自人类胎儿的138个基质和免疫亚群。</li></ul><p>例如，对于用户需要注释免疫细胞类型，官网建议从“Immune_All_Low&#x2F;High”模型开始，因为它们包含从不同组织收集的免疫细胞类型。“Low”表示低层次(高分辨率)细胞类型和子类型，“High”表示高层次(低分辨率)细胞类型。用户也可以尝试免疫细胞类型的扩展参考模型(“Immune_All_AddPIP”)。</p><p><font color="red">参考数据集下载链接 </font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Human</span></span><br>https://celltypist.cog.sanger.ac.uk/models/Autopsy_COVID19_Delorey/v1/Autopsy_COVID19_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Fetal_Lung_He/v2/Cells_Fetal_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Intestinal_Tract_Elmentaite/v1/Cells_Intestinal_Tract.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Lung_Airway_Madissoon/v4/Cells_Lung_Airway.pkl<br>https://celltypist.cog.sanger.ac.uk/models/COVID19_HumanBlood_Dratva/v1/COVID19_HumanChallenge_Blood.pkl<br>https://celltypist.cog.sanger.ac.uk/models/COVID19_Immune_Ren/v1/COVID19_Immune_Landscape.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Devbrain_Braun/v1/Developing_Human_Brain.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Thymus_Park/v1/Developing_Human_Thymus.pkl<br>https://celltypist.cog.sanger.ac.uk/models/COVID19_PBMC_Haniffa/v1/Healthy_COVID19_PBMC.pkl<br>https://celltypist.cog.sanger.ac.uk/models/IPF_HumanLung_Adams/v1/Human_IPF_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Lung_Sikkema/v2/Human_Lung_Atlas.pkl<br>https://celltypist.cog.sanger.ac.uk/models/PF_HumanLung_Habermann/v1/Human_PF_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Pan_Immune_CellTypist/v2/Immune_All_Low.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Pan_Immune_CellTypist/v2/Immune_All_High.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Lethal_COVID19_Melms/v1/Lethal_COVID19_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Lung_Airway_Madissoon/v4/Nuclei_Lung_Airway.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Pan_Fetal_Suo/v2/Pan_Fetal_Human.pkl<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Mouse</span></span><br>https://celltypist.cog.sanger.ac.uk/models/Mouse_Gut_Casado/v2/Adult_Mouse_Gut.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Thymus_Park/v1/Developing_Human_Thymus.pkl<br></code></pre></td></tr></table></figure><h3 id="运行代码（R环境）"><a href="#运行代码（R环境）" class="headerlink" title="运行代码（R环境）"></a>运行代码（R环境）</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs R">message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;运行celltypist......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>suppressPackageStartupMessages<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>    library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>stringr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>readr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>reticulate<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 可以使R和python联通的R包</span><br>    library<span class="hljs-punctuation">(</span>progress<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 打印进度条</span><br>    library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 导入python包</span><br>scanpy <span class="hljs-operator">=</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;scanpy&quot;</span><span class="hljs-punctuation">)</span><br>celltypist <span class="hljs-operator">=</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;celltypist&quot;</span><span class="hljs-punctuation">)</span><br>pandas <span class="hljs-operator">&lt;-</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;pandas&quot;</span><span class="hljs-punctuation">)</span><br>numpy <span class="hljs-operator">=</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;numpy&quot;</span><span class="hljs-punctuation">)</span><br><br>Ref_path <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;/root/wangje/Reference/cellTypist_Ref/Human/&quot;</span> <span class="hljs-comment"># 参考数据集位置</span><br><span class="hljs-comment"># Test_path &lt;- &quot;/root/wangje/Project/OveryArtical/001_大群Harmony.qs&quot; # 需要被注释的数据集</span><br>file_prefix <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HarmonyResult_&quot;</span> <span class="hljs-comment"># 输出文件前缀</span><br><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;加载参考数据集&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>model_type <span class="hljs-operator">&lt;-</span> list.files<span class="hljs-punctuation">(</span>Ref_path<span class="hljs-punctuation">,</span>pattern <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pkl$&quot;</span><span class="hljs-punctuation">)</span><br>pb <span class="hljs-operator">&lt;-</span> progress_bar<span class="hljs-operator">$</span>new<span class="hljs-punctuation">(</span><br>    format <span class="hljs-operator">=</span> <span class="hljs-string">&quot;  Loading [:bar] :percent eta: :eta&quot;</span><span class="hljs-punctuation">,</span><br>    total <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>clear <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> width<span class="hljs-operator">=</span> <span class="hljs-number">60</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span> str_split<span class="hljs-punctuation">(</span>string <span class="hljs-operator">=</span> model_type<span class="hljs-punctuation">,</span>pattern <span class="hljs-operator">=</span> <span class="hljs-string">&quot;\\.&quot;</span><span class="hljs-punctuation">,</span> simplify <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>model_list <span class="hljs-operator">=</span> lapply<span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    pb<span class="hljs-operator">$</span>tick<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>    result <span class="hljs-operator">&lt;-</span> celltypist<span class="hljs-operator">$</span>models<span class="hljs-operator">$</span>Model<span class="hljs-operator">$</span>load<span class="hljs-punctuation">(</span>model <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span>Ref_path<span class="hljs-punctuation">,</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    Sys.sleep<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    result<br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看加载的数据集</span><br>print<span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 读入测试数据</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;读入测试数据集，并转换成Annadata对象&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> qs<span class="hljs-operator">::</span>qread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/OveryArtical/001_大群Harmony.qs&#x27;</span><span class="hljs-punctuation">)</span><br>adata <span class="hljs-operator">=</span> scanpy<span class="hljs-operator">$</span>AnnData<span class="hljs-punctuation">(</span><br>    X <span class="hljs-operator">=</span> numpy<span class="hljs-operator">$</span>array<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    obs <span class="hljs-operator">=</span> pandas<span class="hljs-operator">$</span>DataFrame<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    var <span class="hljs-operator">=</span> pandas<span class="hljs-operator">$</span>DataFrame<span class="hljs-punctuation">(</span>data.frame<span class="hljs-punctuation">(</span>gene <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    row.names <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 预处理</span><br>scanpy<span class="hljs-operator">$</span>pp<span class="hljs-operator">$</span>normalize_total<span class="hljs-punctuation">(</span>adata<span class="hljs-punctuation">,</span> target_sum<span class="hljs-operator">=</span><span class="hljs-number">1e4</span><span class="hljs-punctuation">)</span><br>scanpy<span class="hljs-operator">$</span>pp<span class="hljs-operator">$</span>log1p<span class="hljs-punctuation">(</span>adata<span class="hljs-punctuation">)</span><br>adata <br><br><span class="hljs-comment"># celltype自动注释</span><br>celltypist_vis <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span><br>        adata<span class="hljs-punctuation">,</span><br>        seurat_Data<span class="hljs-punctuation">,</span><br>        reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span><br>        model <span class="hljs-operator">=</span> Immune_All_Low.pkl<span class="hljs-punctuation">,</span><br>        title <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Immune_All_Low&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    predictions <span class="hljs-operator">=</span> celltypist<span class="hljs-operator">$</span>annotate<span class="hljs-punctuation">(</span>adata<span class="hljs-punctuation">,</span> model <span class="hljs-operator">=</span> model<span class="hljs-punctuation">,</span> majority_voting <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>    seurat_Data  <span class="hljs-operator">=</span> AddMetaData<span class="hljs-punctuation">(</span>seurat_Data <span class="hljs-punctuation">,</span> predictions<span class="hljs-operator">$</span>predicted_labels<span class="hljs-punctuation">)</span> <br>    seurat_Data  <span class="hljs-operator">=</span> SetIdent<span class="hljs-punctuation">(</span>seurat_Data <span class="hljs-punctuation">,</span> value <span class="hljs-operator">=</span> <span class="hljs-string">&quot;majority_voting&quot;</span><span class="hljs-punctuation">)</span><br>    p.umap <span class="hljs-operator">=</span> DimPlot<span class="hljs-punctuation">(</span>seurat_Data<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> reduction<span class="hljs-punctuation">,</span> label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>label.box <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>repel <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>title<span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p.umap<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment"># 批量注释</span><br>pb <span class="hljs-operator">&lt;-</span> progress_bar<span class="hljs-operator">$</span>new<span class="hljs-punctuation">(</span><br>    format <span class="hljs-operator">=</span> <span class="hljs-string">&quot;  Loading [:bar] :percent eta: :eta&quot;</span><span class="hljs-punctuation">,</span><br>    total <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>clear <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> width<span class="hljs-operator">=</span> <span class="hljs-number">60</span><span class="hljs-punctuation">)</span><br><br>plotlist <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    print<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    celltypist_vis<span class="hljs-punctuation">(</span>adata <span class="hljs-operator">=</span> adata<span class="hljs-punctuation">,</span><br>    seurat_Data <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">,</span><br>    model <span class="hljs-operator">=</span> model_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    title <span class="hljs-operator">=</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">## 保存文件</span><br><span class="hljs-keyword">for</span><span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>plotlist<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;_celltypistAnno.png&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> plotlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="运行代码（python环境）"><a href="#运行代码（python环境）" class="headerlink" title="运行代码（python环境）"></a>运行代码（python环境）</h2>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>赵老师数据分析</title>
    <link href="/2024/06/05/%E8%B5%B5%E8%80%81%E5%B8%88%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/"/>
    <url>/2024/06/05/%E8%B5%B5%E8%80%81%E5%B8%88%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="1-生成Seurat对象"><a href="#1-生成Seurat对象" class="headerlink" title="1 生成Seurat对象"></a>1 生成Seurat对象</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><code class="hljs R">suppressMessages<span class="hljs-punctuation">(</span>suppressWarnings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>  library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>magrittr<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ggpubr<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>stringr<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br><span class="hljs-comment">#  合并两个文章的数据与自测数据，并保存raw Seurat对象</span><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br><br><span class="hljs-comment">#**********************************************************************************************</span><br><span class="hljs-comment"># Single-Cell Atlas of Human Ovaries Reveals The Role Of The Pyroptotic Macrophage in Ovarian Aging</span><br><span class="hljs-comment">## 从每个样本目录中读入表达矩阵文件并生成Seurt对象**********************************************</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Single-Cell Atlas of Human Ovaries Reveals The Role Of The Pyroptotic Macrophage in Ovarian Aging&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>path <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;/root/wangje/Project/OveryArtical/Aritical2&quot;</span><br>flist <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">421447</span><span class="hljs-punctuation">,</span> <span class="hljs-number">421453</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  RenameCells<span class="hljs-punctuation">(</span>CreateSeuratObject<span class="hljs-punctuation">(</span>Read10X<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span>path<span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;outs&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;filtered_feature_bc_matrix&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    min.cell <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.feature <span class="hljs-operator">=</span> <span class="hljs-number">200</span><br>  <span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> add.cell.id <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS&quot;</span><span class="hljs-punctuation">,</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">421447</span><span class="hljs-punctuation">,</span> <span class="hljs-number">421453</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">## 合并Seurat对象列表生成一个Seurat对象*********************************************************</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>name <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>flist<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  flist<span class="hljs-punctuation">[[</span>name<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">[[</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> name<br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment"># scRNA.raw &lt;- merge(flist[[1]],flist[-1])</span><br><span class="hljs-comment"># message(sprintf(c(&quot;基因为:%s&quot;,&quot;细胞为:%s&quot;),dim(scRNA.raw)))</span><br><br><span class="hljs-comment">#**********************************************************************************************</span><br><span class="hljs-comment"># Spatiotemporal transcriptomic changes of human ovarian aging and the regulatory role of FOXP1</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Spatiotemporal transcriptomic changes of human ovarian aging and the regulatory role of FOXP1&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>path <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;/root/wangje/Project/OveryArtical/GSE255690/scRNA/ExpressionData&quot;</span><br>young <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span>path<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;young1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young4&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> CreateSeuratObject<span class="hljs-punctuation">(</span>Read10X<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> min.cell <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.feature <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;young1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young4&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>middle <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span>path<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;middle2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle4&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> CreateSeuratObject<span class="hljs-punctuation">(</span>Read10X<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> min.cell <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.feature <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;middle2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle4&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>old <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span>path<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;old1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old3&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> CreateSeuratObject<span class="hljs-punctuation">(</span>Read10X<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> min.cell <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.feature <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;old1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old3&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 合并列表</span><br>flist1 <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>young<span class="hljs-punctuation">,</span> middle<span class="hljs-punctuation">,</span> old<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 添加sample列</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>name <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>flist1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  flist1<span class="hljs-punctuation">[[</span>name<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">[[</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> name<br>  flist1<span class="hljs-punctuation">[[</span>name<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> RenameCells<span class="hljs-punctuation">(</span>flist1<span class="hljs-punctuation">[[</span>name<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> add.cell.id <span class="hljs-operator">=</span> name<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">#**********************************************************************************************</span><br><span class="hljs-comment"># 自测数据</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;自测数据&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>inputDir <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;/root/wangje/Project/Data/rawData&quot;</span><br>setwd<span class="hljs-punctuation">(</span>inputDir<span class="hljs-punctuation">)</span><br>dirs <span class="hljs-operator">&lt;-</span> list.files<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;./&quot;</span><span class="hljs-punctuation">)</span><br>flist2 <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> dirs<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>j <span class="hljs-keyword">in</span> list.files<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    tryCatch<span class="hljs-punctuation">(</span><br>      <span class="hljs-punctuation">&#123;</span><br>        message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        print<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span>inputDir<span class="hljs-punctuation">,</span> i<span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;filtered_feature_bc_matrix/&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        tmp <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>Read10X<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span>inputDir<span class="hljs-punctuation">,</span> i<span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;filtered_feature_bc_matrix/&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        tmp <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>CreateSeuratObject<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">,</span> min.cell <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.feature <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><br>        tmp <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>RenameCells<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">,</span> add.cell.id <span class="hljs-operator">=</span> j<span class="hljs-punctuation">)</span><br>        flist2<span class="hljs-punctuation">[[</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;|&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> tmp<br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      error <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>e<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        message<span class="hljs-punctuation">(</span>e<span class="hljs-operator">$</span>message<span class="hljs-punctuation">)</span><br>        <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>flist2<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  flist2<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>sample <span class="hljs-operator">&lt;-</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>flist2<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;\\|&quot;</span><span class="hljs-punctuation">,</span> n <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">#***********************************************************************************************</span><br><span class="hljs-comment"># 合并数据</span><br>AllList <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>flist<span class="hljs-punctuation">,</span> flist1<span class="hljs-punctuation">,</span> flist2<span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> merge<span class="hljs-punctuation">(</span>AllList<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> AllList<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;基因为:%s&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;细胞为:%s&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> PercentageFeatureSet<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> pattern <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;^MT&#x27;</span><span class="hljs-punctuation">,</span> col.name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#***********************************************************************************************</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/Project/OveryArtical&quot;</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./01_mergeRawSeurat.qs&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 绘制小提琴图</span><br>scRNA<span class="hljs-operator">$</span>group <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS421447&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421448&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421449&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421450&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421451&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421452&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421453&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Artical1&quot;</span><span class="hljs-punctuation">,</span> ifelse<span class="hljs-punctuation">(</span><br>  scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;young1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old3&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Artical2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Self&quot;</span><br><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; 绘制质控小提琴图... ...&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VlnPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nFeature_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0.001</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span><br>  theme<span class="hljs-punctuation">(</span>axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>p2 <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VlnPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nFeature_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span><br>  theme<span class="hljs-punctuation">(</span>axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 保存图片</span><br>ggsave<span class="hljs-punctuation">(</span><br>  filename <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;01_rawSeuratOnjectVlnplot.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span> p2<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 写出表格信息</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; 绘制统计结果... ...&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>df <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>select<span class="hljs-punctuation">(</span>sample<span class="hljs-punctuation">,</span> group<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> distinct<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>rownames<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span>nrow<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">)</span><br>colnames<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Patient&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Group&quot;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>nCells <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  ncol<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>nGenes <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  nrow<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>`nCount_RNA(min-&gt;max)` <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  paste0<span class="hljs-punctuation">(</span><span class="hljs-built_in">min</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>nCount_RNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;-&gt;&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">max</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>nCount_RNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>nCount_RNA_median <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  median<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>nCount_RNA<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>`nFeature_RNA(min-&gt;max)` <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  paste0<span class="hljs-punctuation">(</span><span class="hljs-built_in">min</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>nFeature_RNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;-&gt;&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">max</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>nFeature_RNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>nFeature_RNA_median <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  median<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>nFeature_RNA<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>`percent.mt(min-&gt;max)` <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  paste0<span class="hljs-punctuation">(</span><span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">min</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>percent.mt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> digits <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;-&gt;&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">max</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>percent.mt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> digits <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>df<span class="hljs-operator">$</span>percent.mt_median <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>Patient<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  median<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">==</span> x<span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>percent.mt<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制表格</span><br>tbody.style <span class="hljs-operator">&lt;-</span> tbody_style<span class="hljs-punctuation">(</span><br>  color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span><br>  fill <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;#e8f3de&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#d3e8bb&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-number">0.9</span><br><span class="hljs-punctuation">)</span><br>ggtexttable<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">,</span><br>  rows <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>  theme <span class="hljs-operator">=</span> ttheme<span class="hljs-punctuation">(</span><br>    colnames.style <span class="hljs-operator">=</span> colnames_style<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#8cc257&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    tbody.style <span class="hljs-operator">=</span> tbody.style<br>  <span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span> <span class="hljs-operator">-&gt;</span> t_table<br><span class="hljs-comment"># 保存统计表格</span><br>ggsave<span class="hljs-punctuation">(</span><br>  filename <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;01_rawSeuratOnjectCount.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> t_table<span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br><span class="hljs-comment">#  数据粗过滤并使用DoubletFinder检测双细胞</span><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br>filter_info <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">$</span>nCount_RNA <span class="hljs-operator">&lt;</span><span class="hljs-number">30000</span> <span class="hljs-operator">&amp;</span> scRNA<span class="hljs-operator">$</span>nFeature_RNA <span class="hljs-operator">&gt;</span> <span class="hljs-number">200</span> <span class="hljs-operator">&amp;</span> scRNA<span class="hljs-operator">$</span>nFeature_RNA <span class="hljs-operator">&lt;</span> <span class="hljs-number">7000</span> <span class="hljs-operator">&amp;</span> scRNA<span class="hljs-operator">$</span>percent.mt <span class="hljs-operator">&lt;</span> <span class="hljs-number">20</span><br>scRNA.filter <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>filter_info<span class="hljs-punctuation">]</span><br>scRNA.filter<span class="hljs-operator">$</span>group <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-operator">$</span>sample <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;HRS421447&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421448&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421449&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421450&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421451&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421452&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HRS421453&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Artical1&quot;</span><span class="hljs-punctuation">,</span> ifelse<span class="hljs-punctuation">(</span><br>  scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;young1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;young4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;middle4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;old3&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Artical2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Self&quot;</span><br><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; 绘制质控小提琴图... ...&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VlnPlot<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nFeature_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0.001</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span><br>  theme<span class="hljs-punctuation">(</span>axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>p2 <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VlnPlot<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nFeature_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span><br>  theme<span class="hljs-punctuation">(</span>axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 保存图片</span><br>ggsave<span class="hljs-punctuation">(</span><br>  filename <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;02_rawFilterSeuratOnjectVlnplot.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span> p2<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># scRNA.filter 33047 features across 227793 samples within 1 assay</span><br>qsave<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./02_rawFilterSeurat.qs&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#进行双细胞检测*************************************************************************************</span><br>rm<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span>;gc<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>Merge_obj <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> normalization.method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;LogNormalize&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  FindVariableFeatures<span class="hljs-punctuation">(</span>.<span class="hljs-punctuation">,</span> selection.method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;vst&quot;</span><span class="hljs-punctuation">,</span> nfeatures <span class="hljs-operator">=</span> <span class="hljs-number">3000</span><span class="hljs-punctuation">)</span><br>Merge_obj <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>Merge_obj<span class="hljs-punctuation">,</span> vars.to.regress <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>Merge_obj <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>Merge_obj<span class="hljs-punctuation">,</span> npcs <span class="hljs-operator">=</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#去批次</span><br>library<span class="hljs-punctuation">(</span>harmony<span class="hljs-punctuation">)</span><br>Merge_obj <span class="hljs-operator">&lt;-</span> RunHarmony<span class="hljs-punctuation">(</span>Merge_obj<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">)</span><br>Merge_obj <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>Merge_obj<span class="hljs-punctuation">,</span>  dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">)</span><br>Merge_obj <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>Merge_obj<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span> <br>Merge_obj  <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>object <span class="hljs-operator">=</span> Merge_obj <span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span>from <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> to <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span>  by <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#单个分开，用来做DoubletFinder</span><br>sce_list <span class="hljs-operator">&lt;-</span> SplitObject<span class="hljs-punctuation">(</span>Merge_obj<span class="hljs-punctuation">,</span> split.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">)</span><br><br>detectDoublet <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span><br>  obj<span class="hljs-punctuation">,</span> <span class="hljs-comment">#seurat obj</span><br>  dims<span class="hljs-punctuation">,</span> <span class="hljs-comment">#Pc数目</span><br>  estDubRate<span class="hljs-punctuation">,</span> <span class="hljs-comment">#期望双细胞率，该值最好通过细胞在10X/Drop-Seq装置上的负载密度来估计</span><br>  ncores<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-comment">#线程数</span><br>  SCTransform<span class="hljs-punctuation">,</span><span class="hljs-comment">#True or False</span><br>  Homotypic<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><span class="hljs-comment">#是否需要优化同源双细胞</span><br>  annotation<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">#听说最好是celltype</span><br>  <span class="hljs-comment">#use DoubletFinder packages</span><br>  require<span class="hljs-punctuation">(</span>DoubletFinder<span class="hljs-punctuation">)</span><span class="hljs-comment">#2.0.4</span><br>  <span class="hljs-comment">#select pK</span><br>  sweep.res.list <span class="hljs-operator">&lt;-</span> paramSweep<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">,</span> PCs<span class="hljs-operator">=</span>dims<span class="hljs-punctuation">,</span> sct<span class="hljs-operator">=</span>SCTransform<span class="hljs-punctuation">,</span> num.cores<span class="hljs-operator">=</span>ncores<span class="hljs-punctuation">)</span><br>  sweep.stats <span class="hljs-operator">&lt;-</span> summarizeSweep<span class="hljs-punctuation">(</span>sweep.res.list<span class="hljs-punctuation">,</span> GT<span class="hljs-operator">=</span><span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>  bcmvn <span class="hljs-operator">&lt;-</span> find.pK<span class="hljs-punctuation">(</span>sweep.stats<span class="hljs-punctuation">)</span><br>  pK <span class="hljs-operator">&lt;-</span> bcmvn<span class="hljs-operator">$</span>pK<span class="hljs-punctuation">[</span>which.max<span class="hljs-punctuation">(</span>bcmvn<span class="hljs-operator">$</span>BCmetric<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">%&gt;%</span> <span class="hljs-built_in">as.character</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>  message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Using pK = %s...&quot;</span><span class="hljs-punctuation">,</span> pK<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-comment">#Doublet Proportion Estimate</span><br>  <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span>Homotypic<span class="hljs-operator">==</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    nExp_poi <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>estDubRate <span class="hljs-operator">*</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>Cells<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span><span class="hljs-punctuation">&#123;</span><br>    homotypic.prop <span class="hljs-operator">&lt;-</span> modelHomotypic<span class="hljs-punctuation">(</span>obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>annotation<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>    nExp_poi <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>estDubRate <span class="hljs-operator">*</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>Cells<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    nExp_poi  <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>nExp_poi<span class="hljs-operator">*</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">-</span>homotypic.prop<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-comment"># DoubletFinder:</span><br>  obj <span class="hljs-operator">&lt;-</span> doubletFinder<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">,</span> PCs <span class="hljs-operator">=</span> dims<span class="hljs-punctuation">,</span> pN <span class="hljs-operator">=</span> <span class="hljs-number">0.25</span><span class="hljs-punctuation">,</span> pK <span class="hljs-operator">=</span> pK<span class="hljs-punctuation">,</span> nExp <span class="hljs-operator">=</span> nExp_poi<span class="hljs-punctuation">,</span> reuse.pANN <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> sct <span class="hljs-operator">=</span> SCTransform<span class="hljs-punctuation">)</span><br>  <span class="hljs-comment"># Rename results into more useful annotations</span><br>  pann <span class="hljs-operator">&lt;-</span> grep<span class="hljs-punctuation">(</span>pattern<span class="hljs-operator">=</span><span class="hljs-string">&quot;^pANN&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-operator">=</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> value<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>  message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Using pANN = %s...&quot;</span><span class="hljs-punctuation">,</span> pann<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  classify <span class="hljs-operator">&lt;-</span> grep<span class="hljs-punctuation">(</span>pattern<span class="hljs-operator">=</span><span class="hljs-string">&quot;^DF.classifications&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-operator">=</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> value<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>  obj<span class="hljs-operator">$</span>pANN <span class="hljs-operator">&lt;-</span> obj<span class="hljs-punctuation">[[</span>pann<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>  obj<span class="hljs-operator">$</span>DF.classify <span class="hljs-operator">&lt;-</span> obj<span class="hljs-punctuation">[[</span>classify<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>  obj<span class="hljs-punctuation">[[</span>pann<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">NULL</span><br>  obj<span class="hljs-punctuation">[[</span>classify<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">NULL</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment"># 判断预估的双细胞比例（10x的表格）</span><br>estDubRateFun <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span>inherits<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;Seurat&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;input file is not Seurat Object...&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><br>    rate <span class="hljs-operator">&lt;-</span> tryCatch<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>            tmp <span class="hljs-operator">&lt;-</span> 0.004 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">500</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.004</span><span class="hljs-operator">/</span><span class="hljs-number">500</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            tmp <span class="hljs-operator">&lt;-</span> 0.008 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">2000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            tmp <span class="hljs-operator">&lt;-</span> 0.016 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.007</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">3000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">4000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            tmp <span class="hljs-operator">&lt;-</span> 0.023 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">4000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">5000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.031 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">5000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">6000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.039 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">6000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">7000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.046 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">7000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">8000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.054 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">8000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">9000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.061 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">9000</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.069 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;=</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>           tmp <span class="hljs-operator">&lt;-</span> 0.076 <span class="hljs-operator">+</span> <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">-</span><span class="hljs-number">1000</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.008</span><span class="hljs-operator">/</span><span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>           <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        tmp<br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span>error <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>e<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>        message<span class="hljs-punctuation">(</span>e<span class="hljs-operator">$</span>error<span class="hljs-punctuation">)</span><br>        <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>rate<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment"># 对每个样本进行分析</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27; 开始进行双细胞检测...&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>sce_list <span class="hljs-operator">&lt;-</span> lapply<span class="hljs-punctuation">(</span>sce_list<span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    detectDoublet<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">,</span>estDubRate<span class="hljs-operator">=</span>estDubRateFun<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                                       ncores <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> SCTransform<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> Homotypic<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> annotation<span class="hljs-operator">=</span><span class="hljs-string">&quot;seurat_clusters&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27; 保存DoubletFinder结果文件...&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>saveRDS<span class="hljs-punctuation">(</span>sce_list<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span>outputDir<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;03_doubletFinderResult.rds&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 进行绘图</span><br>plist <span class="hljs-operator">&lt;-</span> lapply<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>sce_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    Seurat<span class="hljs-operator">::</span>DimPlot<span class="hljs-punctuation">(</span>sce_list<span class="hljs-punctuation">[[</span>x<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DF.classify&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> x<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br>png<span class="hljs-punctuation">(</span>file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;03_doubletFinderResult.png&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>res <span class="hljs-operator">=</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span> units <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;in&#x27;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">36</span><span class="hljs-punctuation">)</span><br>print<span class="hljs-punctuation">(</span>patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span>plist<span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">9</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br><span class="hljs-comment">#  使用R包SCP进行去批次和聚类</span><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br><span class="hljs-comment"># 去除预测的双细胞</span><br>scRNA  <span class="hljs-operator">&lt;-</span> merge<span class="hljs-punctuation">(</span>sce_list<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>sce_list<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>scRNA<span class="hljs-operator">$</span>new_group <span class="hljs-operator">&lt;-</span> paste0<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>sample<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;_&#x27;</span><span class="hljs-punctuation">,</span>scRNA<span class="hljs-operator">$</span>DF.classify<span class="hljs-punctuation">)</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; 绘制质控小提琴图... ...&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VlnPlot<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new_group&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nFeature_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0.001</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span><br>  theme<span class="hljs-punctuation">(</span>axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>p2 <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VlnPlot<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new_group&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nFeature_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span><br>  theme<span class="hljs-punctuation">(</span>axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 保存图片</span><br>ggsave<span class="hljs-punctuation">(</span><br>  filename <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;03_DoubletFinderSeuratOnjectVlnplot.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">26</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span> p2<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><br><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>scRNA<span class="hljs-operator">$</span>DF.classify<span class="hljs-operator">==</span><span class="hljs-string">&quot;Singlet&quot;</span><span class="hljs-punctuation">]</span> <br><span class="hljs-comment"># harmony重新聚类</span><br>scRNA <span class="hljs-operator">&lt;-</span> SCP<span class="hljs-operator">::</span>Integration_SCP<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> batch <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span> integration_method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Harmony&#x27;</span><span class="hljs-punctuation">,</span>cluster_resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;./05_大群数据_scp.qs&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># BBKNN聚类</span><br>scRNA <span class="hljs-operator">&lt;-</span> SCP<span class="hljs-operator">::</span>Integration_SCP<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> batch <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span> integration_method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BBKNN&#x27;</span><span class="hljs-punctuation">,</span>cluster_resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;./05_大群数据_scp.qs&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># scVI聚类</span><br>scRNA <span class="hljs-operator">&lt;-</span> SCP<span class="hljs-operator">::</span>Integration_SCP<span class="hljs-punctuation">(</span>scRNA.filter<span class="hljs-punctuation">,</span> batch <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span> integration_method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;scVI&#x27;</span><span class="hljs-punctuation">,</span>cluster_resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;./05_大群数据_scp.qs&#x27;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br><span class="hljs-comment">#  使用harmony同时去除两个批次(sample and group)</span><br><span class="hljs-comment">#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br>library<span class="hljs-punctuation">(</span>magrittr<span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>CreateSeuratObject<span class="hljs-punctuation">(</span>counts <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&quot;RNA&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">,</span> meta.data <span class="hljs-operator">=</span> scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">%&lt;&gt;%</span> Seurat<span class="hljs-operator">::</span>NormalizeData<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">%&lt;&gt;%</span> CellCycleScoring<span class="hljs-punctuation">(</span><br>  g2m.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>g2m.genes<span class="hljs-punctuation">,</span><br>  s.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>s.genes<span class="hljs-punctuation">,</span><br>  g1.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>g1.genes<br><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&lt;&gt;%</span> FindVariableFeatures<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&lt;&gt;%</span> ScaleData<span class="hljs-punctuation">(</span>vars.to.regress <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Phase&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;nCount_RNA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;percent.mt&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&lt;&gt;%</span> RunPCA<span class="hljs-punctuation">(</span>verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>system.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunHarmony<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> group.by.vars <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>plot1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>plot2 <span class="hljs-operator">&lt;-</span> ElbowPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> ndims <span class="hljs-operator">=</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">)</span><br>plotc <span class="hljs-operator">&lt;-</span> plot1 <span class="hljs-operator">+</span> plot2<br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;大群harmony&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ElbowPlot.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> plotc<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>pc.num <span class="hljs-operator">&lt;-</span> 1<span class="hljs-operator">:</span><span class="hljs-number">40</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#scRNA_harmony &lt;- RunTSNE(scRNA_harmony, reduction = &quot;harmony&quot;, dims = pc.num)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># DimPlot(scRNA_harmony, reduction = &quot;umap&quot;, label = TRUE, raster = FALSE)</span><br><span class="hljs-comment">#DimPlot(scRNA_harmony, reduction = &quot;tsne&quot;, label = TRUE)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> file.path<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;001&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;_大群Harmony.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h2 id="全部细胞命名"><a href="#全部细胞命名" class="headerlink" title="全部细胞命名"></a>全部细胞命名</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs R">message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;进行singleR注释......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>suppressMessages<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>    library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>SingleR<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br>filePrefix <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;001AllCells&quot;</span><br><span class="hljs-comment">#### singleR ####</span><br>Run_singleR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> cluster<span class="hljs-punctuation">,</span> resolution<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    require<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;SingleR&quot;</span><span class="hljs-punctuation">)</span><br>    require<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;dplyr&quot;</span><span class="hljs-punctuation">)</span><br>    stopifnot<span class="hljs-punctuation">(</span>file.exists<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/singleR.RData&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    load<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/singleR.RData&quot;</span><span class="hljs-punctuation">)</span><br>    ref_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>encode<span class="hljs-punctuation">,</span> hema<span class="hljs-punctuation">,</span> hpca<span class="hljs-punctuation">,</span> immune<span class="hljs-punctuation">,</span> monaImmune<span class="hljs-punctuation">)</span><br>    labels_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>        encode<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        hema<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        hpca<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        immune<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        monaImmune<span class="hljs-operator">$</span>label.main<br>    <span class="hljs-punctuation">)</span><br>    sce.data <span class="hljs-operator">&lt;-</span> GetAssayData<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> solt <span class="hljs-operator">=</span> <span class="hljs-string">&quot;data&quot;</span><span class="hljs-punctuation">)</span><br>    sce.singleR <span class="hljs-operator">&lt;-</span> SingleR<span class="hljs-operator">::</span>SingleR<span class="hljs-punctuation">(</span><br>        test <span class="hljs-operator">=</span> sce.data<span class="hljs-punctuation">,</span><br>        ref <span class="hljs-operator">=</span> ref_list<span class="hljs-punctuation">,</span><br>        labels <span class="hljs-operator">=</span> labels_list<span class="hljs-punctuation">,</span><br>        clusters <span class="hljs-operator">=</span> cluster<span class="hljs-punctuation">,</span><br>        BPPARAM <span class="hljs-operator">=</span> BiocParallel<span class="hljs-operator">::</span>MulticoreParam<span class="hljs-punctuation">(</span><span class="hljs-number">6</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 提取 celltype 数据</span><br>    celltype <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span><br>        ClusterID <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>sce.singleR<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        singleR <span class="hljs-operator">=</span> sce.singleR<span class="hljs-operator">$</span>labels<span class="hljs-punctuation">,</span><br>        stringsAsFactors <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 将注释信息添加到seurat对象中</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>resolution<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;missing resolution files.&quot;</span><span class="hljs-punctuation">)</span><br>    tmp <span class="hljs-operator">&lt;-</span> data<span class="hljs-operator">@</span>meta.data <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>select<span class="hljs-punctuation">(</span>resolution<span class="hljs-punctuation">)</span><br>    colnames<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;ClusterID&quot;</span><br>    tmp1 <span class="hljs-operator">&lt;-</span> left_join<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">,</span> celltype<span class="hljs-punctuation">,</span> by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ClusterID&quot;</span><span class="hljs-punctuation">)</span><br>    rownames<span class="hljs-punctuation">(</span>tmp1<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">)</span><br>    sce_new <span class="hljs-operator">&lt;-</span> AddMetaData<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> tmp1<span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>sce_new<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>scRNA <span class="hljs-operator">&lt;-</span> Run_singleR<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">=</span> scRNA<span class="hljs-operator">$</span>RNA_snn_res.1<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RNA_snn_res.1&quot;</span><span class="hljs-punctuation">)</span><br><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;开始进行绘图......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">### DotPlot ###</span><br>marks <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    mark_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>    Immune <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;PTPRC&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    NK <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;KLRC1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FCGR3A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;NCAM1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KLRD1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;GNLY&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;T cells&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD3D&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD3G&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD8A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD8B&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD4&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Fibroblasts <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;COL1A1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;DCN&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;LUM&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PDGFRA&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Myeloids <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;LYZ&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD68&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TYROBP&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Epithelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD24&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KRT19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;EPCAM&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KRT18&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Bcells <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD79A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MS4A1&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Endothelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CLDN5&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FLT1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;RAMP2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CDH5&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;Smooth muscle&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;GJA4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PLAC9&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CRYAB&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ACTA2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PLN&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ADIRF&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MYH11&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CNN1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MYL9&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Neutrophil <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;FCGR3B&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;S100P&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CMTM2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    oocytes <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;TUBB8&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ZP3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FIGLA&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Granulosal <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;GSTA1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;AMH&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HSD17B1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;DSP&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    DC <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;LILRA4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CXCR3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;IRF7&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Mast <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CPA3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TPSAB1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TPSB2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment"># 气泡图</span><br>plotBigDotPlot <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span> group.by<span class="hljs-punctuation">,</span> marker<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    p1 <span class="hljs-operator">&lt;-</span> DotPlot<span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span> assay <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RNA&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> marker<span class="hljs-punctuation">,</span> scale <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> group.by<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        scale_color_gradient2<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> mid <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        <span class="hljs-comment"># 添加四条黑色边界线</span><br>        annotate<span class="hljs-punctuation">(</span>geom <span class="hljs-operator">=</span> <span class="hljs-string">&quot;segment&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        annotate<span class="hljs-punctuation">(</span>geom <span class="hljs-operator">=</span> <span class="hljs-string">&quot;segment&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        theme_minimal<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        theme<span class="hljs-punctuation">(</span><br>            axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            strip.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            panel.border <span class="hljs-operator">=</span> element_rect<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> <span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> linewidth <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;solid&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bottom&quot;</span><span class="hljs-punctuation">,</span><br>            panel.spacing.x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            panel.spacing.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            panel.grid <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey&quot;</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dashed&quot;</span><span class="hljs-punctuation">,</span> linewidth <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Gene Marker&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>raw_plot <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span>resolution<span class="hljs-operator">=</span><span class="hljs-string">&quot;RNA_snn_res.0.8&quot;</span><span class="hljs-punctuation">,</span>filePrefix<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> resolution<span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;nCells: &#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    p2 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;singleR&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    p3 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    p4 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>filePrefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_singleR.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p1<span class="hljs-operator">+</span>p2<span class="hljs-operator">+</span>p3<span class="hljs-operator">+</span>p4<span class="hljs-operator">+</span>patchwork<span class="hljs-operator">::</span>plot_layout<span class="hljs-punctuation">(</span>widths <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>patchwork<span class="hljs-operator">::</span>plot_annotation<span class="hljs-punctuation">(</span>tag_levels <span class="hljs-operator">=</span> <span class="hljs-string">&quot;A&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 气泡图</span><br>    p5 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;singleR&quot;</span><span class="hljs-punctuation">,</span> marker <span class="hljs-operator">=</span> marks<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    p6 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> resolution<span class="hljs-punctuation">,</span> marker <span class="hljs-operator">=</span> marks<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    ggsave<span class="hljs-punctuation">(</span><br>    filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>filePrefix<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;_singleR注释结果.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><br>    plot <span class="hljs-operator">=</span> cowplot<span class="hljs-operator">::</span>plot_grid<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p5<span class="hljs-punctuation">,</span>p6<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> align <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hv&quot;</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> rel_widths <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br>raw_plot<span class="hljs-punctuation">(</span>srt <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">,</span>filePrefix <span class="hljs-operator">=</span> filePrefix<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h2 id="对celltype进一步分析"><a href="#对celltype进一步分析" class="headerlink" title="对celltype进一步分析"></a>对celltype进一步分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment">#### 对大群中注释的亚群数据进行进一步分析 ####</span><br>suppressPackageStartupMessages<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>    library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>harmony<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>ggpubr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>cowplot<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>SingleR<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 读入数据</span><br><span class="hljs-comment"># Test_data &lt;- &quot;/root/wangje/Project/OveryArtical/001_大群Harmony.qs&quot;</span><br>celltype_column <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;celltype&quot;</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;读入数据.....&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># scRNA &lt;- qs::qread(Test_data)</span><br><span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span><span class="hljs-punctuation">(</span>celltype_column <span class="hljs-operator">%in%</span> colnames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    print<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;细胞注释的列不在读入的Seurat对象中&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br>message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;存在细胞类型%s&quot;</span><span class="hljs-punctuation">,</span>paste0<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype_column<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>collapse <span class="hljs-operator">=</span> <span class="hljs-string">&quot;\t&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>celltypes <span class="hljs-operator">&lt;-</span> unique<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype_column<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>scRNA<span class="hljs-operator">$</span>celltype <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype_column<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br><br><span class="hljs-comment">#### Cluster ####</span><br>analyze_subcluster <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> celltypes<span class="hljs-punctuation">,</span> vars.to.regress<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Phase&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;nCount_RNA&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>output_dir <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>celltypes<span class="hljs-punctuation">)</span> <span class="hljs-operator">&gt;</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>        stop<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;celltype的长度为1&#x27;</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><br>    message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span> Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;分亚群进行分析.....&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;分亚群进行分析.....%s&quot;</span><span class="hljs-punctuation">,</span> celltypes<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <br>    scRNA_sub <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> subset <span class="hljs-operator">=</span> celltype <span class="hljs-operator">==</span> celltypes<span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># message(sprintf(&quot;%s的数据维度为%s,%s&quot;, celltypes, paste0(c(&#x27;基因&#x27;, &#x27;细胞&#x27;),dim(scRNA_sub), collapse = &#x27;,&#x27;)))</span><br>    print<span class="hljs-punctuation">(</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>scRNA_sub<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span> Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;进行harmomny数据分析&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <br>    scRNA_sub <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>CreateSeuratObject<span class="hljs-punctuation">(</span>counts <span class="hljs-operator">=</span> scRNA_sub<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">,</span> meta.data <span class="hljs-operator">=</span> scRNA_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><br>    scRNA_harmony <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>scRNA_sub<span class="hljs-punctuation">)</span><br>    scRNA_harmony <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> vars.to.regress <span class="hljs-operator">=</span> vars.to.regress<span class="hljs-punctuation">)</span><br>    scRNA_harmony <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>    <br>    system.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>        scRNA_harmony <span class="hljs-operator">&lt;-</span> RunHarmony<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> group.by.vars <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>    plot1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    plot2 <span class="hljs-operator">&lt;-</span> ElbowPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> ndims <span class="hljs-operator">=</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">)</span><br>    plotc <span class="hljs-operator">&lt;-</span> plot1 <span class="hljs-operator">+</span> plot2<br>    <br>    ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span>output_dir<span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span>celltypes<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ElbowPlot.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> plotc<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>    <br>    pc.num <span class="hljs-operator">&lt;-</span> 1<span class="hljs-operator">:</span><span class="hljs-number">30</span><br>    scRNA_harmony <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>    <span class="hljs-comment">#scRNA_harmony &lt;- RunTSNE(scRNA_harmony, reduction = &quot;harmony&quot;, dims = pc.num)</span><br>    scRNA_harmony <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>    scRNA_harmony <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br>    <br>    DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-comment">#DimPlot(scRNA_harmony, reduction = &quot;tsne&quot;, label = TRUE)</span><br>    qsave<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> file.path<span class="hljs-punctuation">(</span>output_dir<span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span>celltypes<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;_Harmony.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span>   <br><br><span class="hljs-comment">#### singleR ####</span><br>Run_singleR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> cluster<span class="hljs-punctuation">,</span> resolution<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    require<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;SingleR&quot;</span><span class="hljs-punctuation">)</span><br>    require<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;dplyr&quot;</span><span class="hljs-punctuation">)</span><br>    stopifnot<span class="hljs-punctuation">(</span>file.exists<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/singleR.RData&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    load<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/singleR.RData&quot;</span><span class="hljs-punctuation">)</span><br>    ref_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>encode<span class="hljs-punctuation">,</span> hema<span class="hljs-punctuation">,</span> hpca<span class="hljs-punctuation">,</span> immune<span class="hljs-punctuation">,</span> monaImmune<span class="hljs-punctuation">)</span><br>    labels_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>        encode<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        hema<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        hpca<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        immune<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        monaImmune<span class="hljs-operator">$</span>label.main<br>    <span class="hljs-punctuation">)</span><br>    sce.data <span class="hljs-operator">&lt;-</span> GetAssayData<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> solt <span class="hljs-operator">=</span> <span class="hljs-string">&quot;data&quot;</span><span class="hljs-punctuation">)</span><br>    sce.singleR <span class="hljs-operator">&lt;-</span> SingleR<span class="hljs-operator">::</span>SingleR<span class="hljs-punctuation">(</span><br>        test <span class="hljs-operator">=</span> sce.data<span class="hljs-punctuation">,</span><br>        ref <span class="hljs-operator">=</span> ref_list<span class="hljs-punctuation">,</span><br>        labels <span class="hljs-operator">=</span> labels_list<span class="hljs-punctuation">,</span><br>        clusters <span class="hljs-operator">=</span> cluster<span class="hljs-punctuation">,</span><br>        BPPARAM <span class="hljs-operator">=</span> BiocParallel<span class="hljs-operator">::</span>MulticoreParam<span class="hljs-punctuation">(</span><span class="hljs-number">6</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 提取 celltype 数据</span><br>    celltype <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span><br>        ClusterID <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>sce.singleR<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        singleR <span class="hljs-operator">=</span> sce.singleR<span class="hljs-operator">$</span>labels<span class="hljs-punctuation">,</span><br>        stringsAsFactors <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 将注释信息添加到seurat对象中</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>resolution<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;missing resolution files.&quot;</span><span class="hljs-punctuation">)</span><br>    tmp <span class="hljs-operator">&lt;-</span> data<span class="hljs-operator">@</span>meta.data <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>select<span class="hljs-punctuation">(</span>resolution<span class="hljs-punctuation">)</span><br>    colnames<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;ClusterID&quot;</span><br>    tmp1 <span class="hljs-operator">&lt;-</span> left_join<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">,</span> celltype<span class="hljs-punctuation">,</span> by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ClusterID&quot;</span><span class="hljs-punctuation">)</span><br>    rownames<span class="hljs-punctuation">(</span>tmp1<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">)</span><br>    sce_new <span class="hljs-operator">&lt;-</span> AddMetaData<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> tmp1<span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>sce_new<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">#### plot ####</span><br>marks <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    mark_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>    Immune <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;PTPRC&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    NK <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;KLRC1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FCGR3A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;NCAM1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KLRD1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;GNLY&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;T cells&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD3D&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD3G&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD8A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD8B&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD4&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Fibroblasts <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;COL1A1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;DCN&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;LUM&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PDGFRA&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Myeloids <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;LYZ&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD68&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TYROBP&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Epithelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD24&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KRT19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;EPCAM&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KRT18&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Bcells <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD79A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MS4A1&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Endothelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CLDN5&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FLT1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;RAMP2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CDH5&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;Smooth muscle&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;GJA4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PLAC9&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CRYAB&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ACTA2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PLN&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ADIRF&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MYH11&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CNN1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MYL9&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Neutrophil <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;FCGR3B&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;S100P&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CMTM2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    oocytes <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;TUBB8&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ZP3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FIGLA&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Granulosal <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;GSTA1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;AMH&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;HSD17B1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;DSP&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    DC <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;LILRA4&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CXCR3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;IRF7&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    Mast <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CPA3&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TPSAB1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TPSB2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment"># 气泡图</span><br>plotBigDotPlot <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span> group.by<span class="hljs-punctuation">,</span> marker<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    p1 <span class="hljs-operator">&lt;-</span> DotPlot<span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span> assay <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RNA&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> marker<span class="hljs-punctuation">,</span> scale <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> group.by<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        scale_color_gradient2<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> mid <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        <span class="hljs-comment"># 添加四条黑色边界线</span><br>        annotate<span class="hljs-punctuation">(</span>geom <span class="hljs-operator">=</span> <span class="hljs-string">&quot;segment&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        annotate<span class="hljs-punctuation">(</span>geom <span class="hljs-operator">=</span> <span class="hljs-string">&quot;segment&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        theme_minimal<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        theme<span class="hljs-punctuation">(</span><br>            axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            strip.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            panel.border <span class="hljs-operator">=</span> element_rect<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> <span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> linewidth <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;solid&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bottom&quot;</span><span class="hljs-punctuation">,</span><br>            panel.spacing.x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            panel.spacing.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            panel.grid <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey&quot;</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dashed&quot;</span><span class="hljs-punctuation">,</span> linewidth <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Gene Marker&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>raw_plot <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span>resolution<span class="hljs-operator">=</span><span class="hljs-string">&quot;RNA_snn_res.0.8&quot;</span><span class="hljs-punctuation">,</span>filePrefix<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> resolution<span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;nCells: &#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    p2 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;singleR&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    p3 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    p4 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>    ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>filePrefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_singleR.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p1<span class="hljs-operator">+</span>p2<span class="hljs-operator">+</span>p3<span class="hljs-operator">+</span>p4<span class="hljs-operator">+</span>patchwork<span class="hljs-operator">::</span>plot_layout<span class="hljs-punctuation">(</span>widths <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>patchwork<span class="hljs-operator">::</span>plot_annotation<span class="hljs-punctuation">(</span>tag_levels <span class="hljs-operator">=</span> <span class="hljs-string">&quot;A&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 气泡图</span><br>    p5 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;singleR&quot;</span><span class="hljs-punctuation">,</span> marker <span class="hljs-operator">=</span> marks<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    p6 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> resolution<span class="hljs-punctuation">,</span> marker <span class="hljs-operator">=</span> marks<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    ggsave<span class="hljs-punctuation">(</span><br>    filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>filePrefix<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;_singleR注释结果.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><br>    plot <span class="hljs-operator">=</span> cowplot<span class="hljs-operator">::</span>plot_grid<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p5<span class="hljs-punctuation">,</span>p6<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> align <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hv&quot;</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> rel_widths <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;进行数据分群和SingleR粗注释......&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>result <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><br><span class="hljs-keyword">for</span><span class="hljs-punctuation">(</span>cell <span class="hljs-keyword">in</span> unique<span class="hljs-punctuation">(</span>celltypes<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    print<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span>cell<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27; 使用harmony进行分群.....&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    result <span class="hljs-operator">&lt;-</span> analyze_subcluster<span class="hljs-punctuation">(</span><br>        scRNA<span class="hljs-punctuation">,</span>celltypes <span class="hljs-operator">=</span> cell<br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 分群结束，使用是singleR进行粗注释</span><br>    result <span class="hljs-operator">=</span> Run_singleR<span class="hljs-punctuation">(</span>data <span class="hljs-operator">=</span> result<span class="hljs-punctuation">,</span> cluster <span class="hljs-operator">=</span> result<span class="hljs-operator">$</span>RNA_snn_res.0.8<span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RNA_snn_res.0.8&quot;</span><span class="hljs-punctuation">)</span><br>    raw_plot<span class="hljs-punctuation">(</span>srt <span class="hljs-operator">=</span> result<span class="hljs-punctuation">,</span>filePrefix <span class="hljs-operator">=</span> cell<span class="hljs-punctuation">)</span><br>    qsave<span class="hljs-punctuation">(</span>result<span class="hljs-punctuation">,</span> file.path<span class="hljs-punctuation">(</span>output_dir<span class="hljs-punctuation">,</span> paste0<span class="hljs-punctuation">(</span>cell<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;_Harmony.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="区分出celltype中混杂的其他细胞"><a href="#区分出celltype中混杂的其他细胞" class="headerlink" title="区分出celltype中混杂的其他细胞"></a>区分出celltype中混杂的其他细胞</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R"><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>R学习记录</title>
    <link href="/2024/06/04/R%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    <url>/2024/06/04/R%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h2 id="stat-contour"><a href="#stat-contour" class="headerlink" title="stat_contour"></a>stat_contour</h2><blockquote><p>参考程序：<a href="https://github.com/rcannood/SCORPIUS/blob/master/R/plotting.R#L66">https://github.com/rcannood/SCORPIUS/blob/master/R/plotting.R#L66</a></p></blockquote><p><code>stat_contour</code> 是 R 语言中 ggplot2 包的一部分，用于绘制等高线图（contour plots）。等高线图通常用于显示三维数据在二维平面上的投影，常用于地理信息系统、气象数据和其他科学数据的可视化。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">ggplot<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">,</span> z<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  stat_contour<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#data：包含数据的 data frame。</span><br><span class="hljs-comment">#aes(x, y, z)：映射数据中的变量到 x 轴、y 轴和 z 轴。</span><br><span class="hljs-comment">#stat_contour()：添加等高线图层</span><br></code></pre></td></tr></table></figure><p>【举例】</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 创建示例数据</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>x <span class="hljs-operator">&lt;-</span> seq<span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> length.out <span class="hljs-operator">=</span> <span class="hljs-number">100</span><span class="hljs-punctuation">)</span><br>y <span class="hljs-operator">&lt;-</span> seq<span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> length.out <span class="hljs-operator">=</span> <span class="hljs-number">100</span><span class="hljs-punctuation">)</span><br>z <span class="hljs-operator">&lt;-</span> outer<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">)</span> <span class="hljs-built_in">sin</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">sqrt</span><span class="hljs-punctuation">(</span>x<span class="hljs-operator">^</span><span class="hljs-number">2</span> <span class="hljs-operator">+</span> y<span class="hljs-operator">^</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>data <span class="hljs-operator">&lt;-</span> expand.grid<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><br>data<span class="hljs-operator">$</span>z <span class="hljs-operator">&lt;-</span> as.vector<span class="hljs-punctuation">(</span>z<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制等高线图</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">,</span> z <span class="hljs-operator">=</span> z<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  stat_contour<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  scale_fill_viridis_c<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 填充等高线</span><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">,</span> z <span class="hljs-operator">=</span> z<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_tile<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> z<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  stat_contour<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  scale_fill_viridis_c<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme_minimal<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>p1<span class="hljs-operator">|</span>p2<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_6d554dddd94eb37254bb915e5e5572a5.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 加载必要的包</span><br>library<span class="hljs-punctuation">(</span>MASS<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>reshape2<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 生成示例数据</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>x <span class="hljs-operator">&lt;-</span> rnorm<span class="hljs-punctuation">(</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><br>y <span class="hljs-operator">&lt;-</span> rnorm<span class="hljs-punctuation">(</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 进行二维核密度估计</span><br>density_est <span class="hljs-operator">&lt;-</span> kde2d<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 将结果转换为数据框</span><br>density_df <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span><br>  x <span class="hljs-operator">=</span> <span class="hljs-built_in">rep</span><span class="hljs-punctuation">(</span>density_est<span class="hljs-operator">$</span>x<span class="hljs-punctuation">,</span> each <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>density_est<span class="hljs-operator">$</span>y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  y <span class="hljs-operator">=</span> <span class="hljs-built_in">rep</span><span class="hljs-punctuation">(</span>density_est<span class="hljs-operator">$</span>y<span class="hljs-punctuation">,</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>density_est<span class="hljs-operator">$</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  z <span class="hljs-operator">=</span> as.vector<span class="hljs-punctuation">(</span>density_est<span class="hljs-operator">$</span>z<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>density_df<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#           x          y            z</span><br><span class="hljs-comment"># 1 -2.309169 -2.0532472 0.0002621993</span><br><span class="hljs-comment"># 2 -2.309169 -1.8326519 0.0009069650</span><br><span class="hljs-comment"># 3 -2.309169 -1.6120566 0.0025026431</span><br><span class="hljs-comment"># 4 -2.309169 -1.3914613 0.0054448530</span><br><span class="hljs-comment"># 5 -2.309169 -1.1708660 0.0093193740</span><br><span class="hljs-comment"># 6 -2.309169 -0.9502707 0.0126346662</span><br><br><span class="hljs-comment"># 使用 ggplot2 绘制密度热图</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>density_df<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> z<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_tile<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&quot;2D Kernel Density Heatmap with ggplot2&quot;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">## 直接使用ggplot2绘制等高线图</span><br><span class="hljs-comment"># 加载必要的包</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 生成示例数据</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>x <span class="hljs-operator">&lt;-</span> rnorm<span class="hljs-punctuation">(</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><br>y <span class="hljs-operator">&lt;-</span> rnorm<span class="hljs-punctuation">(</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><br>data <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 使用 ggplot2 直接绘制密度等高线图</span><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span>alpha <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_density_2d<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&quot;2D Kernel Density Estimation with ggplot2&quot;</span><span class="hljs-punctuation">)</span><br>p1<span class="hljs-operator">|</span>p2<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_eca0067fc0f4c61b4bf7048282795141.png"></p><h2 id="coord-equal"><a href="#coord-equal" class="headerlink" title="coord_equal"></a>coord_equal</h2><p><code>coord_equal()</code> 是 R 编程语言中 <code>ggplot2</code> 包的一部分，用于设置图形的坐标系，使得 x 轴和 y 轴的单位长度相等。这在需要保持数据的实际比例关系时非常有用，例如在绘制几何图形、地图或其他需要保持真实比例的图表时。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">coord_fixed<span class="hljs-punctuation">(</span>ratio <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> xlim <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> ylim <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> expand <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> clip <span class="hljs-operator">=</span> <span class="hljs-string">&quot;on&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>【参数讲解】</p><ul><li>ratio y&#x2F;x的比值，默认值为1，既y和x的比值为1</li><li>xlim,ylim x轴或y轴的限制范围</li><li>expand 默认为TRUE，调整数据和坐标轴之间的范围，防止和坐标轴重合</li><li>clip 是否应将绘图限制在绘图面板的范围内？默认设置为 <code>&quot;on&quot;</code>，表示是，即绘图会被限制在面板范围内；而设置为 <code>&quot;off&quot;</code> 则表示否，即不进行限制。在大多数情况下，不应该更改默认的 <code>&quot;on&quot;</code> 设置，因为将 <code>clip = &quot;off&quot;</code> 可能会导致意外的结果。设置 <code>clip = &quot;off&quot;</code> 允许在绘图的任何地方绘制数据点，包括绘图的边缘。如果通过 <code>xlim</code> 和 <code>ylim</code> 设置了坐标轴的范围，而某些数据点超出了这些范围，那么这些数据点可能会出现在坐标轴、图例、图表标题或图表边缘等位置。</li></ul><p>【举例】</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 示例数据</span><br>df <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span><br>  x <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  y <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span> <span class="hljs-number">25</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_equal<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br>p3 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_equal<span class="hljs-punctuation">(</span>ratio <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><br><br>p4 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_equal<span class="hljs-punctuation">(</span>xlim <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ylim <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">(</span>p1<span class="hljs-operator">|</span>p2<span class="hljs-punctuation">)</span><span class="hljs-operator">/</span><span class="hljs-punctuation">(</span>p3<span class="hljs-operator">|</span>p4<span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>plot_annotation<span class="hljs-punctuation">(</span>tag_levels <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;A&#x27;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_e7f94c2802f1d01e1902a22c8bc73a35.png"></p><h2 id="coord-cartesian"><a href="#coord-cartesian" class="headerlink" title="coord_cartesian"></a>coord_cartesian</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">coord_cartesian<span class="hljs-punctuation">(</span>xlim <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>ylim <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>expand <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>default <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span>clip <span class="hljs-operator">=</span> <span class="hljs-string">&quot;on&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>【举例】</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R">p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>mtcars<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> wt<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> mpg<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_cartesian<span class="hljs-punctuation">(</span>xlim <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ylim <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>mtcars<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> wt<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> mpg<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_cartesian<span class="hljs-punctuation">(</span>xlim <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ylim <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1<span class="hljs-operator">|</span>p2<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_94c87664674af86cad2a158ca255bfd9.png"></p><h2 id="coord-fixed"><a href="#coord-fixed" class="headerlink" title="coord_fixed"></a>coord_fixed</h2><p>类似于 <code>coord_equal()</code>，但允许指定一个固定的比例。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">coord_fixed<span class="hljs-punctuation">(</span>ratio <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> xlim <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> ylim <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> expand <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> clip <span class="hljs-operator">=</span> <span class="hljs-string">&quot;on&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>【举例】</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">p <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>mtcars<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> wt<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> mpg<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_fixed<span class="hljs-punctuation">(</span>ratio <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><br><br>print<span class="hljs-punctuation">(</span>p<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_043022c5535bac85a5e0ec96a80db14f.png"></p><h2 id="coord-polar"><a href="#coord-polar" class="headerlink" title="coord_polar"></a>coord_polar</h2><p>将图形转换为极坐标系统，适用于绘制饼图或雷达图等。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">p</span> &lt;- <span class="hljs-built_in">ggplot</span>(mtcars, <span class="hljs-built_in">aes</span>(x = <span class="hljs-built_in">factor</span>(<span class="hljs-number">1</span>), fill = <span class="hljs-built_in">factor</span>(cyl))) +<br>  <span class="hljs-built_in">geom_bar</span>(<span class="hljs-attribute">width</span> = <span class="hljs-number">1</span>) +<br>  <span class="hljs-built_in">coord_polar</span>(theta = <span class="hljs-string">&quot;y&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(p)</span></span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_8dca190f033d5de90a507103d7dbc7ac.png"></p><h2 id="coord-quickmap"><a href="#coord-quickmap" class="headerlink" title="coord_quickmap"></a>coord_quickmap</h2><p>用于快速绘制地图，保持合理的比例关系。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>maps<span class="hljs-punctuation">)</span><br>us <span class="hljs-operator">&lt;-</span> map_data<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;state&quot;</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>us<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> long<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> lat<span class="hljs-punctuation">,</span> group <span class="hljs-operator">=</span> group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_polygon<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  coord_quickmap<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>us<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> long<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> lat<span class="hljs-punctuation">,</span> group <span class="hljs-operator">=</span> group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_polygon<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><br>p1<span class="hljs-operator">|</span>p2<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_a1b66d0ed5d018d11e2a96e359d064b8.png"></p><h1 id="R中GUI的编写"><a href="#R中GUI的编写" class="headerlink" title="R中GUI的编写"></a>R中GUI的编写</h1><h2 id="shiny"><a href="#shiny" class="headerlink" title="shiny"></a>shiny</h2><h2 id="gWidgets"><a href="#gWidgets" class="headerlink" title="gWidgets"></a>gWidgets</h2>]]></content>
    
    
    
    <tags>
      
      <tag>R</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>单细胞分析流程</title>
    <link href="/2024/06/02/%E5%8D%95%E7%BB%86%E8%83%9E%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B/"/>
    <url>/2024/06/02/%E5%8D%95%E7%BB%86%E8%83%9E%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="cellranger输出单细胞分析文件"><a href="#cellranger输出单细胞分析文件" class="headerlink" title="cellranger输出单细胞分析文件"></a>cellranger输出单细胞分析文件</h1><blockquote></blockquote><h1 id="CellBender清除测序噪声"><a href="#CellBender清除测序噪声" class="headerlink" title="CellBender清除测序噪声"></a>CellBender清除测序噪声</h1><blockquote><p>github地址：<a href="https://github.com/broadinstitute/CellBender">https://github.com/broadinstitute/CellBender</a></p><p>文献地址：<a href="https://doi.org/10.1038/s41592-023-01943-7">https://doi.org/10.1038/s41592-023-01943-7</a></p></blockquote><h2 id="What-is-CellBender"><a href="#What-is-CellBender" class="headerlink" title="What is CellBender?"></a>What is CellBender?</h2><p>CellBender is a software package for eliminating technical artifacts from high-throughput single-cell omics data, including scRNA-seq, snRNA-seq, and CITE-seq.</p><p>The main purpose of CellBender is to take raw gene-by-cell count matrices and molecule-level information produced by 3rd party pipelines (e.g. CellRanger, Alevin, DropSeq, StarSolo, etc.), to model and remove systematic biases and background noise, and to produce improved estimates of gene expression.</p><p>CellBender relies on an external tool for primary processing of the raw data obtained from the sequencer**(e.g. BCL or FASTQ files)**. These basic processing steps lie outside of the scope of CellBender and include (pseudo-)alignment and annotation of reads, barcode error correction, and generation of raw gene-by-cell count matrices. Upcoming modules of CellBender will further utilize molecule-level information (e.g. observed reads per molecule, transcript equivalence classes, etc.).</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="直接在base环境中安装"><a href="#直接在base环境中安装" class="headerlink" title="直接在base环境中安装"></a>直接在base环境中安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip install cellbender<br></code></pre></td></tr></table></figure><h3 id="在conda虚拟环境中安装"><a href="#在conda虚拟环境中安装" class="headerlink" title="在conda虚拟环境中安装"></a>在conda虚拟环境中安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">conda create -n cellbender python=3.7<br>conda activate cellbender<br>pip install cellbender<br></code></pre></td></tr></table></figure><h3 id="通过源码安装"><a href="#通过源码安装" class="headerlink" title="通过源码安装"></a>通过源码安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">conda create -n cellbender python=<span class="hljs-number">3.7</span><br>conda activate cellbender<br>conda install -c anaconda pytables <span class="hljs-comment"># install pytables</span><br>pip install torch <span class="hljs-comment"># install pytorch</span><br>git clone https://github.com/broadinstitute/CellBender.git<br>pip install -e CellBender<br></code></pre></td></tr></table></figure><p>查看是否安装成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">cellbender --<span class="hljs-built_in">help</span><br><span class="hljs-comment"># CellBender is a software package for eliminating technical artifacts from high-throughput single-cell RNA sequencing (scRNA-seq) data.</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># optional arguments:</span><br><span class="hljs-comment">#   -h, --help           show this help message and exit</span><br><span class="hljs-comment">#   -v, --version        show program&#x27;s version number and exit</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># sub-commands:</span><br><span class="hljs-comment">#   valid cellbender commands</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment">#   &#123;remove-background&#125;</span><br><span class="hljs-comment">#     remove-background  Remove background ambient RNA and barcode-swapped reads from a count matrix, producing a new count matrix and determining which</span><br><span class="hljs-comment">#                        barcodes contain real cells.</span><br></code></pre></td></tr></table></figure><p>remove-background 移除构成“背景平台”的背景RNA：与空液滴中含有的相同背景RNA。如果你的数据集中在空液滴中的UMI计数非常少，那么背景RNA就不多，remove-background可能不会移除很多。请参见附录A。</p><p>如果你有一个数据集，可以通过目测识别出“空液滴平台”，并且这些空液滴有50、100或几百个计数，那么你可以期待remove-background显著清理你的数据集。请参见附录B。</p><p>如果你的数据集中有大量背景RNA，以至于你无法通过目测识别出“空液滴平台”，那么remove-background也可能会遇到困难。运行该算法可能值得一试，但你应当强烈考虑重新进行实验，因为这表明存在真正的质量控制失败。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_d11daa914462a85a2cb4ca10d3704a01.png"></p><h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><code class="hljs bash">```<br><br><span class="hljs-comment"># 双细胞预测</span><br><br><span class="hljs-comment">##  Scrublet</span><br><br><br><br><br><br><span class="hljs-comment">## DoubletFinder</span><br><br>&gt; 网址：https://github.com/chris-mcginnis-ucsf/DoubletFinder<br>&gt;<br>&gt; 文章地址：https://www.sciencedirect.com/science/article/pii/S2405471219300730<br><br>预测原理<br><br>    DoubletFinder是一种用于分析单细胞RNA测序（scRNA-<span class="hljs-built_in">seq</span>）数据的工具，旨在识别和过滤双细胞（doublets）。双细胞是指在单细胞测序过程中，两个细胞被错误地捕获在同一个反应孔中的情况。这种现象会导致假阳性结果，从而影响下游分析的准确性。DoubletFinder通过以下几个主要步骤来预测双细胞：<br><br>![](https://markdown.liuchengtu.com/work/uploads/upload_1a049a7ab0429b9aa67c1b5ca4389ebc.png)<br><br>1. **预处理数据**：<br>   - 首先，对scRNA-<span class="hljs-built_in">seq</span>数据进行标准化和归一化处理，以确保数据的一致性和可比性。<br>   - 进行降维处理（如PCA），以减少数据的复杂性并提取主要特征。<br><br>2. **合成双细胞**：<br>   - 从原始数据中随机选取一对细胞，并将它们的表达谱混合，生成合成的双细胞数据。这些合成双细胞用于模拟实际数据中的双细胞情况。<br>   - 生成的合成双细胞数目通常与预期的双细胞比例相匹配。<br><br>3. **计算相似性得分**：<br>   - 使用降维后的数据（如PCA坐标），计算每个细胞与所有其他细胞之间的相似性得分。常用的方法包括最近邻（k-nearest neighbors, KNN）算法。<br>   - 对每个细胞及其邻居进行聚类分析，以确定哪些细胞可能是双细胞。<br><br>4. **双细胞打分**：<br>   - 将每个细胞的相似性得分与合成双细胞的相似性得分进行比较。<br>   - 根据比较结果，为每个细胞分配一个双细胞概率得分。<br><br>5. **识别和过滤双细胞**：<br>   - 根据双细胞概率得分，设定一个阈值，识别出可能的双细胞。<br>   - 这些被识别出的双细胞可以在后续分析中被过滤掉，以提高数据的准确性。<br><br>DoubletFinder的核心思想是通过模拟双细胞的生成过程，并利用机器学习和统计方法来识别具有类似特征的细胞。这样可以有效地减少双细胞对单细胞RNA测序数据分析的干扰，提高结果的可靠性。<br><br>**DoubletFinder的缺陷**<br><br>双细胞由两种非常相似的细胞类型组成，或者表达谱非常接近的细胞。这种情况下，DoubletFinder可能难以区分双细胞和单细胞。<br><br>**文章中对使用DoubletFinderd的描述**<br><br><br><br><span class="hljs-comment">### 运行代码</span><br><br>```R<br><br>message(sprintf(<span class="hljs-string">&quot;%s%s%s&quot;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20),<span class="hljs-string">&#x27;调用R包&#x27;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20)))<br><span class="hljs-comment"># 调用需要的R包</span><br><span class="hljs-comment"># ------------</span><br>load_packages_silently &lt;- <span class="hljs-keyword">function</span>(package_names) &#123;<br>  not_installed &lt;- character(0)<br>  <br>  <span class="hljs-keyword">for</span> (pkg <span class="hljs-keyword">in</span> package_names) &#123;<br>    <span class="hljs-keyword">if</span> (!requireNamespace(pkg, quietly = TRUE)) &#123;<br>      message(paste0(<span class="hljs-string">&quot;Package &#x27;&quot;</span>, pkg, <span class="hljs-string">&quot;&#x27; is not installed or loaded properly. Skipping...&quot;</span>))<br>      not_installed &lt;- c(not_installed, pkg)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      suppressPackageStartupMessages(&#123;library(pkg, character.only = TRUE)&#125;)<br>      message(paste0(<span class="hljs-string">&quot;Package &#x27;&quot;</span>, pkg, <span class="hljs-string">&quot;&#x27; successfully loaded.&quot;</span>))<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment"># 返回未成功加载的包列表</span><br>  <span class="hljs-built_in">return</span>(not_installed)<br>&#125;<br><br>package_list &lt;- c(<span class="hljs-string">&quot;dplyr&quot;</span>,<span class="hljs-string">&quot;Seurat&quot;</span>,<span class="hljs-string">&quot;SeuratObject&quot;</span>,<span class="hljs-string">&quot;ggplot2&quot;</span>,<span class="hljs-string">&quot;getopt&quot;</span>,<span class="hljs-string">&quot;patchwork&quot;</span>,<span class="hljs-string">&quot;DoubletFinder&quot;</span>,<span class="hljs-string">&quot;qs&quot;</span>,<span class="hljs-string">&quot;harmony&quot;</span>,<span class="hljs-string">&quot;stringr&quot;</span>)<br>load_packages_silently(package_list)<br>message(sprintf(<span class="hljs-string">&quot;%s%s%s&quot;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20),<span class="hljs-string">&#x27;R包调用结束&#x27;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20)))<br><br><span class="hljs-comment"># 设置命令行传参</span><br><span class="hljs-comment"># -------------</span><br>spec=matrix(c( <br>    <span class="hljs-string">&#x27;help&#x27;</span>, <span class="hljs-string">&#x27;h&#x27;</span>, 0,<span class="hljs-string">&#x27;loical&#x27;</span>, <span class="hljs-string">&#x27;显示此帮助信息&#x27;</span>,<br>    <span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, 1, <span class="hljs-string">&#x27;character&#x27;</span>, <span class="hljs-string">&#x27;输入文件&#x27;</span>,<br>    <span class="hljs-string">&#x27;splitBy&#x27;</span>,<span class="hljs-string">&#x27;sp&#x27;</span>,0,<span class="hljs-string">&#x27;character&#x27;</span>,<span class="hljs-string">&#x27;分割依据&#x27;</span>,<br>    <span class="hljs-string">&#x27;nFeatureMin&#x27;</span>,<span class="hljs-string">&#x27;nFMin&#x27;</span>,1,<span class="hljs-string">&#x27;double&#x27;</span>,<span class="hljs-string">&#x27;nFeature_RNA Min&#x27;</span>,<br>    <span class="hljs-string">&#x27;nFeatureMax&#x27;</span>,<span class="hljs-string">&#x27;nFMax&#x27;</span>,1,<span class="hljs-string">&#x27;doubelt&#x27;</span>,<span class="hljs-string">&#x27;nFeature_RNA Max&#x27;</span><br>    <span class="hljs-string">&#x27;nCountMin&#x27;</span>,<span class="hljs-string">&#x27;nCMin&#x27;</span>,1,<span class="hljs-string">&#x27;double&#x27;</span>,<span class="hljs-string">&#x27;nCount_RNA Max&#x27;</span>,<br>    <span class="hljs-string">&#x27;nCountMax&#x27;</span>,<span class="hljs-string">&#x27;nCMax&#x27;</span>,1,<span class="hljs-string">&#x27;double&#x27;</span>,<span class="hljs-string">&#x27;nCount_RNA Min&#x27;</span>,<br>    <span class="hljs-string">&#x27;percentMt&#x27;</span>,<span class="hljs-string">&#x27;pM&#x27;</span>,1,<span class="hljs-string">&#x27;doublet&#x27;</span>,<span class="hljs-string">&#x27;percent.mt&#x27;</span>,<br>    <span class="hljs-string">&#x27;outputDir&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, 1, <span class="hljs-string">&#x27;character&#x27;</span>, <span class="hljs-string">&#x27;输出文件&#x27;</span>),<br>    byrow=T, ncol=5<br>    )<br><br>message(sprintf(<span class="hljs-string">&quot;%s%s%s&quot;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20),<span class="hljs-string">&#x27;读入数据&#x27;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20)))<br>opt &lt;- getopt(spec = spec)<br><span class="hljs-keyword">if</span>(endsWith(opt<span class="hljs-variable">$input</span>,<span class="hljs-string">&#x27;qs&#x27;</span>))&#123;<br>    Merge_obj &lt;- qs::qread(opt<span class="hljs-variable">$input</span>)<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(endsWith(opt<span class="hljs-variable">$input</span>,<span class="hljs-string">&#x27;RDS&#x27;</span>) || endsWith(opt<span class="hljs-variable">$input</span>,<span class="hljs-string">&quot;Rds&quot;</span>) || endsWith(opt<span class="hljs-variable">$input</span>,<span class="hljs-string">&quot;rds&quot;</span>))&#123;<br>    Merge_obj &lt;- readRDS(opt<span class="hljs-variable">$input</span>)<br>&#125;<span class="hljs-keyword">else</span> &#123;<br>   message(paste0(Sys.time(), <span class="hljs-string">&#x27; 未找到适合的数据读入方式,请存为qs或者RDS结尾!!!&#x27;</span>))<br>&#125;<br><span class="hljs-comment"># 接收参数</span><br>splitBy &lt;- opt<span class="hljs-variable">$splitBy</span><br>nFeature_RNA_Min &lt;- as.numeric(opt<span class="hljs-variable">$nFeatureMin</span>)<br>nFeature_RNA_Max &lt;- as.numeric(opt<span class="hljs-variable">$nFeatureMax</span>)<br>nCount_RNA_Min &lt;- as.numeric(opt<span class="hljs-variable">$nCountMin</span>)<br>nCount_RNA_Max &lt;- as.numeric(opt<span class="hljs-variable">$nCountMax</span>)<br>percentMt &lt;- as.numeric(opt<span class="hljs-variable">$percent</span>.mt)<br>outputDir &lt;- as.numeric(opt<span class="hljs-variable">$outputDir</span>)<br><br><span class="hljs-keyword">if</span>(!dir.exists(outputDir))&#123;<br>    dir.create(outputDir ,recursive = TRUE)<br>&#125;<br><br>message(sprintf(<span class="hljs-string">&quot;%s%s%s&quot;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20),<span class="hljs-string">&#x27;切分Seurat对象,分别进行数据分析&#x27;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20)))<br><span class="hljs-comment"># Merge_obj &lt;- Merge_obj[,Merge_obj$nFeature_RNA &gt;=200 &amp; Merge_obj$nFeature_RNA &lt;= 7500 &amp; Merge_obj$percent.mt &lt;= 20]</span><br>Merge_obj &lt;- Merge_obj[,Merge_obj<span class="hljs-variable">$nFeature_RNA</span> &gt;=nFeature_RNA_Min &amp; Merge_obj<span class="hljs-variable">$nFeature_RNA</span> &lt;= nFeature_RNA_Max &amp; Merge_obj<span class="hljs-variable">$percent</span>.mt &lt;= percentMt]<br>Merge_obj<br><br><span class="hljs-comment"># SeuratObject Split By </span><br>scRNAlist &lt;- Seurat::SplitObject(Merge_obj,split.by = splitBy)<br><span class="hljs-comment"># 分别进行聚类分析</span><br><span class="hljs-keyword">for</span>(i <span class="hljs-keyword">in</span> 1:length(scRNAlist))&#123;<br>  <span class="hljs-built_in">print</span>(names(scRNAlist[i]))  <br>  scRNAlist[[i]] &lt;- NormalizeData(scRNAlist[[i]])<br>  scRNAlist[[i]] &lt;- ScaleData(scRNAlist[[i]], verbose = FALSE)<br>  scRNAlist[[i]] &lt;- FindVariableFeatures(scRNAlist[[i]], verbose = FALSE)<br>  scRNAlist[[i]] &lt;- RunPCA(scRNAlist[[i]], npcs = 30, verbose = FALSE)<br>  scRNAlist[[i]] &lt;- RunUMAP(scRNAlist[[i]], reduction = <span class="hljs-string">&quot;pca&quot;</span>, dims = 1:30)<br>  scRNAlist[[i]] &lt;- FindNeighbors(scRNAlist[[i]], reduction = <span class="hljs-string">&quot;pca&quot;</span>, dims = 1:30)<br>  scRNAlist[[i]] &lt;- FindClusters(scRNAlist[[i]], resolution = 0.8)<br>&#125;<br><br><span class="hljs-comment"># 进行双细胞鉴定</span><br>message(sprintf(<span class="hljs-string">&quot;%s%s%s&quot;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20),<span class="hljs-string">&#x27;对每个样本数据分别进行双细胞鉴定&#x27;</span>,strrep(<span class="hljs-string">&#x27;*&#x27;</span>,20)))<br>detectDoublet &lt;- <span class="hljs-keyword">function</span>(<br>  obj, <span class="hljs-comment">#seurat obj</span><br>  dims, <span class="hljs-comment">#Pc数目</span><br>  estDubRate, <span class="hljs-comment">#期望双细胞率，该值最好通过细胞在10X/Drop-Seq装置上的负载密度来估计</span><br>  ncores=1,<span class="hljs-comment">#线程数</span><br>  SCTransform,<span class="hljs-comment">#True or False</span><br>  Homotypic=F,<span class="hljs-comment">#是否需要优化同源双细胞</span><br>  annotation)&#123; <span class="hljs-comment">#听说最好是celltype</span><br>  <span class="hljs-comment">#use DoubletFinder packages</span><br>  require(DoubletFinder)<span class="hljs-comment">#2.0.4</span><br>  <span class="hljs-comment">#select pK</span><br>  sweep.res.list &lt;- paramSweep(obj, PCs=dims, sct=SCTransform, num.cores=ncores)<br>  sweep.stats &lt;- summarizeSweep(sweep.res.list, GT=FALSE)<br>  bcmvn &lt;- find.pK(sweep.stats)<br>  pK &lt;- bcmvn<span class="hljs-variable">$pK</span>[which.max(bcmvn<span class="hljs-variable">$BCmetric</span>)] %&gt;% as.character() %&gt;% as.numeric()<br>  message(sprintf(<span class="hljs-string">&quot;Using pK = %s...&quot;</span>, pK))<br>  <span class="hljs-comment">#Doublet Proportion Estimate</span><br>  <span class="hljs-keyword">if</span>(Homotypic==F)&#123;<br>    nExp_poi &lt;- round(estDubRate * length(Cells(obj)))<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    homotypic.prop &lt;- modelHomotypic(obj@meta.data[,annotation])<br>    nExp_poi &lt;- round(estDubRate * length(Cells(obj)))<br>    nExp_poi  &lt;- round(nExp_poi*(1-homotypic.prop))<br>  &#125;<br>  obj &lt;- doubletFinder(obj, PCs = dims, pN = 0.25, pK = pK, nExp = nExp_poi, reuse.pANN = FALSE, sct = SCTransform)<br>  pann &lt;- grep(pattern=<span class="hljs-string">&quot;^pANN&quot;</span>, x=names(obj@meta.data), value=TRUE)<br>  message(sprintf(<span class="hljs-string">&quot;Using pANN = %s...&quot;</span>, pann))<br>  classify &lt;- grep(pattern=<span class="hljs-string">&quot;^DF.classifications&quot;</span>, x=names(obj@meta.data), value=TRUE)<br>  obj<span class="hljs-variable">$pANN</span> &lt;- obj[[pann]]<br>  obj<span class="hljs-variable">$DF</span>.classify &lt;- obj[[classify]]<br>  obj[[pann]] &lt;- NULL<br>  obj[[classify]] &lt;- NULL<br>  <span class="hljs-built_in">return</span>(obj)<br> &#125;<br><span class="hljs-comment">#分样预测双细胞</span><br><span class="hljs-comment"># 对每个样本进行分析</span><br><span class="hljs-comment"># 判断预估的双细胞比例（10x的表格）</span><br>estDubRateFun &lt;- <span class="hljs-keyword">function</span>(srt)&#123;<br>    <span class="hljs-keyword">if</span>(!inherits(srt,<span class="hljs-string">&quot;Seurat&quot;</span>))&#123;stop(<span class="hljs-string">&quot;input file is not Seurat Object...&quot;</span>)&#125;<br>    rate &lt;- tryCatch(&#123;<br>        <span class="hljs-keyword">if</span>(dim(srt)[2] &gt; 500 &amp;&amp; dim(srt)[2] &lt;=1000)&#123;<br>            tmp &lt;- 0.004 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">500</span>) * round(<span class="hljs-number">0.004</span>/<span class="hljs-number">500</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 1000 &amp;&amp; dim(srt)[2] &lt;= 2000) &#123;<br>            tmp &lt;- 0.008 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 2000 &amp;&amp; dim(srt)[2] &lt;= 3000) &#123;<br>            tmp &lt;- 0.016 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.007</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 3000 &amp;&amp; dim(srt)[2] &lt;= 4000) &#123;<br>            tmp &lt;- 0.023 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 4000 &amp;&amp; dim(srt)[2] &lt;= 5000) &#123;<br>           tmp &lt;- 0.031 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 5000 &amp;&amp; dim(srt)[2] &lt;= 6000) &#123;<br>           tmp &lt;- 0.039 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 6000 &amp;&amp; dim(srt)[2] &lt;= 7000) &#123;<br>           tmp &lt;- 0.046 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 7000 &amp;&amp; dim(srt)[2] &lt;= 8000) &#123;<br>           tmp &lt;- 0.054 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 8000 &amp;&amp; dim(srt)[2] &lt;= 9000) &#123;<br>           tmp &lt;- 0.061 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dim(srt)[2] &gt; 9000 &amp;&amp; dim(srt)[2] &lt;= 10000) &#123;<br>           tmp &lt;- 0.069 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(dim(srt)[2] &gt;= 10000)&#123;<br>           tmp &lt;- 0.076 + ((dim(srt)[<span class="hljs-number">2</span>]-<span class="hljs-number">1000</span>) * round(<span class="hljs-number">0.008</span>/<span class="hljs-number">1000</span>,digits = <span class="hljs-number">7</span>))<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-built_in">return</span>(NULL)<br>        &#125;<br>        tmp<br>    &#125;,error = <span class="hljs-keyword">function</span>(e)&#123;<br>        message(e<span class="hljs-variable">$error</span>)<br>        <span class="hljs-built_in">return</span>(NULL)<br>    &#125;)<br>    <span class="hljs-built_in">return</span>(rate)<br>&#125;<br>message(paste0(Sys.time(),<span class="hljs-string">&#x27; 开始进行双细胞检测...&#x27;</span>))<br>scRNAlist &lt;- lapply(scRNAlist, FUN = <span class="hljs-keyword">function</span>(x)&#123;<br>    detectDoublet(x,dims = 1:30,<br>    estDubRate=estDubRateFun(x),<br>    ncores = 20, <br>    SCTransform=F, <br>    Homotypic=F, <br>   annotation=<span class="hljs-string">&quot;seurat_clusters&quot;</span>)<br>&#125;)<br>message(paste0(Sys.time(),<span class="hljs-string">&#x27; 双细胞检测完成，保存数据...&#x27;</span>))<br>qsave::qs(scRNAlist, file = file.path(outputDir,paste0(Sys.Date(),<span class="hljs-string">&#x27;_DoubletFinderResult.qs&#x27;</span>)))<br><span class="hljs-comment">## 鉴定完成双细胞，进行绘图</span><br>message(paste0(Sys.time(),<span class="hljs-string">&#x27; 双细胞检测完成，保存数据...&#x27;</span>))<br>scRNA &lt;- merge(scRNAlist[[1]],scRNAlist[-1])<br>qsave::qs(scRNA, file = file.path(outputDir,paste0(Sys.Date(),<span class="hljs-string">&#x27;_DoubletFinderResultMerge.qs&#x27;</span>)))<br></code></pre></td></tr></table></figure><h2 id="DoubletDetect"><a href="#DoubletDetect" class="headerlink" title="DoubletDetect"></a>DoubletDetect</h2><h1 id="聚类分析模块"><a href="#聚类分析模块" class="headerlink" title="聚类分析模块"></a>聚类分析模块</h1><h2 id="python模块"><a href="#python模块" class="headerlink" title="python模块"></a>python模块</h2><h3 id="Pegasus"><a href="#Pegasus" class="headerlink" title="Pegasus"></a>Pegasus</h3><blockquote><p>网站：<a href="https://github.com/lilab-bcb/pegasus/tree/master">https://github.com/lilab-bcb/pegasus/tree/master</a></p></blockquote><h2 id="harmony"><a href="#harmony" class="headerlink" title="harmony"></a>harmony</h2><blockquote><p>harmony允许多batch去除</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>magrittr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><br>scRNA <span class="hljs-operator">%&lt;&gt;%</span> NormalizeData<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;percent.mt&#x27;</span> <span class="hljs-operator">%in%</span> colnames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    scRNA <span class="hljs-operator">&lt;-</span> PercentageFeatureSet<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> pattern <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;^MT-&#x27;</span><span class="hljs-punctuation">,</span>col.name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Phase&#x27;</span> <span class="hljs-operator">%in%</span> colnames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    scRNA <span class="hljs-operator">%&lt;&gt;%</span> CellCycleScoring<span class="hljs-punctuation">(</span>g2m.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>g2m.genes<span class="hljs-punctuation">,</span><br>                                  s.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>s.genes<span class="hljs-punctuation">,</span><br>                                  g1.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>g1.genes<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> vars.to.regress<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Phase&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;nCount_RNA&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> verbose<span class="hljs-operator">=</span><span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>harmony<span class="hljs-punctuation">)</span><br>system.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunHarmony<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> group.by.vars <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>plot1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span> group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span>raster<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>plot2 <span class="hljs-operator">&lt;-</span> ElbowPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> ndims<span class="hljs-operator">=</span><span class="hljs-number">50</span><span class="hljs-punctuation">,</span> reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">)</span><br>plotc <span class="hljs-operator">&lt;-</span> plot1<span class="hljs-operator">+</span>plot2<br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./harmony_PCA.png&quot;</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> plotc<span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;white&#x27;</span><span class="hljs-punctuation">)</span><br>pc.num <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">40</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>raster<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#DimPlot(scRNA_harmony, reduction = &quot;tsne&quot;, label=T)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;001_大群Harmony.qs&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h1 id="细胞注释"><a href="#细胞注释" class="headerlink" title="细胞注释"></a>细胞注释</h1><h2 id="软件注释"><a href="#软件注释" class="headerlink" title="软件注释"></a>软件注释</h2><h3 id="SingleR"><a href="#SingleR" class="headerlink" title="SingleR"></a>SingleR</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs R"><br>suppressMessages<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>    library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>SingleR<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">#### singleR ####</span><br>Run_singleR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> cluster<span class="hljs-punctuation">,</span> resolution<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    require<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;SingleR&quot;</span><span class="hljs-punctuation">)</span><br>    require<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;dplyr&quot;</span><span class="hljs-punctuation">)</span><br>    stopifnot<span class="hljs-punctuation">(</span>file.exists<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/singleR.RData&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    load<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;/root/wangje/singleR.RData&quot;</span><span class="hljs-punctuation">)</span><br>    ref_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>encode<span class="hljs-punctuation">,</span> hema<span class="hljs-punctuation">,</span> hpca<span class="hljs-punctuation">,</span> immune<span class="hljs-punctuation">,</span> monaImmune<span class="hljs-punctuation">)</span><br>    labels_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>        encode<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        hema<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        hpca<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        immune<span class="hljs-operator">$</span>label.main<span class="hljs-punctuation">,</span><br>        monaImmune<span class="hljs-operator">$</span>label.main<br>    <span class="hljs-punctuation">)</span><br>    sce.data <span class="hljs-operator">&lt;-</span> GetAssayData<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> solt <span class="hljs-operator">=</span> <span class="hljs-string">&quot;data&quot;</span><span class="hljs-punctuation">)</span><br>    sce.singleR <span class="hljs-operator">&lt;-</span> SingleR<span class="hljs-operator">::</span>SingleR<span class="hljs-punctuation">(</span><br>        test <span class="hljs-operator">=</span> sce.data<span class="hljs-punctuation">,</span><br>        ref <span class="hljs-operator">=</span> ref_list<span class="hljs-punctuation">,</span><br>        labels <span class="hljs-operator">=</span> labels_list<span class="hljs-punctuation">,</span><br>        clusters <span class="hljs-operator">=</span> cluster<span class="hljs-punctuation">,</span><br>        BPPARAM <span class="hljs-operator">=</span> BiocParallel<span class="hljs-operator">::</span>MulticoreParam<span class="hljs-punctuation">(</span><span class="hljs-number">6</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 提取 celltype 数据</span><br>    celltype <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span><br>        ClusterID <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>sce.singleR<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        singleR <span class="hljs-operator">=</span> sce.singleR<span class="hljs-operator">$</span>labels<span class="hljs-punctuation">,</span><br>        stringsAsFactors <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><br>    <span class="hljs-punctuation">)</span><br>    <span class="hljs-comment"># 将注释信息添加到seurat对象中</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>resolution<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;missing resolution files.&quot;</span><span class="hljs-punctuation">)</span><br>    tmp <span class="hljs-operator">&lt;-</span> data<span class="hljs-operator">@</span>meta.data <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>select<span class="hljs-punctuation">(</span>resolution<span class="hljs-punctuation">)</span><br>    colnames<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;ClusterID&quot;</span><br>    tmp1 <span class="hljs-operator">&lt;-</span> left_join<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">,</span> celltype<span class="hljs-punctuation">,</span> by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ClusterID&quot;</span><span class="hljs-punctuation">)</span><br>    rownames<span class="hljs-punctuation">(</span>tmp1<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>tmp<span class="hljs-punctuation">)</span><br>    sce_new <span class="hljs-operator">&lt;-</span> AddMetaData<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> tmp1<span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>sce_new<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="celltypist"><a href="#celltypist" class="headerlink" title="celltypist"></a>celltypist</h3><blockquote><p>参考地址:<a href="https://www.celltypist.org/tutorials">https://www.celltypist.org/tutorials</a></p></blockquote><p>【参考数据】</p><ul><li>Cells_Fetal_Lung.pkl，人类胚胎和胎儿肺的146种细胞类型；</li><li>Cells_Intestinal_Tract.pkl，来自胎儿、儿童和成人肠道的134种肠道细胞类型；</li><li>Cells_Lung_Airway.pkl，来自人类肺部和呼吸道五个位置的scRNA的78种细胞群；</li><li>COVID19_Immune_Landscape.pkl，从COVID-19患者和健康对照者的肺和血液中提取的64种免疫亚型；</li><li>Developing_Mouse_Brain.pkl，从原肠形成到出生的小鼠胚胎大脑的174种细胞类型；</li><li>Healthy_COVID19_PBMC.pkl，健康和COVID-19个体的外周血51种单核细胞类型；</li><li>Human_Lung_Atlas.pkl，整合了46个人类呼吸系统数据集的人类肺细胞图谱（HLCA），共计58种细胞类型；</li><li>Immune_All_AddPIP.pkl，来自人的大于20个组织的免疫细胞类型(Immune_All_Low + Immune_All_PIP)；</li><li>mmune_All_High.pkl，来自19项研究的20个组织中的32个免疫细胞亚群；</li><li>Immune_All_Low.pkl，来自19项研究的20个组织中的90个免疫细胞亚群；</li><li>Immune_All_PIP.pkl，来自16个成人组织的41种免疫细胞类型；</li><li>Nuclei_Lung_Airway.pkl，来自人类肺和呼吸道五个位置的78个亚群</li><li>Pan_Fetal_Human.pkl，来自人类胎儿的138个基质和免疫亚群。</li></ul><p>例如，对于用户需要注释免疫细胞类型，官网建议从“Immune_All_Low&#x2F;High”模型开始，因为它们包含从不同组织收集的免疫细胞类型。“Low”表示低层次(高分辨率)细胞类型和子类型，“High”表示高层次(低分辨率)细胞类型。用户也可以尝试免疫细胞类型的扩展参考模型(“Immune_All_AddPIP”)。</p><h4 id="参考数据的下载"><a href="#参考数据的下载" class="headerlink" title="参考数据的下载"></a>参考数据的下载</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## Human</span><br>https://celltypist.cog.sanger.ac.uk/models/Autopsy_COVID19_Delorey/v1/Autopsy_COVID19_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Fetal_Lung_He/v2/Cells_Fetal_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Intestinal_Tract_Elmentaite/v1/Cells_Intestinal_Tract.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Lung_Airway_Madissoon/v4/Cells_Lung_Airway.pkl<br>https://celltypist.cog.sanger.ac.uk/models/COVID19_HumanBlood_Dratva/v1/COVID19_HumanChallenge_Blood.pkl<br>https://celltypist.cog.sanger.ac.uk/models/COVID19_Immune_Ren/v1/COVID19_Immune_Landscape.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Devbrain_Braun/v1/Developing_Human_Brain.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Thymus_Park/v1/Developing_Human_Thymus.pkl<br>https://celltypist.cog.sanger.ac.uk/models/COVID19_PBMC_Haniffa/v1/Healthy_COVID19_PBMC.pkl<br>https://celltypist.cog.sanger.ac.uk/models/IPF_HumanLung_Adams/v1/Human_IPF_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Lung_Sikkema/v2/Human_Lung_Atlas.pkl<br>https://celltypist.cog.sanger.ac.uk/models/PF_HumanLung_Habermann/v1/Human_PF_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Pan_Immune_CellTypist/v2/Immune_All_Low.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Pan_Immune_CellTypist/v2/Immune_All_High.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Lethal_COVID19_Melms/v1/Lethal_COVID19_Lung.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Lung_Airway_Madissoon/v4/Nuclei_Lung_Airway.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Pan_Fetal_Suo/v2/Pan_Fetal_Human.pkl<br><br><span class="hljs-comment">## Mouse</span><br>https://celltypist.cog.sanger.ac.uk/models/Mouse_Gut_Casado/v2/Adult_Mouse_Gut.pkl<br>https://celltypist.cog.sanger.ac.uk/models/Human_Thymus_Park/v1/Developing_Human_Thymus.pkl<br></code></pre></td></tr></table></figure><h4 id="celltype预测"><a href="#celltype预测" class="headerlink" title="celltype预测"></a>celltype预测</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs R"><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;运行celltypist......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>suppressPackageStartupMessages<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>    library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>stringr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>readr<span class="hljs-punctuation">)</span><br>    library<span class="hljs-punctuation">(</span>reticulate<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 可以使R和python联通的R包</span><br>    library<span class="hljs-punctuation">(</span>progress<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 打印进度条</span><br>    library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 导入python包</span><br>scanpy <span class="hljs-operator">=</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;scanpy&quot;</span><span class="hljs-punctuation">)</span><br>celltypist <span class="hljs-operator">=</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;celltypist&quot;</span><span class="hljs-punctuation">)</span><br>pandas <span class="hljs-operator">&lt;-</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;pandas&quot;</span><span class="hljs-punctuation">)</span><br>numpy <span class="hljs-operator">=</span> import<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;numpy&quot;</span><span class="hljs-punctuation">)</span><br><br>Ref_path <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;/root/wangje/Reference/cellTypist_Ref/Human/&quot;</span> <span class="hljs-comment"># 参考数据集位置</span><br><span class="hljs-comment"># Test_path &lt;- &quot;/root/wangje/Project/OveryArtical/001_大群Harmony.qs&quot; # 需要被注释的数据集</span><br>file_prefix <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HarmonyResult_&quot;</span> <span class="hljs-comment"># 输出文件前缀</span><br><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;加载参考数据集&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>model_type <span class="hljs-operator">&lt;-</span> list.files<span class="hljs-punctuation">(</span>Ref_path<span class="hljs-punctuation">,</span>pattern <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pkl$&quot;</span><span class="hljs-punctuation">)</span><br>pb <span class="hljs-operator">&lt;-</span> progress_bar<span class="hljs-operator">$</span>new<span class="hljs-punctuation">(</span><br>    format <span class="hljs-operator">=</span> <span class="hljs-string">&quot;  Loading [:bar] :percent eta: :eta&quot;</span><span class="hljs-punctuation">,</span><br>    total <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>clear <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> width<span class="hljs-operator">=</span> <span class="hljs-number">60</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span> str_split<span class="hljs-punctuation">(</span>string <span class="hljs-operator">=</span> model_type<span class="hljs-punctuation">,</span>pattern <span class="hljs-operator">=</span> <span class="hljs-string">&quot;\\.&quot;</span><span class="hljs-punctuation">,</span> simplify <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>model_list <span class="hljs-operator">=</span> lapply<span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    pb<span class="hljs-operator">$</span>tick<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>    result <span class="hljs-operator">&lt;-</span> celltypist<span class="hljs-operator">$</span>models<span class="hljs-operator">$</span>Model<span class="hljs-operator">$</span>load<span class="hljs-punctuation">(</span>model <span class="hljs-operator">=</span> file.path<span class="hljs-punctuation">(</span>Ref_path<span class="hljs-punctuation">,</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    Sys.sleep<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    result<br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看加载的数据集</span><br>print<span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 读入测试数据</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;[&#x27;</span><span class="hljs-punctuation">,</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;]&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;读入测试数据集，并转换成Annadata对象&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> qs<span class="hljs-operator">::</span>qread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/OveryArtical/001_大群Harmony.qs&#x27;</span><span class="hljs-punctuation">)</span><br>adata <span class="hljs-operator">=</span> scanpy<span class="hljs-operator">$</span>AnnData<span class="hljs-punctuation">(</span><br>    X <span class="hljs-operator">=</span> numpy<span class="hljs-operator">$</span>array<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    obs <span class="hljs-operator">=</span> pandas<span class="hljs-operator">$</span>DataFrame<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    var <span class="hljs-operator">=</span> pandas<span class="hljs-operator">$</span>DataFrame<span class="hljs-punctuation">(</span>data.frame<span class="hljs-punctuation">(</span>gene <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    row.names <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">[[</span><span class="hljs-string">&#x27;RNA&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 预处理</span><br>scanpy<span class="hljs-operator">$</span>pp<span class="hljs-operator">$</span>normalize_total<span class="hljs-punctuation">(</span>adata<span class="hljs-punctuation">,</span> target_sum<span class="hljs-operator">=</span><span class="hljs-number">1e4</span><span class="hljs-punctuation">)</span><br>scanpy<span class="hljs-operator">$</span>pp<span class="hljs-operator">$</span>log1p<span class="hljs-punctuation">(</span>adata<span class="hljs-punctuation">)</span><br>adata <br><br><span class="hljs-comment"># celltype自动注释</span><br>celltypist_vis <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span><br>        adata<span class="hljs-punctuation">,</span><br>        seurat_Data<span class="hljs-punctuation">,</span><br>        reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span><br>        model <span class="hljs-operator">=</span> Immune_All_Low.pkl<span class="hljs-punctuation">,</span><br>        title <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Immune_All_Low&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    predictions <span class="hljs-operator">=</span> celltypist<span class="hljs-operator">$</span>annotate<span class="hljs-punctuation">(</span>adata<span class="hljs-punctuation">,</span> model <span class="hljs-operator">=</span> model<span class="hljs-punctuation">,</span> majority_voting <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>    seurat_Data  <span class="hljs-operator">=</span> AddMetaData<span class="hljs-punctuation">(</span>seurat_Data <span class="hljs-punctuation">,</span> predictions<span class="hljs-operator">$</span>predicted_labels<span class="hljs-punctuation">)</span> <br>    seurat_Data  <span class="hljs-operator">=</span> SetIdent<span class="hljs-punctuation">(</span>seurat_Data <span class="hljs-punctuation">,</span> value <span class="hljs-operator">=</span> <span class="hljs-string">&quot;majority_voting&quot;</span><span class="hljs-punctuation">)</span><br>    p.umap <span class="hljs-operator">=</span> DimPlot<span class="hljs-punctuation">(</span>seurat_Data<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> reduction<span class="hljs-punctuation">,</span> label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span>raster <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>label.box <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>repel <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>title<span class="hljs-punctuation">)</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p.umap<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment"># 批量注释</span><br>pb <span class="hljs-operator">&lt;-</span> progress_bar<span class="hljs-operator">$</span>new<span class="hljs-punctuation">(</span><br>    format <span class="hljs-operator">=</span> <span class="hljs-string">&quot;  Loading [:bar] :percent eta: :eta&quot;</span><span class="hljs-punctuation">,</span><br>    total <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>clear <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> width<span class="hljs-operator">=</span> <span class="hljs-number">60</span><span class="hljs-punctuation">)</span><br><br>plotlist <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    print<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    celltypist_vis<span class="hljs-punctuation">(</span>adata <span class="hljs-operator">=</span> adata<span class="hljs-punctuation">,</span><br>    seurat_Data <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">,</span><br>    model <span class="hljs-operator">=</span> model_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    title <span class="hljs-operator">=</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>model_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">## 保存文件</span><br><span class="hljs-keyword">for</span><span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>plotlist<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;_celltypistAnno.png&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> plotlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h1 id="拟时间分析"><a href="#拟时间分析" class="headerlink" title="拟时间分析"></a>拟时间分析</h1><h2 id="Monocle2"><a href="#Monocle2" class="headerlink" title="Monocle2"></a>Monocle2</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs R"><br>library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>monocle<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 读入数据</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/刘老师/NK_T/new_Result/Data/001_cytotrace2_result&#x27;</span><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> qread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;CD4_celltype2聚类结果.qs&#x27;</span><span class="hljs-punctuation">)</span><br>Idents<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">$</span>celltype2<br>outfile_Prefix <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-comment"># 设置Idents</span><br>DefaultAssay<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span><span class="hljs-string">&#x27;RNA&#x27;</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;构建Monocle2分析对象......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>data <span class="hljs-operator">&lt;-</span> as<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>counts<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;sparseMatrix&#x27;</span><span class="hljs-punctuation">)</span><br>pd <span class="hljs-operator">&lt;-</span> new<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;AnnotatedDataFrame&#x27;</span><span class="hljs-punctuation">,</span> data <span class="hljs-operator">=</span> scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><br>fData <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span>gene_short_name <span class="hljs-operator">=</span> row.names<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> row.names <span class="hljs-operator">=</span> row.names<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>fd <span class="hljs-operator">&lt;-</span> new<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;AnnotatedDataFrame&#x27;</span><span class="hljs-punctuation">,</span> data <span class="hljs-operator">=</span> fData<span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> newCellDataSet<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span><br>  phenoData <span class="hljs-operator">=</span> pd<span class="hljs-punctuation">,</span><br>  featureData <span class="hljs-operator">=</span> fd<span class="hljs-punctuation">,</span><br>  lowerDetectionLimit <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><br>  expressionFamily <span class="hljs-operator">=</span> negbinomial.size<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>print<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;format data done , filter select genes &quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#pData(monocds)$Cluster&lt;-as.factor(pData(monocds)$celltype) </span><br>pData<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-string">&#x27;Cluster&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-operator">=</span>scRNA<span class="hljs-operator">@</span>active.ident<br>monocds <span class="hljs-operator">&lt;-</span> estimateSizeFactors<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> estimateDispersions<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> detectGenes<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span> min_expr <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><br>print<span class="hljs-punctuation">(</span>head<span class="hljs-punctuation">(</span>fData<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 过滤低质量的基因</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;过滤低质量的细胞......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>expressed_genes <span class="hljs-operator">&lt;-</span> row.names<span class="hljs-punctuation">(</span>subset<span class="hljs-punctuation">(</span>fData<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> num_cells_expressed <span class="hljs-operator">&gt;=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># nolint</span><br>monocds <span class="hljs-operator">&lt;-</span> monocds<span class="hljs-punctuation">[</span>expressed_genes<span class="hljs-punctuation">,</span> <span class="hljs-punctuation">]</span><br>monocds.raw <span class="hljs-operator">&lt;-</span> monocds<br><span class="hljs-comment"># 高变基因筛选方式1 使用monocle2进行筛选*********************************************************************************</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;高变基因筛选方式1......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>disp_table <span class="hljs-operator">&lt;-</span> dispersionTable<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>express_genes <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>disp_table<span class="hljs-punctuation">,</span> mean_expression <span class="hljs-operator">&gt;=</span> <span class="hljs-number">0.1</span> <span class="hljs-operator">&amp;</span> dispersion_empirical <span class="hljs-operator">&gt;=</span> <span class="hljs-number">1</span> <span class="hljs-operator">*</span> dispersion_fit<span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>gene_id<br><span class="hljs-comment"># dir=paste0(&#x27;monocle_output&#x27;)</span><br><span class="hljs-comment"># trajectory_cluster_dir=paste(&#x27;./&#x27;,dir,sep=&quot;&quot;)</span><br>monocds <span class="hljs-operator">&lt;-</span> setOrderingFilter<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span> express_genes<span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> plot_ordering_genes<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 查看选择的基因的分布</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;01直接根据阈值进行筛选.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">4.5</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> reduceDimension<span class="hljs-punctuation">(</span><br>monocds<span class="hljs-punctuation">,</span><br>max_components <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DDRTree&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> orderCells<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;01直接根据阈值进行筛选.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;State&quot;</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype2&quot;</span><span class="hljs-punctuation">)</span><br>p4 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Treat_assess&quot;</span><span class="hljs-punctuation">)</span><br>p5 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by<span class="hljs-operator">=</span><span class="hljs-string">&quot;Pseudotime&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;01直接根据阈值进行筛选02.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> cowplot<span class="hljs-operator">::</span>plot_grid<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span>p2<span class="hljs-punctuation">,</span>p3<span class="hljs-punctuation">,</span>p4<span class="hljs-punctuation">,</span>p5<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>align <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;hv&#x27;</span><span class="hljs-punctuation">,</span>nrow <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">21</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 高变基因筛选方式2 使用高变基因*************************************************************************************</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;高变基因筛选方式2......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> monocds.raw<br>express_genes <span class="hljs-operator">&lt;-</span> Seurat<span class="hljs-operator">::</span>VariableFeatures<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> setOrderingFilter<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span> express_genes<span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> plot_ordering_genes<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 查看选择的基因的分布</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;02高变基因筛选进行筛选.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">4.5</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> reduceDimension<span class="hljs-punctuation">(</span><br>monocds<span class="hljs-punctuation">,</span><br>max_components <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DDRTree&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> orderCells<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;02高变基因筛选进行筛选.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>p2 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;State&quot;</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype2&quot;</span><span class="hljs-punctuation">)</span><br>p4 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Treat_assess&quot;</span><span class="hljs-punctuation">)</span><br>p5 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by<span class="hljs-operator">=</span><span class="hljs-string">&quot;Pseudotime&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;cd8_02高变基因筛选进行筛选02.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> cowplot<span class="hljs-operator">::</span>plot_grid<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span>p2<span class="hljs-punctuation">,</span>p3<span class="hljs-punctuation">,</span>p4<span class="hljs-punctuation">,</span>p5<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>align <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;hv&#x27;</span><span class="hljs-punctuation">,</span>nrow <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">21</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 高变基因筛选方式3 cluster差异基因***************************************************************************************</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;高变基因筛选方式3......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> monocds.raw<br>Idents<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;celltype2&quot;</span><br>deg.cluster <span class="hljs-operator">&lt;-</span> FindAllMarkers<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span><br>express_genes <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>deg.cluster<span class="hljs-punctuation">,</span>p_val_adj <span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>gene<br>monocds <span class="hljs-operator">&lt;-</span> setOrderingFilter<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span> express_genes<span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> plot_ordering_genes<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 查看选择的基因的分布</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;03cluster差异基因进行筛选.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">4.5</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> reduceDimension<span class="hljs-punctuation">(</span><br>monocds<span class="hljs-punctuation">,</span><br>max_components <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DDRTree&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> orderCells<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;03cluster差异基因进行筛选.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;State&quot;</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype2&quot;</span><span class="hljs-punctuation">)</span><br>p4 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Treat_assess&quot;</span><span class="hljs-punctuation">)</span><br>p5 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by<span class="hljs-operator">=</span><span class="hljs-string">&quot;Pseudotime&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;cd8_03cluster差异基因进行筛选02.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> cowplot<span class="hljs-operator">::</span>plot_grid<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span>p2<span class="hljs-punctuation">,</span>p3<span class="hljs-punctuation">,</span>p4<span class="hljs-punctuation">,</span>p5<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>align <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;hv&#x27;</span><span class="hljs-punctuation">,</span>nrow <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">21</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 高变基因筛选方式4 使用dpFeature进行筛选***********************************************************************************</span><br><span class="hljs-comment"># Description:</span><br><br><span class="hljs-comment">#      Tests each gene for differential expression as a function of</span><br><span class="hljs-comment">#      pseudotime or according to other covariates as specified.</span><br><span class="hljs-comment">#      ‘differentialGeneTest’ is Monocle&#x27;s main differential analysis</span><br><span class="hljs-comment">#      routine.  It accepts a CellDataSet and two model formulae as</span><br><span class="hljs-comment">#      input, which specify generalized lineage models as implemented by</span><br><span class="hljs-comment">#      the ‘VGAM’ package.</span><br><br><span class="hljs-comment"># Usage:</span><br><br><span class="hljs-comment">#      differentialGeneTest(</span><br><span class="hljs-comment">#        cds,</span><br><span class="hljs-comment">#        fullModelFormulaStr = &quot;~sm.ns(Pseudotime, df=3)&quot;,</span><br><span class="hljs-comment">#        reducedModelFormulaStr = &quot;~1&quot;,</span><br><span class="hljs-comment">#        relative_expr = TRUE,</span><br><span class="hljs-comment">#        cores = 1,</span><br><span class="hljs-comment">#        verbose = FALSE</span><br><span class="hljs-comment">#      )</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;高变基因筛选方式4......&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> monocds.raw<br>diff <span class="hljs-operator">&lt;-</span> differentialGeneTest<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span><br>fullModelFormulaStr <span class="hljs-operator">=</span> <span class="hljs-string">&quot;~celltype2&quot;</span><span class="hljs-punctuation">,</span><br>core<span class="hljs-operator">=</span><span class="hljs-number">50</span><br><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>diff<span class="hljs-punctuation">)</span><br>degs <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>diff<span class="hljs-punctuation">,</span>qval<span class="hljs-operator">&lt;</span><span class="hljs-number">0.01</span><span class="hljs-punctuation">)</span><br>degs <span class="hljs-operator">&lt;-</span> degs<span class="hljs-punctuation">[</span>order<span class="hljs-punctuation">(</span>degs<span class="hljs-operator">$</span>qval<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>express_genes <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>degs<span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> setOrderingFilter<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span> express_genes<span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> plot_ordering_genes<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 查看选择的基因的分布</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;04dpFeature差异基因选进行筛选.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">4.5</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> reduceDimension<span class="hljs-punctuation">(</span><br>monocds<span class="hljs-punctuation">,</span><br>max_components <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DDRTree&quot;</span><span class="hljs-punctuation">)</span><br>monocds <span class="hljs-operator">&lt;-</span> orderCells<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;04dpFeature差异基因选进行筛选.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;State&quot;</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype2&quot;</span><span class="hljs-punctuation">)</span><br>p4 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Treat_assess&quot;</span><span class="hljs-punctuation">)</span><br>p5 <span class="hljs-operator">&lt;-</span> plot_cell_trajectory<span class="hljs-punctuation">(</span>monocds<span class="hljs-punctuation">,</span>color_by<span class="hljs-operator">=</span><span class="hljs-string">&quot;Pseudotime&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>outfile_Prefix<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;04dpFeature差异基因选进行筛选02.png&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> cowplot<span class="hljs-operator">::</span>plot_grid<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">,</span>p2<span class="hljs-punctuation">,</span>p3<span class="hljs-punctuation">,</span>p4<span class="hljs-punctuation">,</span>p5<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>align <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;hv&#x27;</span><span class="hljs-punctuation">,</span>nrow <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">21</span><span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h2 id="Monocle3"><a href="#Monocle3" class="headerlink" title="Monocle3"></a>Monocle3</h2><h2 id="SCORPIUS"><a href="#SCORPIUS" class="headerlink" title="SCORPIUS"></a>SCORPIUS</h2><blockquote><p>R包地址:<a href="https://github.com/rcannood/SCORPIUS">https://github.com/rcannood/SCORPIUS</a></p><p>文章链接:<a href="https://doi.org/10.1038/s41587-019-0071-9">https://doi.org/10.1038/s41587-019-0071-9</a></p></blockquote><h4 id="R包安装"><a href="#R包安装" class="headerlink" title="R包安装"></a>R包安装</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs R">install.packages<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;SCORPIUS&quot;</span><span class="hljs-punctuation">)</span><br>devtools<span class="hljs-operator">::</span>install_github<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;rcannood/SCORPIUS&quot;</span><span class="hljs-punctuation">,</span> build_vignettes <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-comment">#github安装</span><br></code></pre></td></tr></table></figure><h2 id="RNA速率分析"><a href="#RNA速率分析" class="headerlink" title="RNA速率分析"></a>RNA速率分析</h2><blockquote><p>文献地址：<a href="https://doi.org/10.1038/s41586-018-0414-6">https://doi.org/10.1038/s41586-018-0414-6</a></p></blockquote><h3 id="scVelo"><a href="#scVelo" class="headerlink" title="scVelo"></a>scVelo</h3><blockquote><p>地址：<a href="https://scvelo.readthedocs.io/en/stable/about.html">https://scvelo.readthedocs.io/en/stable/about.html</a></p></blockquote><h4 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 直接安装</span><br>pip install -U scvelo<br><span class="hljs-comment"># 开发版本安装</span><br>pip install git+https://github.com/theislab/scvelo@main<br><span class="hljs-comment"># 源码安装</span><br>git clone https://github.com/theislab/scvelo &amp;&amp; cd scvelo<br>git checkoutpip install pybind11 hnswlib --track origin/main<br>pip install -e .<br><span class="hljs-comment"># Dependencies</span><br><span class="hljs-comment"># anndata - annotated data object.</span><br><span class="hljs-comment"># scanpy - toolkit for single-cell analysis.</span><br><span class="hljs-comment"># numpy, scipy, pandas, scikit-learn, matplotlib.</span><br>pip install igraph louvain<br>pip install pybind11 hnswlib<br><span class="hljs-comment"># 测试是否安装成功</span><br><span class="hljs-built_in">print</span>(scvelo.__version__)<br></code></pre></td></tr></table></figure><h4 id="数据转换"><a href="#数据转换" class="headerlink" title="数据转换"></a>数据转换</h4><blockquote><p>在使用之前，有的结果可能是Seurat对象，需要将Seurat对象转换成Annadata对象</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>sceasy<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/001_cytotrace2_result&#x27;</span><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> qread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./celltype2聚类结果.qs&#x27;</span><span class="hljs-punctuation">)</span><br>sceasy<span class="hljs-operator">::</span>convertFormat<span class="hljs-punctuation">(</span>obj <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">,</span>from <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seurat&quot;</span><span class="hljs-punctuation">,</span>to <span class="hljs-operator">=</span> <span class="hljs-string">&quot;anndata&quot;</span><span class="hljs-punctuation">,</span>outFile <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./celltype2.h5ad&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> scvelo <span class="hljs-keyword">as</span> scv<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt <br><span class="hljs-keyword">import</span> scanpy <span class="hljs-keyword">as</span> sc<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-comment"># 设置路径</span><br>os.chdir(<span class="hljs-string">&#x27;/root/wangje/Project/刘老师/NK_T/new_Result/Data/001_cytotrace2_result&#x27;</span>)<br><br><span class="hljs-comment"># 设置字体</span><br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <span class="hljs-comment"># 用来正常显示中文标签</span><br>plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 用来正常显示负号</span><br>plt.rcParams[<span class="hljs-string">&#x27;font.family&#x27;</span>] = <span class="hljs-string">&#x27;Arial&#x27;</span><br><br><span class="hljs-comment"># 读入数据</span><br>adata = scv.read(<span class="hljs-string">&#x27;cd4_celltype2.h5ad&#x27;</span>, cache=<span class="hljs-literal">True</span>)<br>adata.obs_names<br><br>ldat = scv.read_loom(<span class="hljs-string">&#x27;/root/wangje/Project/刘老师/Loom文件/merged.loom&#x27;</span>)<br>ldat<br><span class="hljs-comment"># Out[29]:</span><br><span class="hljs-comment"># AnnData object with n_obs × n_vars = 399693 × 58336</span><br><span class="hljs-comment">#     var: &#x27;Accession&#x27;, &#x27;Chromosome&#x27;, &#x27;End&#x27;, &#x27;Start&#x27;, &#x27;Strand&#x27;</span><br><span class="hljs-comment">#     layers: &#x27;matrix&#x27;, &#x27;ambiguous&#x27;, &#x27;spliced&#x27;, &#x27;unspliced&#x27;</span><br><br>ldat.obs_names<br><span class="hljs-comment"># Index([&#x27;CJME_0707:AAACATCGAGTCACTAAAGACGGAx&#x27;,</span><br><span class="hljs-comment">#        &#x27;CJME_0707:AAACATCGAACGCTTACGAACTTAx&#x27;,</span><br><span class="hljs-comment">#        &#x27;CJME_0707:AAACATCGAATGTTGCACAGCAGAx&#x27;,</span><br><span class="hljs-comment"># 修改loom文件的index name使其和adame的obs_names一致。</span><br>ldat.obs_names = [<span class="hljs-built_in">str</span>(x).replace(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;_&#x27;</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-built_in">str</span>(x).replace(<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ldat.obs_names]]<br><span class="hljs-built_in">len</span>(adata.obs_names.intersection(ldat.obs_names)) <span class="hljs-comment"># 查看两个数据中有多少重叠的元素。</span><br>adata = scv.utils.merge(adata, ldat) <span class="hljs-comment"># 合并数据，合并完的数据是和两数据中重叠元素的数量相等。</span><br>adata.obsm<br><span class="hljs-comment"># AxisArrays with keys: X_bbknnpca, X_bbknnumap2d, X_bbknnumap3d, X_combatpca, X_combatumap2d, X_combatumap3d,</span><br><span class="hljs-comment"># X_css, X_csspca, X_cssumap2d, X_cssumap3d, X_scvi, X_scviumap2d, X_scviumap3d, X_umap</span><br>adata.layers<br><span class="hljs-comment"># Layers with keys: matrix, ambiguous, spliced, unspliced</span><br><br><br><span class="hljs-comment"># 添加降维坐标</span><br>adata.obsm[<span class="hljs-string">&#x27;X_umap&#x27;</span>] = adata.obsm[<span class="hljs-string">&#x27;X_scviumap2d&#x27;</span>]<br><span class="hljs-comment"># 绘图查看</span><br>sc.pl.umap(adata, color=<span class="hljs-string">&#x27;celltype2&#x27;</span>)<br>scv.pl.proportions(adata) <span class="hljs-comment"># 查看数据中splice和unsplice的比例</span><br><span class="hljs-comment"># 数据预处理</span><br>scv.pp.filter_genes(adata, min_shared_counts=<span class="hljs-number">20</span>)<br>scv.pp.normalize_per_cell(adata)<br>scv.pp.filter_genes_dispersion(adata, n_top_genes=<span class="hljs-number">2000</span>)<br>scv.pp.log1p(adata)<br>scv.pp.filter_and_normalize(adata, min_shared_counts=<span class="hljs-number">20</span>, n_top_genes=<span class="hljs-number">2000</span>)<br>scv.pp.moments(adata, n_pcs=<span class="hljs-number">30</span>, n_neighbors=<span class="hljs-number">30</span>) <span class="hljs-comment"># scv.pp.pca and scv.pp.neighbors</span><br>scv.tl.velocity(adata) <span class="hljs-comment"># Estimate RNA velocity</span><br>scv.tl.velocity_graph(adata,n_jobs=<span class="hljs-number">10</span>)<br><span class="hljs-comment"># 绘图</span><br>scv.pl.velocity_embedding_stream(adata, basis=<span class="hljs-string">&#x27;umap&#x27;</span>,color=<span class="hljs-string">&quot;celltype2&quot;</span>)<br>scv.pl.velocity_embedding(adata, arrow_length=<span class="hljs-number">8</span>, arrow_size=<span class="hljs-number">2</span>, dpi=<span class="hljs-number">120</span>,color=<span class="hljs-string">&quot;celltype2&quot;</span>)<br>scv.pl.velocity_embedding_stream(adata, basis=<span class="hljs-string">&#x27;umap&#x27;</span>,color=<span class="hljs-string">&quot;celltype2&quot;</span>,arrow_style=<span class="hljs-string">&quot;-&gt;&quot;</span>,smooth=<span class="hljs-number">1</span>,density=<span class="hljs-number">5</span>,integration_direction=<span class="hljs-string">&quot;backward&quot;</span>)<br><span class="hljs-comment"># 计算细胞周期</span><br>scv.tl.score_genes_cell_cycle(adata)<br>scv.pl.scatter(adata, color_gradients=[<span class="hljs-string">&#x27;S_score&#x27;</span>, <span class="hljs-string">&#x27;G2M_score&#x27;</span>], smooth=<span class="hljs-literal">True</span>, perc=[<span class="hljs-number">5</span>, <span class="hljs-number">95</span>])<br><span class="hljs-comment"># 查看分化的轨迹</span><br>scv.tl.velocity_confidence(adata)<br>keys = <span class="hljs-string">&#x27;velocity_length&#x27;</span>, <span class="hljs-string">&#x27;velocity_confidence&#x27;</span><br>scv.pl.scatter(adata, c=keys, cmap=<span class="hljs-string">&#x27;coolwarm&#x27;</span>, perc=[<span class="hljs-number">5</span>, <span class="hljs-number">95</span>])<br><span class="hljs-comment"># 查看pseudotime</span><br>scv.tl.velocity_pseudotime(adata)<br>scv.pl.scatter(adata, color=<span class="hljs-string">&#x27;velocity_pseudotime&#x27;</span>, cmap=<span class="hljs-string">&#x27;gnuplot&#x27;</span>)<br><span class="hljs-comment"># 查看page</span><br>adata.uns[<span class="hljs-string">&#x27;neighbors&#x27;</span>][<span class="hljs-string">&#x27;distances&#x27;</span>] = adata.obsp[<span class="hljs-string">&#x27;distances&#x27;</span>]<br>adata.uns[<span class="hljs-string">&#x27;neighbors&#x27;</span>][<span class="hljs-string">&#x27;connectivities&#x27;</span>] = adata.obsp[<span class="hljs-string">&#x27;connectivities&#x27;</span>]<br><br>scv.tl.paga(adata, groups=<span class="hljs-string">&#x27;celltype2&#x27;</span>,root_key=<span class="hljs-string">&quot;CD4+ Tn&quot;</span>,threshold_root_end_prior=<span class="hljs-number">0.5</span>)<br><span class="hljs-comment"># df = scv.get_df(adata, &#x27;paga/transitions_confidence&#x27;, precision=2).T</span><br><span class="hljs-comment"># df.style.background_gradient(cmap=&#x27;Blues&#x27;).format(&#x27;&#123;:.2g&#125;&#x27;)</span><br><br>scv.pl.paga(adata, basis=<span class="hljs-string">&#x27;umap&#x27;</span>, size=<span class="hljs-number">50</span>, alpha=<span class="hljs-number">.1</span>,<br>            min_edge_width=<span class="hljs-number">2</span>, node_size_scale=<span class="hljs-number">1.5</span>)<br></code></pre></td></tr></table></figure><h4 id="计算diffmap"><a href="#计算diffmap" class="headerlink" title="计算diffmap"></a>计算diffmap</h4><h1 id="绘图"><a href="#绘图" class="headerlink" title="绘图"></a>绘图</h1><h2 id="细胞比例柱形图"><a href="#细胞比例柱形图" class="headerlink" title="细胞比例柱形图"></a>细胞比例柱形图</h2><h2 id="绘制mrker基因密度图"><a href="#绘制mrker基因密度图" class="headerlink" title="绘制mrker基因密度图"></a>绘制mrker基因密度图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs R">plot_marker_density_heatmap <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> mark_list<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;HarmonyUMAP2D&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  plist <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>  <br>  <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>j <span class="hljs-keyword">in</span> mark_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>      result <span class="hljs-operator">&lt;-</span> tryCatch<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>        scCustomize<span class="hljs-operator">::</span>Plot_Density_Custom<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> j<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> reduction<span class="hljs-punctuation">,</span> viridis_palette <span class="hljs-operator">=</span> <span class="hljs-string">&quot;viridis&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>          labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;:&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>          Seurat<span class="hljs-operator">::</span>NoGrid<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>          Seurat<span class="hljs-operator">::</span>NoAxes<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>          theme_test<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span><br>                     base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">,</span><br>                     base_rect_size <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>          theme<span class="hljs-punctuation">(</span>plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                axis.text <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                axis.ticks <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                axis.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                legend.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">12</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> error <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>e<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;|&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; error: &quot;</span><span class="hljs-punctuation">,</span> e<span class="hljs-operator">$</span>message<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> finally <span class="hljs-operator">=</span> <span class="hljs-punctuation">&#123;</span><br>        message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;|&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; finish...&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>      <br>      plist<span class="hljs-punctuation">[[</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;|&#x27;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> result<br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br>  <br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>plist<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment"># 调用函数示例</span><br><span class="hljs-comment"># plot_marker_density_heatmap(scRNA, mark_list)</span><br><br></code></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs R">plist <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>j <span class="hljs-keyword">in</span> mark_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    print<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27; and &#x27;</span><span class="hljs-punctuation">,</span>j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    result <span class="hljs-operator">&lt;-</span> SCpubr<span class="hljs-operator">::</span>do_NebulosaPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> j<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>    labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;:&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      Seurat<span class="hljs-operator">::</span>NoGrid<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      Seurat<span class="hljs-operator">::</span>NoAxes<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      theme_test<span class="hljs-punctuation">(</span><br>        base_size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span><br>        base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">,</span><br>        base_rect_size <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><br>      <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      theme<span class="hljs-punctuation">(</span><br>        plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.text <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.ticks <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        legend.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">12</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">)</span><br>    plist<span class="hljs-punctuation">[[</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;|&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> result<br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_大群Feature密度.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">17</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span>plist<span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span>）<br></code></pre></td></tr></table></figure><h2 id="FeaturePlot绘图"><a href="#FeaturePlot绘图" class="headerlink" title="FeaturePlot绘图"></a>FeaturePlot绘图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>FeaturePlot<span class="hljs-punctuation">(</span>scdata4<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CD3E&quot;</span><span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span>pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0.0001</span><span class="hljs-punctuation">,</span>max.cutoff <span class="hljs-operator">=</span> <span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><br>                 cols <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;#FFEFD5&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#E6E6FA&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#87CEFA&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#6495ED&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#4169E1&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#0000CD&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#000080&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  scale_x_continuous<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>scale_y_continuous<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>  theme_bw<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span>  panel.grid.major <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>panel.grid.minor <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.ticks <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>axis.text <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>    <br>          legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span>                                       <br>          plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>size<span class="hljs-operator">=</span><span class="hljs-number">14</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>ggtitle<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;T cell (CD3E)&#x27;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_8fd70cbd4e9adc90df5dca8c85dfcf37.png"></p><h2 id="绘制基因表达热图"><a href="#绘制基因表达热图" class="headerlink" title="绘制基因表达热图"></a>绘制基因表达热图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs R">top <span class="hljs-operator">=</span> cell_marker <span class="hljs-operator">%&gt;%</span> group_by<span class="hljs-punctuation">(</span>cluster<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> top_n<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> wt <span class="hljs-operator">=</span> avg_log2FC <span class="hljs-punctuation">)</span> <br>top <span class="hljs-operator">=</span> rbind<span class="hljs-punctuation">(</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;T cell&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;Myeloid&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;B cell&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;Endo&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;Mesenchyme&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;Malignant&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-built_in">exp</span> <span class="hljs-operator">=</span> AverageExpression<span class="hljs-punctuation">(</span>scdata4<span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;celltype2&#x27;</span><span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> top<span class="hljs-operator">$</span>gene<span class="hljs-punctuation">)</span><br><br>scdata4<span class="hljs-operator">$</span>celltype2 <span class="hljs-operator">=</span> factor<span class="hljs-punctuation">(</span>scdata4<span class="hljs-operator">$</span>celltype2<span class="hljs-punctuation">,</span>levels <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;T cell&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Myeloid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;B cell&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Endo&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Mesenchyme&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Malignant&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">exp</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">exp</span><span class="hljs-operator">$</span>SCT<br><span class="hljs-built_in">exp</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">exp</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;T cell&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Myeloid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;B cell&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Endo&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Mesenchyme&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Malignant&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>bk <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>by<span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>color <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>colorRampPalette<span class="hljs-punctuation">(</span>colors <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#FEF9F7&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>bk<span class="hljs-punctuation">)</span><span class="hljs-operator">/</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>colorRampPalette<span class="hljs-punctuation">(</span>colors <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;#FEF9F7&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#FB6848&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>bk<span class="hljs-punctuation">)</span><span class="hljs-operator">/</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>pheatmap<span class="hljs-punctuation">(</span><span class="hljs-built_in">exp</span><span class="hljs-punctuation">,</span> fontsize<span class="hljs-operator">=</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>         color  <span class="hljs-operator">=</span> color<span class="hljs-punctuation">,</span>scale <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;row&#x27;</span><span class="hljs-punctuation">,</span><br>         border_color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey60&quot;</span><span class="hljs-punctuation">,</span>border<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span><br>         cluster_cols <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> cluster_rows <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><br>         show_rownames <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> show_colnames <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br><br><br>library<span class="hljs-punctuation">(</span>clusterProfiler<span class="hljs-punctuation">)</span><br>res1 <span class="hljs-operator">=</span> bitr<span class="hljs-punctuation">(</span>top<span class="hljs-operator">$</span>gene<span class="hljs-punctuation">,</span>fromType<span class="hljs-operator">=</span>  <span class="hljs-string">&quot;SYMBOL&quot;</span> <span class="hljs-punctuation">,</span>toType<span class="hljs-operator">=</span><span class="hljs-string">&quot;ENTREZID&quot;</span><span class="hljs-punctuation">,</span>OrgDb<span class="hljs-operator">=</span><span class="hljs-string">&quot;org.Hs.eg.db&quot;</span><span class="hljs-punctuation">)</span><br>rownames<span class="hljs-punctuation">(</span>res1<span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span> res1<span class="hljs-operator">$</span>SYMBOL<br>kk <span class="hljs-operator">&lt;-</span> enrichKEGG<span class="hljs-punctuation">(</span>res1<span class="hljs-punctuation">[</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;T cell&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>gene <span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> pvalueCutoff <span class="hljs-operator">=</span> <span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span>qvalueCutoff <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><br><br>ego_BP <span class="hljs-operator">=</span> data.frame<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">as.character</span><span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>top<span class="hljs-operator">$</span>cluster<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  ego_BP2 <span class="hljs-operator">&lt;-</span> enrichGO<span class="hljs-punctuation">(</span>filter<span class="hljs-punctuation">(</span>top<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">==</span> i<span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>gene<span class="hljs-punctuation">,</span> <br>                     OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">,</span>ont <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BP&quot;</span><span class="hljs-punctuation">,</span> keyType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span><br>                     pAdjustMethod <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BH&quot;</span><span class="hljs-punctuation">,</span>pvalueCutoff <span class="hljs-operator">=</span> <span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span>qvalueCutoff <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span>readable <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>  ego_BP2<span class="hljs-operator">@</span>result<span class="hljs-operator">$</span>celltype <span class="hljs-operator">=</span> i<br>  ego_BP <span class="hljs-operator">=</span> rbind<span class="hljs-punctuation">(</span>ego_BP<span class="hljs-punctuation">,</span>ego_BP2<span class="hljs-operator">@</span>result<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br>ego_subset <span class="hljs-operator">=</span> ego_BP<span class="hljs-punctuation">[</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;GO:0140131&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0035747&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0010820&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0019886&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0060333&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0043312&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0050864&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0050853&#x27;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-string">&#x27;GO:0042113&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0010739&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0042118&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:004544&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0006936&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0033275&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0030239&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0070268&#x27;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-string">&#x27;GO:0097284&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0043588&#x27;</span><span class="hljs-punctuation">,</span>   <span class="hljs-string">&#x27;GO:0002576&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0034375&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GO:0072376&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span><span class="hljs-number">9</span><span class="hljs-punctuation">,</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>ego_subset<span class="hljs-operator">$</span>log10 <span class="hljs-operator">=</span> <span class="hljs-operator">-</span>log10<span class="hljs-punctuation">(</span>ego_subset<span class="hljs-operator">$</span>p.adjust<span class="hljs-punctuation">)</span><br>ego_subset<span class="hljs-operator">$</span>Description <span class="hljs-operator">=</span> factor<span class="hljs-punctuation">(</span>ego_subset<span class="hljs-operator">$</span>Description<span class="hljs-punctuation">,</span>levels <span class="hljs-operator">=</span> rev<span class="hljs-punctuation">(</span>ego_subset<span class="hljs-operator">$</span>Description<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>ggplot<span class="hljs-punctuation">(</span>ego_subset<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x<span class="hljs-operator">=</span>Description<span class="hljs-punctuation">,</span> y<span class="hljs-operator">=</span>log10<span class="hljs-punctuation">,</span>fill <span class="hljs-operator">=</span> Count<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_bar<span class="hljs-punctuation">(</span>position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dodge&quot;</span><span class="hljs-punctuation">,</span>stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;identity&quot;</span><span class="hljs-punctuation">,</span>colour<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span> <span class="hljs-number">0.6</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>coord_flip<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  scale_fill_gradient2<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#EFAE95&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#F37132&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_7bc6aa27762fc3225b7bbae4b793bd33.png"></p><h2 id="细胞比例堆叠柱形图"><a href="#细胞比例堆叠柱形图" class="headerlink" title="细胞比例堆叠柱形图"></a>细胞比例堆叠柱形图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs R">No_Malignant <span class="hljs-operator">=</span> filter<span class="hljs-punctuation">(</span>scdata4<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">,</span>celltype2 <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;Malignant&#x27;</span><span class="hljs-punctuation">)</span><br>prop <span class="hljs-operator">=</span> prop.table<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>No_Malignant<span class="hljs-operator">$</span>celltype2<span class="hljs-punctuation">,</span> No_Malignant<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;MVI2&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">*</span><span class="hljs-number">100</span><br>prop <span class="hljs-operator">=</span> reshape2<span class="hljs-operator">::</span>melt<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">)</span><br><br><br>prop<span class="hljs-operator">$</span>Var1 <span class="hljs-operator">=</span> factor<span class="hljs-punctuation">(</span>prop<span class="hljs-operator">$</span>Var1<span class="hljs-punctuation">,</span>levels <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;T cell&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;B cell&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Myeloid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Endo&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Mesenchyme&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>prop<span class="hljs-operator">$</span>Var2 <span class="hljs-operator">=</span> factor<span class="hljs-punctuation">(</span>prop<span class="hljs-operator">$</span>Var2<span class="hljs-punctuation">,</span>levels <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Normal Non-MVI&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Normal MVI&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Tumor Non-MVI&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;Tumor MVI&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>ggplot<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">,</span>aes<span class="hljs-punctuation">(</span>Var2<span class="hljs-punctuation">,</span>value<span class="hljs-punctuation">,</span>fill <span class="hljs-operator">=</span> Var1 <span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>geom_bar<span class="hljs-punctuation">(</span>stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;identity&quot;</span><span class="hljs-punctuation">,</span>position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;stack&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> ggthemes<span class="hljs-operator">::</span>theme_few<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  scale_fill_manual<span class="hljs-punctuation">(</span>values <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;#A57EBF&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#E2CAAE&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#EEC689&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#DE6449&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#9BCFB9&#x27;</span><span class="hljs-punctuation">,</span><br>                               <span class="hljs-string">&#x27;#87B2D4&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#50C1E9&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#DEA5BE&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#93BF82&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_200234d25b3866744571f9fddd3d7c1f.png"></p><blockquote><p>堆叠柱形图添加连线</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs R">prop <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>prop.table<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> margin <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                Var1   Var2        Freq</span><br><span class="hljs-comment"># 1           B cells Normal 0.001589761</span><br><span class="hljs-comment"># 2 Endothelial_cells Normal 0.153640957</span><br><span class="hljs-comment"># 3  Epithelial cells Normal 0.295884136</span><br><span class="hljs-comment"># 4       Fibroblasts Normal 0.359043449</span><br><span class="hljs-comment"># 5     Keratinocytes Normal 0.139710340</span><br><span class="hljs-comment"># 6              Mast Normal 0.001037386</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> Var2<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> stratum <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> alluvium <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_flow<span class="hljs-punctuation">(</span>stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;alluvium&quot;</span><span class="hljs-punctuation">,</span> lode.guidance <span class="hljs-operator">=</span> <span class="hljs-string">&quot;frontback&quot;</span><span class="hljs-punctuation">,</span> curve_type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;linear&quot;</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_stratum<span class="hljs-punctuation">(</span>alpha <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  <span class="hljs-comment"># geom_text(aes(label = Prop),position = position_stack(vjust = .5),size =3.5, color = &#x27;black&#x27;) +</span><br>  theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  guides<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  <span class="hljs-comment"># scale_x_discrete(expand = c(0.04,0))+</span><br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;% Fraction&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1.3, linetype = &quot;solid&quot;),</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 90, hjust = 1, vjust = 0.5),</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 45, hjust = 1, vjust = 1),</span><br>    axis.ticks.y <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.length.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  scale_fill_manual<span class="hljs-punctuation">(</span>values<span class="hljs-operator">=</span>cols<span class="hljs-punctuation">)</span><br><br>num <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>num<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_bar<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#1B9E77&quot;</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;identity&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Cell Num&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span><br>    axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1, linetype = &quot;solid&quot;),</span><br>    axis.ticks.length <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.3</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 合并图片</span><br>p3 <span class="hljs-operator">&lt;-</span> p1 <span class="hljs-operator">+</span> p2 <span class="hljs-operator">+</span> patchwork<span class="hljs-operator">::</span>plot_layout<span class="hljs-punctuation">(</span>nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> heights <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span><span class="hljs-string">&quot;001_大群celltype_group_barplot05.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p3<span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span><span class="hljs-string">&#x27;white&#x27;</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h2 id="绘制基因表达小提琴图"><a href="#绘制基因表达小提琴图" class="headerlink" title="绘制基因表达小提琴图"></a>绘制基因表达小提琴图</h2><blockquote><p> 参考<a href="https://mp.weixin.qq.com/s/3jU3N1M_tVvFqFdcDsvDvg">https://mp.weixin.qq.com/s/3jU3N1M_tVvFqFdcDsvDvg</a></p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dpyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggpubr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggsignif<span class="hljs-punctuation">)</span><br><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/GSE161529&#x27;</span><span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">&lt;-</span> qread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;001_大群Harmony.qs&#x27;</span><span class="hljs-punctuation">)</span><br>scRNA<br><span class="hljs-comment">#  scRNA</span><br><span class="hljs-comment"># An object of class Seurat</span><br><span class="hljs-comment"># 25503 features across 261720 samples within 1 assay</span><br><span class="hljs-comment"># Active assay: RNA (25503 features, 2000 variable features)</span><br><span class="hljs-comment">#  3 layers present: counts, data, scale.data</span><br><span class="hljs-comment">#  6 dimensional reductions calculated: pca, harmony, umap, BBKNNpca, BBKNNUMAP2D, BBKNNUMAP3D</span><br><br><span class="hljs-comment">## 查看基因ZMIZ1的表达</span><br>scRNA<span class="hljs-operator">$</span>group1 <span class="hljs-operator">&lt;-</span> paste0<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><br>p <span class="hljs-operator">&lt;-</span> VlnPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;group1&#x27;</span><span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;ZMIZ1&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">log</span> <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>p<span class="hljs-operator">$</span>data<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                                  ZMIZ1                     ident</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGAGCAAATCA-1 1.0068548       Fibroblasts--Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGAGGATATAC-1 0.9971765          Myeloids--Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCAACACCTA-1 1.0018156       Fibroblasts--Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCACCGCTAG-1 1.0031643     Keratinocytes--Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCAGGGTTAG-1 1.0020213 Endothelial_cells--Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCAGTGGAGT-1 0.9994694  Epithelial cells--Normal</span><br>ZMIZ1_exp <span class="hljs-operator">&lt;-</span> p<span class="hljs-operator">$</span>data <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>mutate<span class="hljs-punctuation">(</span><br>    celltype <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>ident<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    group <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>ident<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">)</span><br>max_ <span class="hljs-operator">=</span> <span class="hljs-built_in">max</span><span class="hljs-punctuation">(</span>ZMIZ1_exp<span class="hljs-operator">$</span>ZMIZ1<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">max</span><span class="hljs-punctuation">(</span>ZMIZ1_exp<span class="hljs-operator">$</span>ZMIZ1<span class="hljs-punctuation">)</span><span class="hljs-operator">/</span><span class="hljs-number">3</span> <br>head<span class="hljs-punctuation">(</span>ZMIZ1_exp<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                                   ZMIZ1                     ident          celltype  group</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGAGCAAATCA-1 1.0068548       Fibroblasts--Normal       Fibroblasts Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGAGGATATAC-1 0.9971765          Myeloids--Normal          Myeloids Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCAACACCTA-1 1.0018156       Fibroblasts--Normal       Fibroblasts Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCACCGCTAG-1 1.0031643     Keratinocytes--Normal     Keratinocytes Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCAGGGTTAG-1 1.0020213 Endothelial_cells--Normal Endothelial_cells Normal</span><br><span class="hljs-comment"># B1-KCF0894_AAACCTGCAGTGGAGT-1 0.9994694  Epithelial cells--Normal  Epithelial cells Normal</span><br><br>df1_cmp <span class="hljs-operator">&lt;-</span> combn<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>ZMIZ1_exp<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> simplify <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span> <br><br>p1 <span class="hljs-operator">&lt;-</span> ggviolin<span class="hljs-punctuation">(</span>ZMIZ1_exp<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ZMIZ1&quot;</span> <span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">,</span> <br>    palette <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;#E4D1DA&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#3B995A&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#FCBD6F&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#82c87e&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;#cdb0db&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend <span class="hljs-operator">=</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-comment">#不展示图例</span><br>    font.x <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span>font.y <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span><br>    x.text.angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span> y.text.angle <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span><br>    font.tickslab <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;plain&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    add <span class="hljs-operator">=</span> <span class="hljs-string">&quot;boxplot&quot;</span><span class="hljs-punctuation">,</span> add.params <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>width <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span>linetype <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span>  <br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>y <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>title<span class="hljs-operator">=</span><span class="hljs-string">&quot;ZMIZ1 Expression&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span>  <span class="hljs-comment">#设置图片标题，不展示横、纵轴的标题 </span><br>  theme<span class="hljs-punctuation">(</span>plot.title<span class="hljs-operator">=</span>element_text<span class="hljs-punctuation">(</span>hjust<span class="hljs-operator">=</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#图片标题居中</span><br>    size<span class="hljs-operator">=</span><span class="hljs-number">25</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> <span class="hljs-comment">#设置图片标题字体大小</span><br>  geom_signif<span class="hljs-punctuation">(</span>  <span class="hljs-comment">#添加显著性标记</span><br>    comparisons <span class="hljs-operator">=</span> df1_cmp <span class="hljs-punctuation">,</span><span class="hljs-comment">#指定比较对象</span><br>    map_signif_level <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span> <span class="hljs-punctuation">,</span>  <span class="hljs-comment">#指定显著性差异表示方式，布尔型变量，如果为TRUE，就用***形式来展示显著性差异，&quot;***&quot;=0.001, &quot;**&quot;=0.01, &quot;*&quot;=0.05</span><br>    textsize <span class="hljs-operator">=</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">,</span> <span class="hljs-comment">#标记文字的大小  </span><br>    test <span class="hljs-operator">=</span> t.test<span class="hljs-punctuation">,</span> <span class="hljs-comment">#指定检验方法  含wilcox.test、 t.test</span><br>    step_increase <span class="hljs-operator">=</span> <span class="hljs-number">0.2</span> <span class="hljs-punctuation">,</span> <span class="hljs-comment">#多个组时，差异标注的距离 </span><br>    size <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-punctuation">,</span> <span class="hljs-comment">#标记线条的粗线</span><br>    tip_length <span class="hljs-operator">=</span> <span class="hljs-number">0.00</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">#标记短竖线的长度</span><br>    y_position <span class="hljs-operator">=</span> max_<span class="hljs-comment">#标记在纵轴方向上的位置</span><br>  <span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename<span class="hljs-operator">=</span><span class="hljs-string">&quot;ZMIZ1表达小提琴图.png&quot;</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span>bg<span class="hljs-operator">=</span><span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span>plot<span class="hljs-operator">=</span>p1<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><blockquote><p>堆叠柱形图添加分面</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs R">scRNA<span class="hljs-operator">$</span>group1 <span class="hljs-operator">&lt;-</span>paste0<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>sample<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><br>prop <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>prop.table<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>group1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> margin <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>mutate<span class="hljs-punctuation">(</span><br>    sample <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>Var2<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    group <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>Var2<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                Var1               Var2         Freq     sample  group</span><br><span class="hljs-comment"># 1           B cells B1-KCF0894--Normal 0.0002835673 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 2 Endothelial_cells B1-KCF0894--Normal 0.1811994896 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 3  Epithelial cells B1-KCF0894--Normal 0.2549269814 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 4       Fibroblasts B1-KCF0894--Normal 0.3387211116 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 5     Keratinocytes B1-KCF0894--Normal 0.1959449879 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 6              Mast B1-KCF0894--Normal 0.0000000000 B1-KCF0894 Normal</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> sample<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> stratum <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> alluvium <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_flow<span class="hljs-punctuation">(</span>stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;alluvium&quot;</span><span class="hljs-punctuation">,</span> lode.guidance <span class="hljs-operator">=</span> <span class="hljs-string">&quot;frontback&quot;</span><span class="hljs-punctuation">,</span> curve_type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;linear&quot;</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_stratum<span class="hljs-punctuation">(</span>alpha <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  facet_grid<span class="hljs-punctuation">(</span>cols <span class="hljs-operator">=</span> vars<span class="hljs-punctuation">(</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> scales <span class="hljs-operator">=</span> <span class="hljs-string">&quot;free&quot;</span><span class="hljs-punctuation">,</span> space <span class="hljs-operator">=</span> <span class="hljs-string">&quot;free_x&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">switch</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;y&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  <span class="hljs-comment"># geom_text(aes(label = Prop),position = position_stack(vjust = .5),size =3.5, color = &#x27;black&#x27;) +</span><br>  theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  guides<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  <span class="hljs-comment"># scale_x_discrete(expand = c(0.04,0))+</span><br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;% Fraction&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1.3, linetype = &quot;solid&quot;),</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    strip.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size<span class="hljs-operator">=</span><span class="hljs-number">26</span><span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><br>    axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 45, hjust = 1, vjust = 1),</span><br>    axis.ticks.y <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.length.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.text.x = element_blank(),</span><br>    axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.ticks.x = element_blank(),</span><br>    axis.ticks.x <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  scale_fill_manual<span class="hljs-punctuation">(</span>values<span class="hljs-operator">=</span>cols<span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span><span class="hljs-string">&quot;001_大群celltype_sample_barplot05.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span><span class="hljs-number">12</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span><span class="hljs-number">30</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span><span class="hljs-string">&#x27;white&#x27;</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h2 id="基因表达热图"><a href="#基因表达热图" class="headerlink" title="基因表达热图"></a>基因表达热图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>reshape2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>pheatmap<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br><br>df <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>AverageExpression<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;ZMIZ1&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;group1&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>RNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>  tibble<span class="hljs-operator">::</span>rownames_to_column<span class="hljs-punctuation">(</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&quot;id&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>mutate<span class="hljs-punctuation">(</span><br>    group <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>id<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>celltype <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>id<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>df<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                        id         V1  group          celltype</span><br><span class="hljs-comment"># 1             B cells--ER 0.17667747     ER           B cells</span><br><span class="hljs-comment"># 2           B cells--HER2 0.18120575   HER2           B cells</span><br><span class="hljs-comment"># 3         B cells--Normal 0.04827443 Normal           B cells</span><br><span class="hljs-comment"># 4           B cells--TNBC 0.20381065   TNBC           B cells</span><br><span class="hljs-comment"># 5   Endothelial_cells--ER 0.52126445     ER Endothelial_cells</span><br><span class="hljs-comment"># 6 Endothelial_cells--HER2 0.62714383   HER2 Endothelial_cells</span><br>df_wide <span class="hljs-operator">&lt;-</span> df <span class="hljs-operator">%&gt;%</span> reshape2<span class="hljs-operator">::</span>dcast<span class="hljs-punctuation">(</span>formula <span class="hljs-operator">=</span> group <span class="hljs-operator">~</span> celltype<span class="hljs-punctuation">,</span>value.var <span class="hljs-operator">=</span> <span class="hljs-string">&quot;V1&quot;</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>df_wide<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># group    B cells Endothelial_cells Epithelial cells Fibroblasts Keratinocytes       Mast  Myeloids NK &amp; T cells Plasma cells</span><br><span class="hljs-comment"># 1     ER 0.17667747         0.5212645        0.2526222   0.2562211     0.3123442 0.32431504 0.4142069   0.13477953   0.04660333</span><br><span class="hljs-comment"># 2   HER2 0.18120575         0.6271438        0.3019049   0.3208310     0.3266427 0.09547035 0.5217586   0.12057314   0.04055066</span><br><span class="hljs-comment"># 3 Normal 0.04827443         0.1931201        0.1239252   0.1924241     0.1553375 0.57521921 0.6081140   0.05909824   0.07063725</span><br><span class="hljs-comment"># 4   TNBC 0.20381065         0.4501615        0.2159520   0.2751541     0.2805559 0.16909132 0.6156822   0.16884603   0.06142252</span><br>df_wide <span class="hljs-operator">&lt;-</span> as.matrix<span class="hljs-punctuation">(</span>df_wide <span class="hljs-operator">%&gt;%</span> tibble<span class="hljs-operator">::</span>column_to_rownames<span class="hljs-punctuation">(</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>png<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./ZMIZ1表达热图.png&#x27;</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span>units <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;in&#x27;</span><span class="hljs-punctuation">,</span>res <span class="hljs-operator">=</span> <span class="hljs-number">300</span><span class="hljs-punctuation">)</span><br>pheatmap<span class="hljs-operator">::</span>pheatmap<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>df_wide<span class="hljs-punctuation">[</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Normal&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ER&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HER2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TNBC&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    sacle<span class="hljs-operator">=</span><span class="hljs-string">&quot;column&quot;</span><span class="hljs-punctuation">,</span><br>    cluster_rows<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><br>    cluster_cols<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><br>    fontsize <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span><br>    main <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ZMIZ1 Average Expression(scale column)&quot;</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_ce4cec6263eb743cfa612a5e1c4f3aa3.png"></p><h2 id="计算celltype组织偏好性-Odd-Ratio"><a href="#计算celltype组织偏好性-Odd-Ratio" class="headerlink" title="计算celltype组织偏好性(Odd Ratio)"></a>计算celltype组织偏好性(Odd Ratio)</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>plyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>data.table<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>tidyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>pheatmap<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">## 计算OR值***********************************************************</span><br>Caculate.OR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span>loc<span class="hljs-punctuation">,</span>celltype<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span>inherits<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Seurat&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>      stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;input file is not Seurat Object, Please check!&quot;</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-comment"># 计算不同组织中不同细胞类型的细胞量</span><br>  count.dist.melt.tb <span class="hljs-operator">&lt;-</span>             as.data.frame<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>loc<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  colnames<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;cid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;count&#x27;</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.tb<span class="hljs-operator">$</span>rid <span class="hljs-operator">&lt;-</span> unfactor<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-operator">$</span>rid<span class="hljs-punctuation">)</span><br>  count.dist.melt.tb<span class="hljs-operator">$</span>cid <span class="hljs-operator">&lt;-</span> unfactor<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-operator">$</span>cid<span class="hljs-punctuation">)</span><br>  sum.col <span class="hljs-operator">&lt;-</span> table<span class="hljs-punctuation">(</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>loc<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>  sum.row <span class="hljs-operator">&lt;-</span> table<span class="hljs-punctuation">(</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb <span class="hljs-operator">&lt;-</span><br>    as.data.table<span class="hljs-punctuation">(</span>ldply<span class="hljs-punctuation">(</span><span class="hljs-built_in">seq_len</span><span class="hljs-punctuation">(</span>nrow<span class="hljs-punctuation">(</span><br>      count.dist.melt.tb<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>      this.row <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>rid<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>      this.col <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>cid<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>      this.c <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>count<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>      other.col.c <span class="hljs-operator">&lt;-</span> sum.col<span class="hljs-punctuation">[</span>this.col<span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span> this.c<br>      this.m <span class="hljs-operator">&lt;-</span> matrix<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><br>          this.c<span class="hljs-punctuation">,</span><br>          sum.row<span class="hljs-punctuation">[</span>this.row<span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span> this.c<span class="hljs-punctuation">,</span><br>          other.col.c<span class="hljs-punctuation">,</span><br>          <span class="hljs-built_in">sum</span><span class="hljs-punctuation">(</span>sum.col<span class="hljs-punctuation">)</span> <span class="hljs-operator">-</span> sum.row<span class="hljs-punctuation">[</span>this.row<span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span> other.col.c<br>      <span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>      ncol <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br>      res.test <span class="hljs-operator">&lt;-</span> fisher.test<span class="hljs-punctuation">(</span>this.m<span class="hljs-punctuation">)</span><br>      data.frame<span class="hljs-punctuation">(</span><br>          rid <span class="hljs-operator">=</span> this.row<span class="hljs-punctuation">,</span><br>          cid <span class="hljs-operator">=</span> this.col<span class="hljs-punctuation">,</span><br>          p.value <span class="hljs-operator">=</span> res.test<span class="hljs-operator">$</span>p.value<span class="hljs-punctuation">,</span><br>          OR <span class="hljs-operator">=</span> res.test<span class="hljs-operator">$</span>estimate<br>      <span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> adj.p.value <span class="hljs-operator">:=</span> p.adjust<span class="hljs-punctuation">(</span>p.value<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;BH&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>as.data.frame<span class="hljs-punctuation">(</span>count.dist.melt.ext.tb<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>or <span class="hljs-operator">&lt;-</span> Caculate.OR<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>loc <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">,</span>celltype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 绘制OR值热图***********************************************</span><br>Plot_OR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  test <span class="hljs-operator">&lt;-</span> pivot_wider<span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span><br>      names_from <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;cid&#x27;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment"># 指定哪些列的值应该变成新列的名称</span><br>      values_from <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OR&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 指定哪些列的值应该填充到新列中</span><br>      id_cols <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;rid&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">-&gt;</span> test2<br>  test <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>test<span class="hljs-punctuation">)</span><br>  test2 <span class="hljs-operator">=</span> test2 <span class="hljs-operator">%&gt;%</span> tibble<span class="hljs-operator">::</span>column_to_rownames<span class="hljs-punctuation">(</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;rid&#x27;</span><span class="hljs-punctuation">)</span><br>  p1 <span class="hljs-operator">&lt;-</span> pheatmap<span class="hljs-punctuation">(</span>test2<span class="hljs-punctuation">,</span> <br>      scale <span class="hljs-operator">=</span> <span class="hljs-string">&quot;row&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 按行归一化，查看因子在不同样本中的分布情况</span><br>      cluster_cols <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> clustering_distance_rows <span class="hljs-operator">=</span> <span class="hljs-string">&quot;correlation&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#取消列聚类，表示行聚类使用皮尔森相关系数聚类</span><br>      treeheight_row <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置行聚类树高</span><br>      cutree_rows <span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#根据样品列聚类情况将热图的行方向隔开为3份</span><br>      cellwidth <span class="hljs-operator">=</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>cellheight <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置热图方块宽度和高度</span><br>      fontsize_number <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#热图上数值的字体大小</span><br>      number_color<span class="hljs-operator">=</span><span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#热图上数值的字体颜色</span><br>      display_numbers <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>      main<span class="hljs-operator">=</span><span class="hljs-string">&quot;OR(odds ratios)&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置图形标题</span><br>      show_colnames <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置行列标签的显示</span><br>      show_rownames <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span><br>      border<span class="hljs-operator">=</span><span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> <br>      legend <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># FALSE去除图例; T显示图例</span><br>      <span class="hljs-comment"># legend_breaks=c(0,0.5,1,1.5,2,2.5,3), # 设置图例的范围</span><br>      fontsize_row <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 分别设置行列标签字体大小</span><br>      fontsize_col <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>      angle_col <span class="hljs-operator">=</span> <span class="hljs-string">&quot;45&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置标签显示角度</span><br>        <span class="hljs-punctuation">)</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment"># 绘图</span><br>png<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./OR值热图.png&#x27;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> unit<span class="hljs-operator">=</span><span class="hljs-string">&#x27;in&#x27;</span><span class="hljs-punctuation">,</span> res<span class="hljs-operator">=</span><span class="hljs-number">300</span><span class="hljs-punctuation">)</span> <br>Plot_OR<span class="hljs-punctuation">(</span>or<span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>自定义模块</title>
    <link href="/2024/06/02/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97/"/>
    <url>/2024/06/02/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="自定义模块的调用"><a href="#自定义模块的调用" class="headerlink" title="自定义模块的调用"></a>自定义模块的调用</h1><p><strong>__name__</strong></p><p>在定义在自定义模块后，在其他程序中引入这个自定义模块后，如果不加入”if _<em>name</em>_ &#x3D;&#x3D; “_<em>main</em><em>“,防止模块中的测试代码被执行。当一个python模块被导入时，__name__会被设置为模块的名称，如果直接执行__name__会被设置成__main__。如果当钱文件的__name__的值为</em>__name__的时候才会被执行。</p><blockquote><p>建立一个a.py文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(__name__)<br></code></pre></td></tr></table></figure><p>运行该程序，则会输出__main__。</p><blockquote><p>如果再建立一个b.py 导入a.py再运行程序</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> a<br></code></pre></td></tr></table></figure><p>运行这个程序的时候，输出为oop01，此时a.py文件中的print(__name__)输出的是a.py文件的名称。</p><p><strong>__all__</strong></p><p>__all__可以设置自定义模块中那些函数可以被其他程序导入。但是这个也有限制，如果是使用 from model import *的方式，程序中设置的__all__限制是起作用的，但是如果是import model的方式导入模块，则不受__all__的限制。</p><blockquote><p>建立一个a1.py文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">h1</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hi&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ok</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>建立一个b1.py文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> a1<br><br>a1.h1()<br>a1.ok()<br></code></pre></td></tr></table></figure><p>运行b1.py文件，结果如下。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_37f4c796ddf0af6e6c630ec7f43a5e00.png"></p><p><strong>如果使用__all__进行限制</strong></p><blockquote><p>在a1.py文件中添加一行带代码</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">h1</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hi&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ok</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br> <br>__all__ = [<span class="hljs-string">&quot;ok&quot;</span>]  <span class="hljs-comment"># 这里只运行ok函数可以通过使用</span><br></code></pre></td></tr></table></figure><blockquote><p>修该b1.py文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> a1 <span class="hljs-keyword">import</span> *<br><br>hi()  <span class="hljs-comment"># 此时的h1函数不能使用</span><br>ok()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python面相对象</title>
    <link href="/2024/06/02/python%E9%9D%A2%E7%9B%B8%E5%AF%B9%E8%B1%A1/"/>
    <url>/2024/06/02/python%E9%9D%A2%E7%9B%B8%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="面向对象编程01"><a href="#面向对象编程01" class="headerlink" title="面向对象编程01"></a>面向对象编程01</h1><blockquote><p>问题提出：</p></blockquote><p>张老太养了两只猫，一只小白，今年3岁，白色。一只小花，今年8岁，花色。</p><p>【1】请编写一个程序，当用户输入小猫的名字的时候，显示该猫的名字，年龄和颜色</p><p>【2】但输入的小猫名字错误的时候则显示张老太没有这只猫猫。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用字典键值对的方式</span><br>cats = &#123;<span class="hljs-string">&quot;小白&quot;</span>: &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;小白&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&quot;color&quot;</span>: <span class="hljs-string">&quot;white&quot;</span>&#125;, <span class="hljs-string">&quot;小花&quot;</span>: &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;小花&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">8</span>, <span class="hljs-string">&quot;color&quot;</span>: <span class="hljs-string">&quot;花色&quot;</span>&#125;&#125;<br>name = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入小猫的名字: &quot;</span>)<br><span class="hljs-keyword">if</span> name <span class="hljs-keyword">in</span> cats.keys():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;小猫的名字:<span class="hljs-subst">&#123;cats[name][<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>\n小猫的年龄: <span class="hljs-subst">&#123;cats[name][<span class="hljs-string">&#x27;age&#x27;</span>]&#125;</span>\n小猫的颜色: <span class="hljs-subst">&#123;cats[name][<span class="hljs-string">&#x27;color&#x27;</span>]&#125;</span>&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;张老太没有叫<span class="hljs-subst">&#123;name&#125;</span>的小猫&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_7e6e15147615be8ad58ad89c4832eed7.png"></p><blockquote><p>存在问题：上面的字典只能保存小猫的属性，但是无法关联小猫的行为（动作）。</p></blockquote><p><strong>类可以将对象的属性和方法绑定在一起，扩增对象的功能</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br>    name = <span class="hljs-literal">None</span><br>    age = <span class="hljs-literal">None</span><br>    color = <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># 实例化对象</span><br>cat1 = Cat()<br>cat1.name = <span class="hljs-string">&quot;小白&quot;</span><br>cat1.age = <span class="hljs-number">3</span><br>cat1.color = <span class="hljs-string">&quot;white&quot;</span><br><br>cat2 = Cat()<br>cat2.name = <span class="hljs-string">&quot;小花&quot;</span><br>cat2.age = <span class="hljs-number">8</span><br>cat2.color = <span class="hljs-string">&quot;花色&quot;</span><br><br><span class="hljs-comment"># 打印信息</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;cat1的名字<span class="hljs-subst">&#123;cat1.name&#125;</span>,年龄<span class="hljs-subst">&#123;cat1.age&#125;</span>,颜色<span class="hljs-subst">&#123;cat1.color&#125;</span>&quot;</span>)<br><span class="hljs-comment">#cat1的名字小白,年龄3,颜色white</span><br></code></pre></td></tr></table></figure><blockquote><p>oop的方式可以更好的管理小猫的属性</p></blockquote><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_5c1b201761e8c82fe835360c8adf717e.png"></p><h3 id="对象的布尔值"><a href="#对象的布尔值" class="headerlink" title="对象的布尔值"></a>对象的布尔值</h3><p>一下的对象值都是False</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-----下面对象的布尔值------&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(<span class="hljs-literal">False</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(<span class="hljs-number">0</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(<span class="hljs-literal">None</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(<span class="hljs-string">&quot;&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>([]))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(()))  <span class="hljs-comment"># 空元组</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(&#123;&#125;))  <span class="hljs-comment"># 空字典</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bool</span>(<span class="hljs-built_in">set</span>()))  <span class="hljs-comment"># 空集合</span><br></code></pre></td></tr></table></figure><h3 id="成员方法"><a href="#成员方法" class="headerlink" title="成员方法"></a>成员方法</h3><p>类中定义的行为(函数)，称为成员方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Func</span>(<span class="hljs-params">self,参数列表</span>):<br>    方法体<br></code></pre></td></tr></table></figure><ul><li>在方法定义参数列表时，需要添加self</li><li>self在定义成员方法的时候需要写上</li><li>self表示当前对象本身，有点类似js中的this</li><li>在通过对象调用方法的时候，self会隐式传入</li><li>在方法内部需要使用self才能访问到成员变量</li></ul><blockquote><p>问题提出</p></blockquote><p>【1】定义一个Person类，有name和age属性，完成如下的要求</p><p>【2】添加hi成员方法，输出“hi python”</p><p>【3】添加cal01成员方法，计算1+..+1000的结果</p><p>【4】添加cal02成员方法，该方法可以接收一个数n，计算从1+..+n的结果</p><p>【5】添加get_sum成员方法，计算两个数的和，并返回</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    name = <span class="hljs-literal">None</span><br>    age = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hi</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hi pyhton&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cal01</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>        i = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> i &lt;= <span class="hljs-number">100</span>:<br>            <span class="hljs-built_in">sum</span> += i<br>            i += <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">sum</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cal02</span>(<span class="hljs-params">self, n</span>):<br>        <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>        i = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> i &lt;= n:<br>            <span class="hljs-built_in">sum</span> += i<br>            i += <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">sum</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sum</span>(<span class="hljs-params">self, num1, num2</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;两个数的和为<span class="hljs-subst">&#123;num1 + num2&#125;</span>&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    person = Person()<br>    person.name = <span class="hljs-string">&quot;小明&quot;</span><br>    person.age = <span class="hljs-number">20</span><br>    person.hi()<br>    person.cal01()<br>    person.cal02(n=<span class="hljs-number">10</span>)<br>    person.get_sum(num1=<span class="hljs-number">10</span>, num2=<span class="hljs-number">20</span>)<br><br><span class="hljs-comment"># 输出结果</span><br><span class="hljs-comment"># hi pyhton</span><br><span class="hljs-comment"># 5050</span><br><span class="hljs-comment"># 55</span><br><span class="hljs-comment"># 两个数的和为30</span><br></code></pre></td></tr></table></figure><blockquote><p>动态的给对象添加方法</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;this is a test&quot;</span><br>person.test = test <span class="hljs-comment"># 动态的给当前的对象person添加方法test</span><br><span class="hljs-built_in">print</span>(person.test()) <span class="hljs-comment"># this is a test</span><br></code></pre></td></tr></table></figure><h3 id="self"><a href="#self" class="headerlink" title="self"></a>self</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br>    name = <span class="hljs-string">&quot;加菲猫&quot;</span><br>    age = <span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;name的信息为: <span class="hljs-subst">&#123;name&#125;</span>&quot;</span>)<br><br><br>cat = Cat()<br>cat.info(name=<span class="hljs-string">&quot;波斯猫&quot;</span>) <span class="hljs-comment"># 输出：name的信息为: 波斯猫</span><br></code></pre></td></tr></table></figure><blockquote><p>如果添加上self呢？</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br>    name = <span class="hljs-string">&quot;加菲猫&quot;</span><br>    age = <span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;name的信息为: <span class="hljs-subst">&#123;self.name&#125;</span>&quot;</span>)<br><br><br>cat = Cat()<br>cat.info(name=<span class="hljs-string">&quot;波斯猫&quot;</span>) <span class="hljs-comment">#输出结果：name的信息为: 加菲猫</span><br></code></pre></td></tr></table></figure><p>在对象中定义方法的时候，需要在函数中添加self参数，如果不想添加self参数，可以使用静态方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br>    name = <span class="hljs-string">&quot;加菲猫&quot;</span><br>    age = <span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;name的信息为: <span class="hljs-subst">&#123;self.name&#125;</span>&quot;</span>)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;this is a static test&quot;</span>)<br><br><br>cat = Cat()<br>cat.info(name=<span class="hljs-string">&quot;波斯猫&quot;</span>)<br>cat.test()  <span class="hljs-comment"># 使用对象调用静态方法</span><br>Cat.test()  <span class="hljs-comment"># 使用类调用静态方法</span><br></code></pre></td></tr></table></figure><p>那么对象和self之间的关系是什么呢？那个对象调用，self就指向那个对象。<strong>self是隐式传入函数中</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;self的地址<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(self)&#125;</span>&quot;</span>)<br><br><br>dog = Dog()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;dog对象的地址<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(dog)&#125;</span>&quot;</span>)<br>dog.test()<br><span class="hljs-comment">#dog对象的地址3123093511760</span><br><span class="hljs-comment">#self的地址3123093511760</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>:<br>    name = <span class="hljs-string">&quot;藏獒&quot;</span><br>    age = <span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">eat</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.name&#125;</span>饿了&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cry</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span> is crying&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.name&#125;</span> is crying&quot;</span>)<br>        self.eat()<br><br><br>dog = Dog()<br>dog.cry(<span class="hljs-string">&quot;金毛&quot;</span>)<br><span class="hljs-comment">#金毛 is crying</span><br><span class="hljs-comment">#藏獒 is crying</span><br><span class="hljs-comment">#藏獒饿了</span><br><br>dog = Dog()<br><span class="hljs-comment"># dog.cry(&quot;金毛&quot;)</span><br>dog.name = <span class="hljs-string">&quot;中华田园犬&quot;</span><br>dog.cry(<span class="hljs-string">&quot;金毛&quot;</span>)<br><span class="hljs-comment"># 金毛 is crying</span><br><span class="hljs-comment"># 中华田园犬 is crying</span><br><span class="hljs-comment"># 中华田园犬饿了</span><br></code></pre></td></tr></table></figure><blockquote><p>练习</p></blockquote><p>【1】定义一个person类</p><p>【2】里面有name，age属性</p><p>【3】并提供compare_to比较方法，用于判断是否和另一个人相等</p><p>【4】名字和年龄都相等则返回True否则返回False</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    name = <span class="hljs-string">&quot;小明&quot;</span><br>    age = <span class="hljs-number">12</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_to</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">if</span> self.name == other.name <span class="hljs-keyword">and</span> self.age == other.age:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br>p1 = Person()<br>p2 = Person()<br>p2.name = <span class="hljs-string">&quot;小花&quot;</span><br>p2.age = <span class="hljs-number">24</span><br><span class="hljs-built_in">print</span>(p1.compare_to(p2)) <span class="hljs-comment"># False</span><br></code></pre></td></tr></table></figure><p>也可以编写添加构造器的版本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):<br>        self.name = name<br>        self.age = age<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_to</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">if</span> self.name == other.name <span class="hljs-keyword">and</span> self.age == other.age:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br>p1 = Person(name=<span class="hljs-string">&quot;xiao&quot;</span>, age=<span class="hljs-number">20</span>)<br>p2 = Person(name=<span class="hljs-string">&quot;xiao&quot;</span>, age=<span class="hljs-number">20</span>)<br><span class="hljs-built_in">print</span>(p1.compare_to(p2))  <span class="hljs-comment"># True</span><br></code></pre></td></tr></table></figure><h3 id="对象的传参机制"><a href="#对象的传参机制" class="headerlink" title="对象的传参机制"></a>对象的传参机制</h3><p>可以看出下面例子中p1的内存地址并没有发生改变。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    name = <span class="hljs-literal">None</span><br>    age = <span class="hljs-literal">None</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">person</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;peeson的地址<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(person)&#125;</span>&quot;</span>)<br>    person.name = <span class="hljs-string">&quot;json&quot;</span><br>    person.age += <span class="hljs-number">1</span><br><br><br>p1 = Person()<br>p1.name = <span class="hljs-string">&quot;joden&quot;</span><br>p1.age = <span class="hljs-number">10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;p1的地址<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(p1)&#125;</span>,p1的名字<span class="hljs-subst">&#123;p1.name&#125;</span>,p1的年龄<span class="hljs-subst">&#123;p1.age&#125;</span>&quot;</span>)<br>f(p1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;p1的地址<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(p1)&#125;</span>,p1的名字<span class="hljs-subst">&#123;p1.name&#125;</span>,p1的年龄<span class="hljs-subst">&#123;p1.age&#125;</span>&quot;</span>)<br><span class="hljs-comment">#p1的地址2267628644048,p1的名字joden,p1的年龄10</span><br><span class="hljs-comment">#peeson的地址2267628644048</span><br><span class="hljs-comment">#p1的地址2267628644048,p1的名字json,p1的年龄11</span><br></code></pre></td></tr></table></figure><h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>在面向对象编程中主要的变量就是成员变量（属性）和局部变量，局部变量一般是在成员方法中定义的变量，作用域只在成员方法中，出了成员方法没用。属性和局部变量是可以重名的，访问的时候带上self表示访问的是属性，没有带self表示访问的是局部变量。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    name = <span class="hljs-literal">None</span><br>    age = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hi</span>(<span class="hljs-params">self</span>):<br>        name = <span class="hljs-string">&quot;pipi&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;name=<span class="hljs-subst">&#123;name&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;name=<span class="hljs-subst">&#123;self.name&#125;</span>&quot;</span>)<br><br><br>p = Person()<br>p.hi()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">40</span>)<br>p.name = <span class="hljs-string">&quot;jack&quot;</span><br>p.hi()<br><span class="hljs-comment"># name=pipi</span><br><span class="hljs-comment"># name=None</span><br><span class="hljs-comment"># ----------------------------------------</span><br><span class="hljs-comment"># name=pipi</span><br><span class="hljs-comment"># name=jack</span><br></code></pre></td></tr></table></figure><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><ul><li>在初始化对象的时候会自动执行____init__</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;__init__执行&quot;</span>)<br><br><br>p1 = Person()<br>p2 = Person()<br><span class="hljs-comment"># __init__执行</span><br><span class="hljs-comment"># __init__执行</span><br></code></pre></td></tr></table></figure><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>一个类中只能写一个构造方法，即便写多个，也只有最后一个起作用。</li><li>python可以动态的生成对象属性</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,name,age</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;__init__执行了,<span class="hljs-subst">&#123;name&#125;</span>,<span class="hljs-subst">&#123;age&#125;</span>&#x27;</span>)<br>       slef.name = name<br>        self.age = age<br>p1 = Person(name=<span class="hljs-string">&quot;xiao&quot;</span>,age=<span class="hljs-number">13</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;p1的name<span class="hljs-subst">&#123;p1.name&#125;</span>,p1的age<span class="hljs-subst">&#123;p1.age&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><p>面相对象编程的三大特征：封装，继承，多态。</p><h4 id="封装的优点："><a href="#封装的优点：" class="headerlink" title="封装的优点："></a><strong>封装的优点：</strong></h4><p>【1】隐藏实现的细节</p><p>【2】可以对数据进行验证（例如密码），保证合理性</p><p>【3】隐私数据需要授权后才能访问</p><h4 id="私有变量"><a href="#私有变量" class="headerlink" title="私有变量"></a>私有变量</h4><p>类中的变量或者方法是以双下滑线开头命名，则该变量或者方法是私有的，私有的变量或者方法只能在本类中使用，类的外部无法使用。</p><p>并不代表是有变量就不能访问，入下例子，可以通过其他方式访问到私有变量或者方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>: <br>    __salary = <span class="hljs-number">3000</span> <span class="hljs-comment"># 定义了一个私有变量</span><br><br><br>p1 = Person()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">dir</span>(p1))<br><span class="hljs-comment">#[&#x27;_Person__salary&#x27;, &#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__getstate__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;]</span><br><br><span class="hljs-built_in">print</span>(p1._Person__salary) <span class="hljs-comment"># 3000 </span><br></code></pre></td></tr></table></figure><blockquote><p>问题提出：</p><p>【1】创建职员类（Clerk）,属性有name,job,salary</p><p>【2】不能随便的查看职员的职位和工资等隐私，比如职员(“tiger”,”Python工程师”，20000)</p><p>【3】提供公共的方法，可以对职位和工资进行操作</p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Lambda表达式</title>
    <link href="/2024/06/02/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <url>/2024/06/02/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>python中lambda表达式就是定义一个匿名函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">lambda</span> 参数列表:表达式<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">anonymous</span>(<span class="hljs-params">参数列表</span>):<br><span class="hljs-keyword">return</span> 表达式<br></code></pre></td></tr></table></figure><blockquote><p>举例</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">myfun = <span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span><br>lst = [myfun(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]<br><span class="hljs-built_in">print</span>(lst)<br><span class="hljs-comment">#[0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span><br></code></pre></td></tr></table></figure><blockquote><p>无返回值的lambda函数</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用 def 定义的空函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do_nothing</span>():<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-comment"># 使用 lambda 定义的“空”函数</span><br>do_nothing_lambda = <span class="hljs-keyword">lambda</span>: <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># 调用这两个函数</span><br><span class="hljs-built_in">print</span>(do_nothing())         <span class="hljs-comment"># 输出: None</span><br><span class="hljs-built_in">print</span>(do_nothing_lambda())  <span class="hljs-comment"># 输出: None</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python数据分析</title>
    <link href="/2024/06/01/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/"/>
    <url>/2024/06/01/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="python数据分析"><a href="#python数据分析" class="headerlink" title="python数据分析"></a>python数据分析</h1><blockquote><p><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html</a></p></blockquote><h2 id="pandas"><a href="#pandas" class="headerlink" title="pandas"></a>pandas</h2><h3 id="Serirs"><a href="#Serirs" class="headerlink" title="Serirs"></a>Serirs</h3><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_3265fe24d28b1e347a37aa7b4c4735e9.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br>ser1 = pd.Series(np.random.rand(<span class="hljs-number">10</span>), index=np.random.rand(<span class="hljs-number">10</span>), copy=<span class="hljs-literal">False</span>)<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-built_in">print</span>(ser1.index)<br><span class="hljs-built_in">print</span>(ser1.values)<br>ser1.values[<span class="hljs-number">0</span>] = <span class="hljs-number">123</span><br><span class="hljs-built_in">print</span>(ser1)<br></code></pre></td></tr></table></figure><p>Series函数中的copy参数，</p><ul><li><code>copy=True</code>: 当设置为<code>True</code>时，构造<code>Series</code>对象时会对传入的数据进行深拷贝。这意味着创建的<code>Series</code>对象与原始数据是独立的，修改<code>Series</code>对象不会影响原始数据，反之亦然。</li><li><code>copy=False</code>: 当设置为<code>False</code>时，构造<code>Series</code>对象时不会进行深拷贝，而是对传入的数据进行引用。这意味着创建的<code>Series</code>对象与原始数据共享相同的内存空间，修改<code>Series</code>对象可能会影响原始数据，反之亦然。</li></ul><p>默认情况下，<code>copy</code>参数是<code>False</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><span class="hljs-comment"># 原始数据</span><br>data = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br><br><span class="hljs-comment"># 不进行复制</span><br>series_no_copy = pd.Series(data, copy=<span class="hljs-literal">False</span>)<br>series_no_copy[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Original data after modifying series_no_copy:&quot;</span>, data)<br><br><span class="hljs-comment"># 进行复制</span><br>series_copy = pd.Series(data, copy=<span class="hljs-literal">True</span>)<br>series_copy[<span class="hljs-number">1</span>] = <span class="hljs-number">200</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Original data after modifying series_copy:&quot;</span>, data)<br><span class="hljs-comment">#Original data after modifying series_no_copy: [100, 2, 3, 4, 5]</span><br><span class="hljs-comment">#Original data after modifying series_copy: [100, 2, 3, 4, 5]</span><br></code></pre></td></tr></table></figure><h4 id="Series中data参数输入为数值"><a href="#Series中data参数输入为数值" class="headerlink" title="Series中data参数输入为数值"></a>Series中data参数输入为数值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># jsut a number</span><br>ser1 = pd.Series(<span class="hljs-number">1</span>, index=[<span class="hljs-string">&#x27;A&#x27;</span>])<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-comment">#A    1</span><br><span class="hljs-comment">#dtype: int64</span><br></code></pre></td></tr></table></figure><h4 id="Series中输入为列表"><a href="#Series中输入为列表" class="headerlink" title="Series中输入为列表"></a>Series中输入为列表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">ser1 = pd.Series([i ** <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)], copy=<span class="hljs-literal">False</span>)<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-comment">#0     0</span><br><span class="hljs-comment">#1     1</span><br><span class="hljs-comment">#2     4</span><br><span class="hljs-comment">#3     9</span><br><span class="hljs-comment">#4    16</span><br><span class="hljs-comment">#dtype: int64</span><br></code></pre></td></tr></table></figure><h4 id="Series输入为字典"><a href="#Series输入为字典" class="headerlink" title="Series输入为字典"></a>Series输入为字典</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">ser1 = pd.Series(&#123;i: i**i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)&#125;)<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-comment">#0      1</span><br><span class="hljs-comment">#1      1</span><br><span class="hljs-comment">#2      4</span><br><span class="hljs-comment">#3     27</span><br><span class="hljs-comment">#4    256</span><br><span class="hljs-comment">#dtype: int64</span><br></code></pre></td></tr></table></figure><h4 id="Series输入为ndarray"><a href="#Series输入为ndarray" class="headerlink" title="Series输入为ndarray"></a>Series输入为ndarray</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ndArray</span><br>ser1 = np.ndarray(<span class="hljs-number">3</span>)<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-comment">#[0.  0.5 1. ]</span><br>ser1 = pd.Series(ser1)<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-comment">#0    0.0</span><br><span class="hljs-comment">#1    0.5</span><br><span class="hljs-comment">#2    1.0</span><br><span class="hljs-comment">#dtype: float64</span><br></code></pre></td></tr></table></figure><h3 id="设置索引值"><a href="#设置索引值" class="headerlink" title="设置索引值"></a>设置索引值</h3><p>Series中index参数默认是从0开始，也可以自己设置索引值。在Series中不能使用负数索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># index</span><br>ser1 = pd.Series([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], index=[<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>])<br><span class="hljs-built_in">print</span>(ser1)<br><span class="hljs-comment">#A    1</span><br><span class="hljs-comment">#B    2</span><br><span class="hljs-comment">#C    3</span><br><span class="hljs-comment">#D    4</span><br><span class="hljs-comment">#dtype: int64</span><br><span class="hljs-comment">#print(ser1[-1])</span><br>test = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<br><span class="hljs-built_in">print</span>(test[-<span class="hljs-number">1</span>])<br><span class="hljs-comment">#4</span><br></code></pre></td></tr></table></figure><h3 id="Series中数据查询"><a href="#Series中数据查询" class="headerlink" title="Series中数据查询"></a>Series中数据查询</h3><h4 id="通过索引位置查找数据"><a href="#通过索引位置查找数据" class="headerlink" title="通过索引位置查找数据"></a>通过索引位置查找数据</h4><p>和pyhtonlist中的索引查询一样，是左包含右不包含。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">ser1 = pd.Series(np.array(np.random.rand(<span class="hljs-number">10</span>)))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(ser1)) <span class="hljs-comment">#10</span><br><span class="hljs-built_in">print</span>(ser1[:<span class="hljs-number">5</span>])<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_2aec08072fdb1c14c6dce3d7d010375d.png"></p><h3 id="DataFrame对象"><a href="#DataFrame对象" class="headerlink" title="DataFrame对象"></a>DataFrame对象</h3><p>DataFrame是一个二维表数据结构，由行、列数据组成的表格。DataFrame既有行索引也有列索引，它可以看作是由Series对象组成的字典，不过这些Series对象共用一个索引。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_e5059041b5db319d2b37225a5762e913.png"></p><h3 id="建立DataFrame对象"><a href="#建立DataFrame对象" class="headerlink" title="建立DataFrame对象"></a>建立DataFrame对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">pandas.DataFrame(data,index,columns,dtype,copy)<br><span class="hljs-comment"># data：表示数据，可以是ndarray数组、Series对象、列表、字典等。</span><br><span class="hljs-comment"># index：表示行标签（索引）。</span><br><span class="hljs-comment"># columns：列标签（索引）。</span><br><span class="hljs-comment"># dtype：每一列数据的数据类型，其与Python数据类型有所不同，如object数据类型对应的是</span><br><span class="hljs-comment"># Python的字符型。表3.1为Pandas数据类型与Python数据类型的对应表。</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">data = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>], [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]]<br>index = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br>column = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>]<br>df = pd.DataFrame(data=data, index=index, columns=column)<br><span class="hljs-built_in">print</span>(df.head())<br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 0  1  2  3</span><br><span class="hljs-comment"># 1  4  5  6</span><br><span class="hljs-comment"># 2  7  8  9</span><br><span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> df.columns:<br>    df_sub = df[column]<br>    <span class="hljs-built_in">print</span>(df_sub)<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_8df57283634ad41f99d97415b08718b6.png"></p><h4 id="通过二维数据建立DataFrame"><a href="#通过二维数据建立DataFrame" class="headerlink" title="通过二维数据建立DataFrame"></a>通过二维数据建立DataFrame</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">data = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]]<br>df = pd.DataFrame(data=data)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#    0  1  2</span><br><span class="hljs-comment"># 0  1  2  3</span><br><span class="hljs-comment"># 1  A  B  C</span><br><span class="hljs-comment"># 2  3  4  5</span><br><span class="hljs-built_in">print</span>(df.columns)<br></code></pre></td></tr></table></figure><h4 id="通过字典创建"><a href="#通过字典创建" class="headerlink" title="通过字典创建"></a>通过字典创建</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 字典对象</span><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 0  1  4  A</span><br><span class="hljs-comment"># 1  2  5  B</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> df.columns:<br>    <span class="hljs-built_in">print</span>(df[i].dtype)<br><span class="hljs-comment"># int64</span><br><span class="hljs-comment"># int64</span><br><span class="hljs-comment"># object</span><br></code></pre></td></tr></table></figure><h4 id="DataFrame的重要属性"><a href="#DataFrame的重要属性" class="headerlink" title="DataFrame的重要属性"></a>DataFrame的重要属性</h4><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_3492e71f01153043de31e956539c6244.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(df.values)<br><span class="hljs-comment"># [[1 4 &#x27;A&#x27;]</span><br><span class="hljs-comment">#  [2 5 &#x27;B&#x27;]</span><br><span class="hljs-comment">#  [3 6 &#x27;C&#x27;]</span><br><span class="hljs-comment">#  [4 7 &#x27;D&#x27;]]</span><br><span class="hljs-built_in">print</span>(df.dtypes)<br><span class="hljs-comment"># A     int64</span><br><span class="hljs-comment"># B     int64</span><br><span class="hljs-comment"># C    object</span><br><span class="hljs-comment"># dtype: object</span><br><span class="hljs-built_in">print</span>(df.index)<br><span class="hljs-comment"># RangeIndex(start=0, stop=4, step=1)</span><br><span class="hljs-built_in">print</span>(df.columns)<br><span class="hljs-comment"># Index([&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;], dtype=&#x27;object&#x27;)</span><br><span class="hljs-built_in">print</span>(df.T)<br><span class="hljs-comment">#    0  1  2  3</span><br><span class="hljs-comment"># A  1  2  3  4</span><br><span class="hljs-comment"># B  4  5  6  7</span><br><span class="hljs-comment"># C  A  B  C  D</span><br><span class="hljs-built_in">print</span>(df.info)<br><span class="hljs-comment"># &lt;bound method DataFrame.info of    A  B  C</span><br><span class="hljs-comment"># 0  1  4  A</span><br><span class="hljs-comment"># 1  2  5  B</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_27f6d2d6893386ab000c827849fa5b4b.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(df.<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">0</span>)) <span class="hljs-comment"># axis=0计算列和，axis=1计算行和</span><br><span class="hljs-built_in">print</span>(df.<span class="hljs-built_in">max</span>())<br><span class="hljs-comment"># A    4</span><br><span class="hljs-comment"># B    7</span><br><span class="hljs-comment"># C    D</span><br><span class="hljs-comment"># dtype: object</span><br></code></pre></td></tr></table></figure><h4 id="导入外部数据"><a href="#导入外部数据" class="headerlink" title="导入外部数据"></a>导入外部数据</h4><ul><li>导入.xls或.xlsx文件主要使用Pandas的read_excel()方法</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">pandas.read_excel(io,sheet_name=<span class="hljs-number">0</span>,header=<span class="hljs-number">0</span>,names=<span class="hljs-literal">None</span>,index_col=<span class="hljs-literal">None</span>,usecols=<span class="hljs-literal">None</span>,squeeze=Fa<br>dtype=<span class="hljs-literal">None</span>,engine=<span class="hljs-literal">None</span>,converters=<span class="hljs-literal">None</span>,true_values=<span class="hljs-literal">None</span>,false_values=<span class="hljs-literal">None</span>,skiprows=<span class="hljs-literal">None</span>,nrow<br>na_values=<span class="hljs-literal">None</span>,keep_default_na=<span class="hljs-literal">True</span>,verbose=<span class="hljs-literal">False</span>,parse_dates=<span class="hljs-literal">False</span>,date_parser=<span class="hljs-literal">None</span>,thousan<br>comment=<span class="hljs-literal">None</span>,skipfooter=<span class="hljs-number">0</span>,conver_float=<span class="hljs-literal">True</span>,mangle_dupe_cols=<span class="hljs-literal">True</span>,**kwds)<br></code></pre></td></tr></table></figure><ul><li>导入.csv文件主要使用Pandas的read_csv()方法</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pandas.read_csv(filepath_or_buffer, *, sep=_NoDefault.no_default, delimiter=<span class="hljs-literal">None</span>, header=<span class="hljs-string">&#x27;infer&#x27;</span>, names=_NoDefault.no_default, index_col=<span class="hljs-literal">None</span>, usecols=<span class="hljs-literal">None</span>, dtype=<span class="hljs-literal">None</span>, engine=<span class="hljs-literal">None</span>, converters=<span class="hljs-literal">None</span>, true_values=<span class="hljs-literal">None</span>, false_values=<span class="hljs-literal">None</span>, skipinitialspace=<span class="hljs-literal">False</span>, skiprows=<span class="hljs-literal">None</span>, skipfooter=<span class="hljs-number">0</span>, nrows=<span class="hljs-literal">None</span>, na_values=<span class="hljs-literal">None</span>, keep_default_na=<span class="hljs-literal">True</span>, na_filter=<span class="hljs-literal">True</span>, verbose=_NoDefault.no_default, skip_blank_lines=<span class="hljs-literal">True</span>, parse_dates=<span class="hljs-literal">None</span>, infer_datetime_format=_NoDefault.no_default, keep_date_col=_NoDefault.no_default, date_parser=_NoDefault.no_default, date_format=<span class="hljs-literal">None</span>, dayfirst=<span class="hljs-literal">False</span>, cache_dates=<span class="hljs-literal">True</span>, iterator=<span class="hljs-literal">False</span>, chunksize=<span class="hljs-literal">None</span>, compression=<span class="hljs-string">&#x27;infer&#x27;</span>, thousands=<span class="hljs-literal">None</span>, decimal=<span class="hljs-string">&#x27;.&#x27;</span>, lineterminator=<span class="hljs-literal">None</span>, quotechar=<span class="hljs-string">&#x27;&quot;&#x27;</span>, quoting=<span class="hljs-number">0</span>, doublequote=<span class="hljs-literal">True</span>, escapechar=<span class="hljs-literal">None</span>, comment=<span class="hljs-literal">None</span>, encoding=<span class="hljs-literal">None</span>, encoding_errors=<span class="hljs-string">&#x27;strict&#x27;</span>, dialect=<span class="hljs-literal">None</span>, on_bad_lines=<span class="hljs-string">&#x27;error&#x27;</span>, delim_whitespace=_NoDefault.no_default, low_memory=<span class="hljs-literal">True</span>, memory_map=<span class="hljs-literal">False</span>, float_precision=<span class="hljs-literal">None</span>, storage_options=<span class="hljs-literal">None</span>, dtype_backend=_NoDefault.no_default)[source<br></code></pre></td></tr></table></figure><ul><li>导入.txt文件，也可以使用read_csv方法，指定sep为制表符，’\t’</li></ul><h4 id="DataFram提取数据"><a href="#DataFram提取数据" class="headerlink" title="DataFram提取数据"></a>DataFram提取数据</h4><p>对象的loc属性和iloc属性都可以抽取数据</p><ul><li><p>loc属性：以列名（columns）和行名（index）作为参数，<strong>当只有一个参数时，默认是行名</strong>，即抽取整行数据，包括所有列，如df.loc[‘A’]。</p></li><li><p>iloc属性：以行和列位置索引（即0，1，2，…）作为参数，0表示第1行，1表示第2行，以此类推。<strong>当只有一个参数时，默认是行索引</strong>，即抽取整行数据，包括所有列。如抽取第1行数据，df.iloc[0]。</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 0  1  4  A</span><br><span class="hljs-comment"># 1  2  5  B</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D</span><br><span class="hljs-built_in">print</span>(df.loc[<span class="hljs-number">0</span>])<br><span class="hljs-comment"># A    1</span><br><span class="hljs-comment"># B    4</span><br><span class="hljs-comment"># C    A</span><br><span class="hljs-built_in">print</span>(df.iloc[<span class="hljs-number">0</span>])<br><span class="hljs-comment"># A    1</span><br><span class="hljs-comment"># B    4</span><br><span class="hljs-comment"># C    A</span><br></code></pre></td></tr></table></figure><blockquote><p>loc和iloc的区别</p></blockquote><h4 id="loc"><a href="#loc" class="headerlink" title="loc"></a><code>loc</code></h4><ul><li><strong>基于标签（Label-based）</strong>: <code>loc</code>是通过行标签和列标签来进行选择和过滤的。</li><li><strong>包含结束点</strong>: 使用<code>loc</code>时，区间是闭区间，<strong>即包括结束点</strong>。</li><li><strong>支持布尔索引</strong>: <code>loc</code>可以接受布尔数组来进行条件筛选。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><span class="hljs-comment"># 创建一个示例DataFrame</span><br>data = &#123;<br>    <span class="hljs-string">&#x27;A&#x27;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],<br>    <span class="hljs-string">&#x27;B&#x27;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>],<br>    <span class="hljs-string">&#x27;C&#x27;</span>: [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<br>&#125;<br>df = pd.DataFrame(data, index=[<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;z&#x27;</span>])<br><br><span class="hljs-comment"># 使用loc进行选择</span><br><span class="hljs-built_in">print</span>(df.loc[<span class="hljs-string">&#x27;x&#x27;</span>])  <span class="hljs-comment"># 选择标签为&#x27;x&#x27;的行</span><br><span class="hljs-built_in">print</span>(df.loc[<span class="hljs-string">&#x27;x&#x27;</span>:<span class="hljs-string">&#x27;y&#x27;</span>])  <span class="hljs-comment"># 选择标签在&#x27;x&#x27;到&#x27;y&#x27;之间的行（包括&#x27;y&#x27;）</span><br><span class="hljs-built_in">print</span>(df.loc[:, <span class="hljs-string">&#x27;A&#x27;</span>])  <span class="hljs-comment"># 选择所有行的&#x27;A&#x27;列</span><br><span class="hljs-built_in">print</span>(df.loc[df[<span class="hljs-string">&#x27;A&#x27;</span>] &gt; <span class="hljs-number">1</span>])  <span class="hljs-comment"># 选择&#x27;A&#x27;列大于1的行</span><br></code></pre></td></tr></table></figure><h4 id="iloc"><a href="#iloc" class="headerlink" title="iloc"></a><code>iloc</code></h4><ul><li><strong>基于位置（Integer position-based）</strong>: <code>iloc</code>是通过行号和列号来进行选择和过滤的。</li><li><strong>不包含结束点</strong>: 使用<code>iloc</code>时，区间是左闭右开的，即<strong>不包括结束点</strong>。</li><li><strong>只接受整数或整数数组</strong>: <code>iloc</code>只接受整数、整数列表或切片。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用iloc进行选择</span><br><span class="hljs-built_in">print</span>(df.iloc[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 选择第0行</span><br><span class="hljs-built_in">print</span>(df.iloc[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>])  <span class="hljs-comment"># 选择第0行到第2行之间的行（不包括第2行）</span><br><span class="hljs-built_in">print</span>(df.iloc[:, <span class="hljs-number">0</span>])  <span class="hljs-comment"># 选择所有行的第0列</span><br><span class="hljs-built_in">print</span>(df.iloc[[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]])  <span class="hljs-comment"># 选择第0和第2行，第1和第2列</span><br></code></pre></td></tr></table></figure><h4 id="直接根据列名进行数据筛选"><a href="#直接根据列名进行数据筛选" class="headerlink" title="直接根据列名进行数据筛选"></a>直接根据列名进行数据筛选</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><span class="hljs-comment"># 创建示例 DataFrame</span><br>data = &#123;<br>    <span class="hljs-string">&#x27;A&#x27;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&#x27;B&#x27;</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>],<br>    <span class="hljs-string">&#x27;C&#x27;</span>: [<span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><br><span class="hljs-comment"># 使用 df[&#x27;A&#x27;]</span><br>series_a = df[<span class="hljs-string">&#x27;A&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Type of df[&#x27;A&#x27;]:&quot;</span>, <span class="hljs-built_in">type</span>(series_a))<br><span class="hljs-built_in">print</span>(series_a)<br><span class="hljs-built_in">print</span>()<br><br><span class="hljs-comment"># 使用 df[[&#x27;A&#x27;]]</span><br>dataframe_a = df[[<span class="hljs-string">&#x27;A&#x27;</span>]]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Type of df[[&#x27;A&#x27;]]:&quot;</span>, <span class="hljs-built_in">type</span>(dataframe_a))<br><span class="hljs-built_in">print</span>(dataframe_a)<br><br></code></pre></td></tr></table></figure><ol><li><strong>返回的数据类型</strong>：<ul><li><code>df[&#39;A&#39;]</code> 返回的是一个 Pandas Series 对象。</li><li><code>df[[&#39;A&#39;]]</code> 返回的是一个 Pandas DataFrame 对象。</li></ul></li><li><strong>维度</strong>：<ul><li><code>df[&#39;A&#39;]</code> 返回的是一维数据（Series）。</li><li><code>df[[&#39;A&#39;]]</code> 返回的是二维数据（DataFrame），即使只选择了一列。</li></ul></li><li><strong>操作的灵活性</strong>：<ul><li>由于 <code>df[&#39;A&#39;]</code> 是一个 Series，所以你可以直接对这个 Series 进行一维数据的操作。</li><li><code>df[[&#39;A&#39;]]</code> 是一个 DataFrame，所以你可以继续对这个 DataFrame 进行更多的二维数据操作，比如再选取其他列。</li></ul></li></ol><h4 id="按照指定条件筛选数据"><a href="#按照指定条件筛选数据" class="headerlink" title="按照指定条件筛选数据"></a>按照指定条件筛选数据</h4><ul><li><p>取其中的一个元素.iat[x,x]。</p></li><li><p>基于位置的查询，如.iloc[]、iloc[2,1]。</p></li><li><p>基于行、列名称的查询，如.loc[x]。****</p></li></ul><blockquote><p>iat查询单个元素</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 0  1  4  A</span><br><span class="hljs-comment"># 1  2  5  B</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D</span><br><span class="hljs-built_in">print</span>(df.iat[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])  <span class="hljs-comment"># 5</span><br><span class="hljs-built_in">print</span>(df.iat[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>])  <span class="hljs-comment"># 1</span><br></code></pre></td></tr></table></figure><blockquote><p>iloc和loc基于位置查询</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(df.iloc[[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]]) <span class="hljs-comment"># 筛选出第0，2行和第0,1列数据</span><br><span class="hljs-comment">#   A  B</span><br><span class="hljs-comment">#0  1  4</span><br><span class="hljs-comment">#2  3  6</span><br><span class="hljs-built_in">print</span>(df.iloc[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]) <span class="hljs-comment"># 筛选出第0行第1列数据</span><br><span class="hljs-comment"># 4</span><br><span class="hljs-built_in">print</span>(df.iloc[<span class="hljs-number">0</span>:<span class="hljs-number">1</span>, <span class="hljs-number">1</span>:<span class="hljs-number">2</span>])  <span class="hljs-comment"># 筛选出第0行第1列 左包含右不包含</span><br><span class="hljs-comment">#    B</span><br><span class="hljs-comment"># 0  4</span><br><span class="hljs-built_in">print</span>(df.loc[[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>]]) <span class="hljs-comment"># 筛选出第0,1行，第A,B列数据，左包含右包含</span><br><span class="hljs-comment">#    A  B</span><br><span class="hljs-comment"># 0  1  4</span><br><span class="hljs-comment"># 1  2  5</span><br><span class="hljs-built_in">print</span>(df.loc[(df[<span class="hljs-string">&#x27;A&#x27;</span>] &gt; <span class="hljs-number">2</span>) &amp; (df[<span class="hljs-string">&#x27;B&#x27;</span>] &gt; <span class="hljs-number">2</span>)])<br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D</span><br></code></pre></td></tr></table></figure><h4 id="数据的增加，删除，修改"><a href="#数据的增加，删除，修改" class="headerlink" title="数据的增加，删除，修改"></a>数据的增加，删除，修改</h4><h5 id="增加数据"><a href="#增加数据" class="headerlink" title="增加数据"></a>增加数据</h5><blockquote><p>增加列数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 新建一个DataFrame格式</span><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br>df[<span class="hljs-string">&#x27;E&#x27;</span>] = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#    A  B  C  E</span><br><span class="hljs-comment"># 0  1  4  A  2</span><br><span class="hljs-comment"># 1  2  5  B  3</span><br><span class="hljs-comment"># 2  3  6  C  4</span><br><span class="hljs-comment"># 3  4  7  D  5</span><br>df.loc[:, <span class="hljs-string">&quot;F&quot;</span>] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#    A  B  C  E  F</span><br><span class="hljs-comment"># 0  1  4  A  2  1</span><br><span class="hljs-comment"># 1  2  5  B  3  2</span><br><span class="hljs-comment"># 2  3  6  C  4  3</span><br><span class="hljs-comment"># 3  4  7  D  5  4</span><br></code></pre></td></tr></table></figure><blockquote><p>增加行数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用iloc或者loc</span><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br>df.loc[<span class="hljs-string">&quot;A&quot;</span>, :] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#      A    B  C</span><br><span class="hljs-comment"># 0  1.0  4.0  A</span><br><span class="hljs-comment"># 1  2.0  5.0  B</span><br><span class="hljs-comment"># 2  3.0  6.0  C</span><br><span class="hljs-comment"># 3  4.0  7.0  D</span><br><span class="hljs-comment"># A  1.0  2.0  3</span><br>df.loc[<span class="hljs-string">&#x27;B&#x27;</span>] = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#      A    B  C</span><br><span class="hljs-comment"># 0  1.0  4.0  A</span><br><span class="hljs-comment"># 1  2.0  5.0  B</span><br><span class="hljs-comment"># 2  3.0  6.0  C</span><br><span class="hljs-comment"># 3  4.0  7.0  D</span><br><span class="hljs-comment"># A  1.0  2.0  3</span><br><span class="hljs-comment"># B    A    D  E</span><br></code></pre></td></tr></table></figure><blockquote><p>增加多行数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-comment"># df.loc[&quot;A&quot;, :] = [1, 2, 3]</span><br><span class="hljs-comment"># print(df)</span><br>df1 = pd.DataFrame(<br>    data=&#123;<br>        <span class="hljs-string">&#x27;A&#x27;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>],<br>        <span class="hljs-string">&#x27;B&#x27;</span>: [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>],<br>        <span class="hljs-string">&#x27;C&#x27;</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>]<br>    &#125;<br>)<br><span class="hljs-built_in">print</span>(pd.concat([df1, df], axis=<span class="hljs-number">1</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span>*<span class="hljs-number">20</span>)<br><span class="hljs-built_in">print</span>(pd.concat([df,df1],axis=<span class="hljs-number">0</span>))<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_2c345b67baa6713794a3092e4d7d7483.png"></p><h5 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">DataFrame.drop(labels=<span class="hljs-literal">None</span>, axis=<span class="hljs-number">0</span>, index=<span class="hljs-literal">None</span>, columns=<span class="hljs-literal">None</span>, level=<span class="hljs-literal">None</span>, inplace=<span class="hljs-literal">False</span>,error=<span class="hljs-literal">None</span>)<br><span class="hljs-comment"># labels：表示行标签或列标签。</span><br><span class="hljs-comment"># axis：axis = 0，表示按行删除；axis = 1，表示按列删除。默认值为0，即按行删除。</span><br><span class="hljs-comment"># index：删除行，默认值为None。</span><br><span class="hljs-comment"># columns：删除列，默认值为None。</span><br><span class="hljs-comment"># level：针对有两级索引的数据。level = 0，表示按第1级索引删除整行；level = 1表示按第2级索</span><br><span class="hljs-comment"># 引删除整行，默认值为None。</span><br><span class="hljs-comment"># inplace：可选参数，对原数组做出修改并返回一个新数组。默认值为False，如果值为True，那</span><br><span class="hljs-comment"># 么原数组直接就被替换。</span><br><span class="hljs-comment"># errors：参数值为ignore或raise，默认值为raise，如果值为ignore（忽略），则取消错误。</span><br></code></pre></td></tr></table></figure><blockquote><p>删除行、列数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-built_in">print</span>(df.drop(labels=[<span class="hljs-string">&#x27;A&#x27;</span>], axis=<span class="hljs-number">1</span>))<br><span class="hljs-built_in">print</span>(df.drop(labels=[<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>], axis=<span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_d4efda7653160934731f2640c7eb6070.png"></p><h5 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h5><blockquote><p>修改列名</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br>df.columns = [<span class="hljs-string">&#x27;上&#x27;</span>, <span class="hljs-string">&#x27;中&#x27;</span>, <span class="hljs-string">&#x27;下&#x27;</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#   上  中  下</span><br><span class="hljs-comment"># 0  1  4  A</span><br><span class="hljs-comment"># 1  2  5  B</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D</span><br><br><span class="hljs-comment"># 使用rename对列名进行重新命名</span><br>df.rename(columns=&#123;<span class="hljs-string">&#x27;上&#x27;</span>: <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;中&#x27;</span>: <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;下&#x27;</span>: <span class="hljs-string">&#x27;C&#x27;</span>&#125;,inplace=<span class="hljs-literal">True</span>)<br><span class="hljs-comment"># 参数inplace为True，表示直接修改df；否则，不修改df，只返回修改后的数据。</span><br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 0  1  4  A</span><br><span class="hljs-comment"># 1  2  5  B</span><br><span class="hljs-comment"># 2  3  6  C</span><br><span class="hljs-comment"># 3  4  7  D</span><br></code></pre></td></tr></table></figure><blockquote><p>修改列名</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><br>df.index = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br>df = df.rename(index=&#123;<span class="hljs-string">&#x27;A&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;B&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;C&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;D&#x27;</span>: <span class="hljs-number">4</span>&#125;, inplace=<span class="hljs-literal">False</span>)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment">#  A  B  C</span><br><span class="hljs-comment"># A  1  4  A</span><br><span class="hljs-comment"># B  2  5  B</span><br><span class="hljs-comment"># C  3  6  C</span><br><span class="hljs-comment"># D  4  7  D</span><br><span class="hljs-comment"># ------------------------------</span><br><span class="hljs-comment">#    A  B  C</span><br><span class="hljs-comment"># 1  1  4  A</span><br><span class="hljs-comment"># 2  2  5  B</span><br><span class="hljs-comment"># 3  3  6  C</span><br><span class="hljs-comment"># 4  4  7  D</span><br></code></pre></td></tr></table></figure><blockquote><p>修改数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-comment"># 修改整行数据</span><br>df.loc[<span class="hljs-string">&#x27;C&#x27;</span>] = <span class="hljs-built_in">list</span>(<span class="hljs-string">&#x27;DEF&#x27;</span>)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br>df.iloc[<span class="hljs-number">0</span>] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment"># 修改整列数据</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br>df.loc[:, <span class="hljs-string">&#x27;D&#x27;</span>] = <span class="hljs-built_in">list</span>(<span class="hljs-string">&#x27;HELLO&#x27;</span>)<br><span class="hljs-built_in">print</span>(df)<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_312b64d12acc77cb9315956dde4017f4.png"></p><h5 id="删除缺失值"><a href="#删除缺失值" class="headerlink" title="删除缺失值"></a>删除缺失值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">DataFrame.dropna(axis=<span class="hljs-number">0</span>, how=<span class="hljs-string">&#x27;any&#x27;</span>, thresh=<span class="hljs-literal">None</span>, subset=<span class="hljs-literal">None</span>, inplace=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><ul><li><code>axis</code>: 决定是删除行(0)还是删除列(1)。</li><li><code>how</code>: 决定删除包含任意缺失值的行&#x2F;列(<code>&#39;any&#39;</code>)还是只删除包含全部缺失值的行&#x2F;列(<code>&#39;all&#39;</code>)。</li><li><code>thresh</code>: 设置行&#x2F;列中至少需要有多少个非缺失值才能被保留。</li><li><code>subset</code>: 指定需要检查缺失值的特定列。</li><li><code>inplace</code>: 如果设为 <code>True</code>,则直接修改原有的 DataFrame,否则返回一个新的 DataFrame。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">df.dropna() <span class="hljs-comment"># 删除缺失值</span><br></code></pre></td></tr></table></figure><h3 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h3><h4 id="缺失值处理"><a href="#缺失值处理" class="headerlink" title="缺失值处理"></a>缺失值处理</h4><blockquote><p>删除缺失值</p></blockquote><ul><li>dropna()</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">DataFrame.dropna(axis=<span class="hljs-number">0</span>, how=<span class="hljs-string">&#x27;any&#x27;</span>, thresh=<span class="hljs-literal">None</span>, subset=<span class="hljs-literal">None</span>, inplace=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, np.nan],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br><span class="hljs-built_in">print</span>(df.dropna(axis=<span class="hljs-string">&#x27;columns&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br><span class="hljs-built_in">print</span>(df.dropna(axis=<span class="hljs-string">&#x27;rows&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br><span class="hljs-built_in">print</span>(df.dropna(axis=<span class="hljs-string">&#x27;index&#x27;</span>))<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_6b227501abbb8210cdeb1b6af4a8603f.png"></p><blockquote><p>数据填充</p></blockquote><ul><li>fillna</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">DataFrame.fillna(value=<span class="hljs-literal">None</span>, *, method=<span class="hljs-literal">None</span>, axis=<span class="hljs-literal">None</span>, inplace=<span class="hljs-literal">False</span>, limit=<span class="hljs-literal">None</span>, downcast=_NoDefault.no_default)<br><br>method&#123;‘backfill’, ‘bfill’, ‘ffill’, <span class="hljs-literal">None</span>&#125;, default <span class="hljs-literal">None</span><br>Method to use <span class="hljs-keyword">for</span> filling holes <span class="hljs-keyword">in</span> reindexed Series:<br><br>ffill: propagate last valid observation forward to <span class="hljs-built_in">next</span> valid.<br><br>backfill / bfill: use <span class="hljs-built_in">next</span> valid observation to fill gap.<br><br>Deprecated since version <span class="hljs-number">2.1</span><span class="hljs-number">.0</span>: Use ffill <span class="hljs-keyword">or</span> bfill instead.<br><br>axis&#123;<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> ‘index’&#125; <span class="hljs-keyword">for</span> Series, &#123;<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> ‘index’, <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> ‘columns’&#125; <span class="hljs-keyword">for</span> DataFrame<br>Axis along which to fill missing values. For Series this parameter <span class="hljs-keyword">is</span> unused <span class="hljs-keyword">and</span> defaults to <span class="hljs-number">0.</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = &#123;<br>    <span class="hljs-string">&quot;A&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>    <span class="hljs-string">&quot;B&quot;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, np.nan],<br>    <span class="hljs-string">&quot;C&quot;</span>: [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]<br>&#125;<br>df = pd.DataFrame(data)<br><span class="hljs-built_in">print</span>(df)<br><span class="hljs-comment"># print(&#x27;-&#x27; * 30)</span><br><span class="hljs-comment"># print(df.dropna(axis=&#x27;columns&#x27;))</span><br><span class="hljs-comment"># print(&#x27;-&#x27; * 30)</span><br><span class="hljs-comment"># print(df.dropna(axis=&#x27;rows&#x27;))</span><br><span class="hljs-comment"># print(&#x27;-&#x27; * 30)</span><br><span class="hljs-comment"># print(df.dropna(axis=&#x27;index&#x27;))</span><br><br><span class="hljs-built_in">print</span>(df.fillna(value=<span class="hljs-number">0</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br><span class="hljs-built_in">print</span>(df.fillna(value=<span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_1ed2c03deaf706fe99f41eea1706305b.png"></p><blockquote><p>重复值处理</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">duplicated()<br>drop_duplicates()<br>DataFrame.drop_duplicates(subset=<span class="hljs-literal">None</span>, *, keep=<span class="hljs-string">&#x27;first&#x27;</span>, inplace=<span class="hljs-literal">False</span>, ignore_index=<span class="hljs-literal">False</span>)<br>Return DataFrame <span class="hljs-keyword">with</span> duplicate rows removed.<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>df = pd.DataFrame(&#123;<br><span class="hljs-meta">... </span>    <span class="hljs-string">&#x27;brand&#x27;</span>: [<span class="hljs-string">&#x27;Yum Yum&#x27;</span>, <span class="hljs-string">&#x27;Yum Yum&#x27;</span>, <span class="hljs-string">&#x27;Indomie&#x27;</span>, <span class="hljs-string">&#x27;Indomie&#x27;</span>, <span class="hljs-string">&#x27;Indomie&#x27;</span>],<br><span class="hljs-meta">... </span>    <span class="hljs-string">&#x27;style&#x27;</span>: [<span class="hljs-string">&#x27;cup&#x27;</span>, <span class="hljs-string">&#x27;cup&#x27;</span>, <span class="hljs-string">&#x27;cup&#x27;</span>, <span class="hljs-string">&#x27;pack&#x27;</span>, <span class="hljs-string">&#x27;pack&#x27;</span>],<br><span class="hljs-meta">... </span>    <span class="hljs-string">&#x27;rating&#x27;</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3.5</span>, <span class="hljs-number">15</span>, <span class="hljs-number">5</span>]<br><span class="hljs-meta">... </span>&#125;)<br><span class="hljs-meta">&gt;&gt;&gt; </span>df<br>    brand style  rating<br><span class="hljs-number">0</span>  Yum Yum   cup     <span class="hljs-number">4.0</span><br><span class="hljs-number">1</span>  Yum Yum   cup     <span class="hljs-number">4.0</span><br><span class="hljs-number">2</span>  Indomie   cup     <span class="hljs-number">3.5</span><br><span class="hljs-number">3</span>  Indomie  pack    <span class="hljs-number">15.0</span><br><span class="hljs-number">4</span>  Indomie  pack     <span class="hljs-number">5.0</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>df.drop_duplicates()<br>    brand style  rating<br><span class="hljs-number">0</span>  Yum Yum   cup     <span class="hljs-number">4.0</span><br><span class="hljs-number">2</span>  Indomie   cup     <span class="hljs-number">3.5</span><br><span class="hljs-number">3</span>  Indomie  pack    <span class="hljs-number">15.0</span><br><span class="hljs-number">4</span>  Indomie  pack     <span class="hljs-number">5.0</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>df.drop_duplicates(subset=[<span class="hljs-string">&#x27;brand&#x27;</span>])<br>    brand style  rating<br><span class="hljs-number">0</span>  Yum Yum   cup     <span class="hljs-number">4.0</span><br><span class="hljs-number">2</span>  Indomie   cup     <span class="hljs-number">3.5</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>df.drop_duplicates(subset=[<span class="hljs-string">&#x27;brand&#x27;</span>, <span class="hljs-string">&#x27;style&#x27;</span>], keep=<span class="hljs-string">&#x27;last&#x27;</span>)<br>    brand style  rating<br><span class="hljs-number">1</span>  Yum Yum   cup     <span class="hljs-number">4.0</span><br><span class="hljs-number">2</span>  Indomie   cup     <span class="hljs-number">3.5</span><br><span class="hljs-number">4</span>  Indomie  pack     <span class="hljs-number">5.0</span><br></code></pre></td></tr></table></figure><h4 id="设置某列为行索引"><a href="#设置某列为行索引" class="headerlink" title="设置某列为行索引"></a>设置某列为行索引</h4><p>设置某列为行索引主要使用set_index()方法。如果在set_index()方法中传入参数drop&#x3D;True，则会删除”设置的索引列名”；如果传入drop&#x3D;False，则会保留设置的索引列。默认为False。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">df2=df.dropna().reset_index(drop=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 删除NaN值后重新设置索引</span><br></code></pre></td></tr></table></figure><h4 id="数据排序"><a href="#数据排序" class="headerlink" title="数据排序"></a>数据排序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">DataFrame.sort_values(by,axis=<span class="hljs-number">0</span>,ascending=<span class="hljs-literal">True</span>,inplace=<span class="hljs-literal">False</span>,kind=<span class="hljs-string">&#x27;quicksort&#x27;</span>,na_position=<span class="hljs-string">&#x27;l</span><br><span class="hljs-string">index=False)</span><br><span class="hljs-string"></span><br><span class="hljs-string">by：要排序的名称列表。</span><br><span class="hljs-string">axis：轴，axis=0表示行，axis=1表示列。默认值为0，即按行排序。</span><br><span class="hljs-string">ascending：升序或降序排序，布尔值，指定多个排序可以使用布尔值列表。默认值为True。</span><br><span class="hljs-string">inplace：布尔值，默认值为False，如果值为True，则就地排序。</span><br><span class="hljs-string">kind：指定排序算法，值为quicksort（快速排序）、mergesort（混合排序）或heapsort（堆排），默认值为quicksort。</span><br><span class="hljs-string">na_position：空值（NaN）的位置，值为first空值在数据开头，值为last空值在数据最后，默认值为last。</span><br><span class="hljs-string">ignore_index：布尔值，是否忽略索引，值为True标记索引（从0开始按顺序的整数值），值为False则忽略索引。</span><br></code></pre></td></tr></table></figure><h4 id="分组统计"><a href="#分组统计" class="headerlink" title="分组统计"></a>分组统计</h4><p>group_by</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">DataFrame.groupby(by=<span class="hljs-literal">None</span>,axis=<span class="hljs-number">0</span>,level=<span class="hljs-literal">None</span>,as_index=<span class="hljs-literal">True</span>,sort=<span class="hljs-literal">True</span>,group_keys=<span class="hljs-literal">True</span>,squeeze=<br>observed=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p>by：映射、字典或Series对象、数组、标签或标签列表。如果by是一个函数，则对象索引的每个</p><p>值都调用它；如果传递了一个字典或Series对象，则使用该字典或Series对象值来确定组；如果传</p><p>递了数组ndarray，则按原样使用这些值来确定组。</p><p>axis：axis&#x3D;1表示行，axis&#x3D;0表示列。默认值为0。</p><p>level：表示索引层级，默认值为None（无）。</p><p>as_index：布尔型，默认值为True，返回以组标签为索引的对象。</p><p>sort：对组进行排序，布尔型，默认值为True。</p><p>group_keys：布尔型，默认值为True，调用apply()函数时，将分组的键添加到索引以标识片段。</p><p>squeeze：布尔型，默认值为False。如果可能，减少返回类型的维度；否则返回一致类型。</p><p>observed：当以石斑鱼为分类时，才会使用该参数。如果参数值为True，则仅显示分类石斑鱼的观测值；如果参数值为False，则显示分类石斑鱼的所有值。</p><p>返回值：返回DataFrameGroupBy，返回包含有关组的信息的groupby对象。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><span class="hljs-comment"># 导入示例数据</span><br>data = sns.load_dataset(<span class="hljs-string">&quot;iris&quot;</span>)<br><span class="hljs-built_in">print</span>(data.head())<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_e4f4b05f04c9a9a0ef0e7fa2c6d59009.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(data.groupby(<span class="hljs-string">&#x27;species&#x27;</span>).<span class="hljs-built_in">sum</span>()) <span class="hljs-comment"># 单分组统计</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">40</span>)<br><span class="hljs-built_in">print</span>(data.groupby(by=[<span class="hljs-string">&#x27;species&#x27;</span>, <span class="hljs-string">&#x27;petal_width&#x27;</span>]).<span class="hljs-built_in">sum</span>()) <span class="hljs-comment"># 多分组统计</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_7cb2eb9d739f181a31ac8e3853c7684d.png"></p><blockquote><p>分组并按照指定的列进行统计</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(data.groupby(by=<span class="hljs-string">&quot;species&quot;</span>)[<span class="hljs-string">&#x27;petal_width&#x27;</span>].<span class="hljs-built_in">sum</span>())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><span class="hljs-built_in">print</span>(data[<span class="hljs-string">&#x27;species&#x27;</span>].unique())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><span class="hljs-built_in">print</span>(data[[<span class="hljs-string">&#x27;petal_width&#x27;</span>, <span class="hljs-string">&#x27;species&#x27;</span>]].groupby(by=<span class="hljs-string">&quot;species&quot;</span>).<span class="hljs-built_in">sum</span>())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><span class="hljs-built_in">print</span>(data.loc[:, [<span class="hljs-string">&#x27;species&#x27;</span>, <span class="hljs-string">&#x27;petal_width&#x27;</span>]].groupby(<span class="hljs-string">&#x27;species&#x27;</span>).<span class="hljs-built_in">sum</span>())<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_c2fb408eaa019daf70b066379bfc73c8.png"></p><blockquote><p>对分组数据进行迭代</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> name, age <span class="hljs-keyword">in</span> data.groupby(<span class="hljs-string">&#x27;species&#x27;</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;name&quot;</span>)<br>    <span class="hljs-built_in">print</span>(name)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;age&quot;</span>)<br>    <span class="hljs-built_in">print</span>(age.head(n=<span class="hljs-number">3</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;*&quot;</span> * <span class="hljs-number">60</span>)<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_fdfe0d5e40e775b5c3baed6a88102df7.png"></p><blockquote><p>多分组数据进行分析</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> (key1, key2), group <span class="hljs-keyword">in</span> data.groupby(by=[<span class="hljs-string">&#x27;species&#x27;</span>, <span class="hljs-string">&#x27;petal_width&#x27;</span>]):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(key1)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(key2)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(group.head(n=<span class="hljs-number">2</span>))<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_018d68b5bbf37628e580670e6840958d.png"></p><h4 id="对分组的某列或多列使用聚合函数（-agg-函数）"><a href="#对分组的某列或多列使用聚合函数（-agg-函数）" class="headerlink" title="对分组的某列或多列使用聚合函数（**agg()**函数）"></a>对分组的某列或多列使用聚合函数（**agg()**函数）</h4><p>Python也可以实现像SQL中的分组聚合运算操作，主要通过groupby()函数与agg()函数实现。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>dataset = sns.get_dataset_names()<br><span class="hljs-built_in">print</span>(dataset)<br><span class="hljs-comment">#[&#x27;anagrams&#x27;, &#x27;anscombe&#x27;, &#x27;attention&#x27;, &#x27;brain_networks&#x27;, &#x27;car_crashes&#x27;, &#x27;diamonds&#x27;, &#x27;dots&#x27;, &#x27;dowjones&#x27;, &#x27;exercise&#x27;, &#x27;flights&#x27;, &#x27;fmri&#x27;, &#x27;geyser&#x27;, &#x27;glue&#x27;, &#x27;healthexp&#x27;, &#x27;iris&#x27;, &#x27;mpg&#x27;, &#x27;penguins&#x27;, &#x27;planets&#x27;, &#x27;seaice&#x27;, &#x27;taxis&#x27;, &#x27;tips&#x27;, &#x27;titanic&#x27;]</span><br><span class="hljs-comment"># 使用seaborn中的mpg数据集</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pandas</category>
      
    </categories>
    
    
    <tags>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RNA速率</title>
    <link href="/2024/05/31/RNA%E9%80%9F%E7%8E%87/"/>
    <url>/2024/05/31/RNA%E9%80%9F%E7%8E%87/</url>
    
    <content type="html"><![CDATA[<h2 id="RNA速率分析"><a href="#RNA速率分析" class="headerlink" title="RNA速率分析"></a>RNA速率分析</h2><blockquote><p>部分代码来自微信公众号：KS科研与服务</p></blockquote><h3 id="R语言版本"><a href="#R语言版本" class="headerlink" title="R语言版本"></a>R语言版本</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># sudo apt-get install libboost-filesystem-dev</span><br><span class="hljs-comment"># sudo apt-get install libboost-system-dev</span><br><span class="hljs-comment">#library(velocyto.R)</span><br>library<span class="hljs-punctuation">(</span>pcaMethods<span class="hljs-punctuation">,</span>lib.loc <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;/root/wangje/miniconda3/lib/R/library&#x27;</span><span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>velocyto.R<span class="hljs-punctuation">,</span>lib.loc <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;/root/wangje/R/x86_64-conda-linux-gnu-library/4.2&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># remotes::install_github(&quot;satijalab/seurat-wrappers&quot;)</span><br>library<span class="hljs-punctuation">(</span>SeuratWrappers<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>SCP<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dittoSeq<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>stewd<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">###读入数据*************************************************************</span><br>scRNA <span class="hljs-operator">&lt;-</span> qread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./test.qs&#x27;</span><span class="hljs-punctuation">)</span><br>scRNA<br><span class="hljs-comment"># An object of class Seurat</span><br><span class="hljs-comment"># 41071 features across 14846 samples within 3 assays</span><br><span class="hljs-comment"># Active assay: RNA (37071 features, 2000 variable features)</span><br><span class="hljs-comment">#  2 layers present: counts, data</span><br><span class="hljs-comment">#  2 other assays present: scVIcorrected, ComBatcorrected</span><br><span class="hljs-comment">#  13 dimensional reductions calculated: BBKNNpca, BBKNNUMAP2D, BBKNNUMAP3D,</span><br><br>DefaultAssay<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;RNA&#x27;</span><br>Idents<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">$</span>celltype2<br><br><span class="hljs-comment">### 加载loom文件********************************************************</span><br>ldat <span class="hljs-operator">&lt;-</span> ReadVelocity<span class="hljs-punctuation">(</span>file <span class="hljs-operator">=</span> <span class="hljs-string">&quot;~/data_analysis/RNA速率/uterus.loom&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> ldat<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># &quot;spliced&quot;   &quot;unspliced&quot; &quot;ambiguous&quot;</span><br>lapply<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>ldat<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span>head<span class="hljs-punctuation">(</span>colnames<span class="hljs-punctuation">(</span>ldat<span class="hljs-punctuation">[[</span>x<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># [[1]]</span><br><span class="hljs-comment"># [1] &quot;CJME_0707:AAACATCGAGTCACTAAAGACGGAx&quot; &quot;CJME_0707:AAACATCGAACGCTTACGAACTTAx&quot; &quot;CJME_0707:AAACATCGAATGTTGCACAGCAGAx&quot;</span><br><span class="hljs-comment"># [4] &quot;CJME_0707:AAACATCGAGCACCTCGCGAGTAAx&quot; &quot;CJME_0707:AAACATCGAACTCACCCCGACAACx&quot; &quot;CJME_0707:AAACATCGAGCAGGAAAATGTTGCx&quot;</span><br><br><span class="hljs-comment"># [[2]]</span><br><span class="hljs-comment"># [1] &quot;CJME_0707:AAACATCGAGTCACTAAAGACGGAx&quot; &quot;CJME_0707:AAACATCGAACGCTTACGAACTTAx&quot; &quot;CJME_0707:AAACATCGAATGTTGCACAGCAGAx&quot;</span><br><span class="hljs-comment"># [4] &quot;CJME_0707:AAACATCGAGCACCTCGCGAGTAAx&quot; &quot;CJME_0707:AAACATCGAACTCACCCCGACAACx&quot; &quot;CJME_0707:AAACATCGAGCAGGAAAATGTTGCx&quot;</span><br><br><span class="hljs-comment"># [[3]]</span><br><span class="hljs-comment"># [1] &quot;CJME_0707:AAACATCGAGTCACTAAAGACGGAx&quot; &quot;CJME_0707:AAACATCGAACGCTTACGAACTTAx&quot; &quot;CJME_0707:AAACATCGAATGTTGCACAGCAGAx&quot;</span><br><span class="hljs-comment"># [4] &quot;CJME_0707:AAACATCGAGCACCTCGCGAGTAAx&quot; &quot;CJME_0707:AAACATCGAACTCACCCCGACAACx&quot; &quot;CJME_0707:AAACATCGAGCAGGAAAATGTTGCx&quot;</span><br>head<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># [1] &quot;CJME_0707_TGGAACAAGAGCTGAACTGGCATA&quot; &quot;CJME_0707_AAGAGATCCACTTCGAATCATTCC&quot; &quot;CJME_0707_AATCCGTCAATCCGTCCAACCACA&quot; &quot;CJME_0707_ACAAGCTACGACACACCAACCACA&quot;</span><br><span class="hljs-comment"># [5] &quot;CJME_0707_ACCACTGTACAGCAGATATCAGCA&quot; &quot;CJME_0707_ACCACTGTTGGCTTCACACTTCGA&quot;</span><br>       <br><span class="hljs-comment">#两个数据集的cell id不同，为了下面的数据合并，需要将两个数据集的id修改成一致</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> ldat<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br> assay <span class="hljs-operator">&lt;-</span> ldat<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br> colnames<span class="hljs-punctuation">(</span>assay<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> gsub<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;:&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;_&#x27;</span><span class="hljs-punctuation">,</span> colnames<span class="hljs-punctuation">(</span>assay<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br> colnames<span class="hljs-punctuation">(</span>assay<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> gsub<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;x&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-punctuation">,</span> colnames<span class="hljs-punctuation">(</span>assay<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br> colnames<span class="hljs-punctuation">(</span>assay<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> gsub<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;-&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;_&#x27;</span><span class="hljs-punctuation">,</span> colnames<span class="hljs-punctuation">(</span>assay<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br> assay <span class="hljs-operator">&lt;-</span> assay<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>colnames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br> scRNA<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> CreateAssayObject<span class="hljs-punctuation">(</span>counts <span class="hljs-operator">=</span> assay<span class="hljs-punctuation">)</span><br> <span class="hljs-punctuation">&#125;</span>       <br>tail<span class="hljs-punctuation">(</span>colnames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#[1] &quot;nCount_spliced&quot;     &quot;nFeature_spliced&quot;   &quot;nCount_unspliced&quot;   &quot;nFeature_unspliced&quot; &quot;nCount_ambiguous&quot;   &quot;nFeature_ambiguous&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_23bda54f50cbb4ca07a0066500da6feb.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment">##运行RNA速率</span><br>sce_Velocity <span class="hljs-operator">&lt;-</span> RunVelocity<span class="hljs-punctuation">(</span>object <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">,</span> <span class="hljs-comment">#seurat对象，但是包含我们前面整合的RNA速率loom</span><br>                            deltaT <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                            kCells <span class="hljs-operator">=</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span><br>                            reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;scVIUMAP2D&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">#降维信息                        </span><br>                            fit.quantile <span class="hljs-operator">=</span> <span class="hljs-number">0.02</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_516574b7e00bd1af09a85d5e0cc2d5d6.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs R"> emb <span class="hljs-operator">=</span> Embeddings<span class="hljs-punctuation">(</span>object <span class="hljs-operator">=</span> scRNA<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;scVIUMAP2D&quot;</span><span class="hljs-punctuation">)</span><br> p <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;scVIUMAP2D&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>scale_color_manual<span class="hljs-punctuation">(</span>values <span class="hljs-operator">=</span> dittoColors<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>theme_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br> colors <span class="hljs-operator">&lt;-</span> as.list<span class="hljs-punctuation">(</span>ggplot_build<span class="hljs-punctuation">(</span>p<span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>colour<span class="hljs-punctuation">)</span><span class="hljs-comment">#提取细胞颜色</span><br> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>colors<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>emb<span class="hljs-punctuation">)</span><span class="hljs-comment">#将颜色与细胞坐标匹配</span><br> <span class="hljs-comment">#定义一个函数，用来添加cell type名称,实质是获取细胞坐标，计算每个组的中心点 </span><br> label_clusters <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>labels<span class="hljs-punctuation">,</span> coords<span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br> df <span class="hljs-operator">&lt;-</span> tibble<span class="hljs-punctuation">(</span>label <span class="hljs-operator">=</span> labels<span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> coords<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> coords<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br> df <span class="hljs-operator">&lt;-</span> df <span class="hljs-operator">%&gt;%</span><br> group_by<span class="hljs-punctuation">(</span>label<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br> summarize<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> median<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> median<span class="hljs-punctuation">(</span>y<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br> text<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>x<span class="hljs-punctuation">,</span> df<span class="hljs-operator">$</span>y<span class="hljs-punctuation">,</span> df<span class="hljs-operator">$</span>label<span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">)</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">#绘图</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Seurat聚类</title>
    <link href="/2024/05/31/Seurat%E8%81%9A%E7%B1%BB/"/>
    <url>/2024/05/31/Seurat%E8%81%9A%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="Seurat-CCA进行聚类"><a href="#Seurat-CCA进行聚类" class="headerlink" title="Seurat CCA进行聚类"></a>Seurat CCA进行聚类</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>librar<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br>fileNames <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;./test.qs&quot;</span><br>scRNAlist <span class="hljs-operator">&lt;-</span> qread<span class="hljs-punctuation">(</span>fileName<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#seurat list标准化及高变基因筛选</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>obj_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    obj_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>obj_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>    obj_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>obj_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> selection.method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;vst&quot;</span><span class="hljs-punctuation">,</span> <br>        nfeatures <span class="hljs-operator">=</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">#find anchor</span><br>anchors <span class="hljs-operator">=</span> FindIntegrationAnchors<span class="hljs-punctuation">(</span>obj_list<span class="hljs-punctuation">,</span> dims<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>integrated <span class="hljs-operator">=</span> IntegrateData<span class="hljs-punctuation">(</span>anchors<span class="hljs-punctuation">,</span> dims<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br><br>DefaultAssay<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">)</span><span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;integrated&quot;</span><br><br>integrated <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">)</span><br>integrated <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> npcs<span class="hljs-operator">=</span><span class="hljs-number">40</span><span class="hljs-punctuation">)</span><br>integrated <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span>dims<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br><br>integrated <span class="hljs-operator">=</span> FindNeighbors<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> dims<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>integrated <span class="hljs-operator">=</span> FindClusters<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.3</span><span class="hljs-punctuation">)</span><br>folder <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;./&quot;</span><br>version <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;SeuratV4&quot;</span><br>pdf<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>folder<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_&quot;</span><span class="hljs-punctuation">,</span>version<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_clusters.pdf&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">8.5</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">11</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> pt.size<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br>pdf<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>folder<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_&quot;</span><span class="hljs-punctuation">,</span>version<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_batch.pdf&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">8.5</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">11</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> pt.size<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;orig.ident&quot;</span><span class="hljs-punctuation">,</span>label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#save file</span><br>qsave<span class="hljs-punctuation">(</span>integrated<span class="hljs-punctuation">,</span> file<span class="hljs-operator">=</span>paste0<span class="hljs-punctuation">(</span>folder<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;_&quot;</span><span class="hljs-punctuation">,</span>version<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;.qs&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>javascript基础01</title>
    <link href="/2024/05/30/javascript%E5%9F%BA%E7%A1%8001/"/>
    <url>/2024/05/30/javascript%E5%9F%BA%E7%A1%8001/</url>
    
    <content type="html"><![CDATA[<h1 id="javascript中的基础数据类型01"><a href="#javascript中的基础数据类型01" class="headerlink" title="javascript中的基础数据类型01"></a>javascript中的基础数据类型01</h1><h2 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>javascript中数值只有一种类型，没有细分出浮点型和整型。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> num1 = <span class="hljs-number">123</span><br><span class="hljs-keyword">let</span>  num2 = <span class="hljs-number">123.5</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> num1,<span class="hljs-string">&#x27;\t&#x27;</span>,<span class="hljs-keyword">typeof</span> num2)<br><span class="hljs-comment">//输出内容：number number</span><br></code></pre></td></tr></table></figure><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><h4 id="算术运算"><a href="#算术运算" class="headerlink" title="算术运算"></a>算术运算</h4><blockquote><p>注意区分++a 和 a++的区别，一个是先运算再赋值，一个是先赋值再运算。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"># 加 + 减 - 乘 * 除 / 求余 % 自增++ 自减 --<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num1 + num2)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num1 - num2)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num1 * num2)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num1 / num2)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num1 % num2)<br><br><span class="hljs-comment">//246.5</span><br><span class="hljs-comment">//-0.5</span><br><span class="hljs-comment">//15190.5</span><br><span class="hljs-comment">//0.9959514170040485</span><br><span class="hljs-comment">//123</span><br></code></pre></td></tr></table></figure><h4 id="比较运算"><a href="#比较运算" class="headerlink" title="比较运算"></a>比较运算</h4><ul><li>等于 (<code>==</code>)：值相等</li><li>全等 (<code>===</code>) : 值相同，同时类型也相同</li><li>不等于 (<code>!=</code>)：值不相等</li><li>不全等 (<code>!==</code>)：值不相同同时类型也不相同</li><li>大于 (<code>&gt;</code>)</li><li>小于 (<code>&lt;</code>)</li><li>大于等于 (<code>&gt;=</code>)</li><li>小于等于 (<code>&lt;=</code>)</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> num3 = <span class="hljs-number">123</span><br><span class="hljs-keyword">let</span> num4 = <span class="hljs-number">123.00</span><br>result = num3 === num4 ? <span class="hljs-string">&quot;全等&quot;</span>:<span class="hljs-string">&quot;不全等&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)<br><span class="hljs-comment">// 全等</span><br></code></pre></td></tr></table></figure><h4 id="赋值运算"><a href="#赋值运算" class="headerlink" title="赋值运算"></a>赋值运算</h4><ul><li>赋值 (<code>=</code>)</li><li>加等于 (<code>+=</code>)</li><li>减等于 (<code>-=</code>)</li><li>乘等于 (<code>*=</code>)</li><li>除等于 (<code>/=</code>)</li><li>取余等于 (<code>%=</code>)</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num1 += num1)<br><span class="hljs-comment">//246</span><br></code></pre></td></tr></table></figure><h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><ul><li>Number()构造函数，<code>Number</code> 构造函数也可以用来将其他类型的值转换为数值</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> str1 = <span class="hljs-string">&quot;BSS&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(str1)) <span class="hljs-comment">// NaN</span><br><span class="hljs-keyword">let</span> str2 = <span class="hljs-string">&quot;1234n&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(str2)) <span class="hljs-comment">// NaN</span><br><span class="hljs-keyword">let</span> <span class="hljs-title class_">Num1</span> = <span class="hljs-string">&quot;123&quot;</span> <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-title class_">Num1</span>)) <span class="hljs-comment">// 123</span><br><span class="hljs-keyword">let</span> <span class="hljs-title class_">Num2</span> = <span class="hljs-number">123213423414123432n</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-title class_">Num2</span>)) <span class="hljs-comment">//123213423414123420</span><br></code></pre></td></tr></table></figure><ul><li><code>parseInt()</code>和<code>parseFloat()</code>进行字符串到整数或浮点数的转换，注意如果字符串开头不是数字，则直接返回NaN，不会对下面的数据进行检查。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">Str1</span> = <span class="hljs-string">&quot;12312334ab&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">parseInt</span>(<span class="hljs-title class_">Str1</span>)) <span class="hljs-comment">//12312334</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">parseFloat</span>(<span class="hljs-title class_">Str1</span>)) <span class="hljs-comment">//12312334</span><br><br><span class="hljs-keyword">let</span> <span class="hljs-title class_">Str2</span> = <span class="hljs-string">&quot;ab12312334&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">parseInt</span>(<span class="hljs-title class_">Str2</span>)) <span class="hljs-comment">//NaN</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">parseFloat</span>(<span class="hljs-title class_">Str2</span>)) <span class="hljs-comment">//NaN</span><br></code></pre></td></tr></table></figure><h4 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(-<span class="hljs-number">1</span>)) <span class="hljs-comment">//1</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(<span class="hljs-number">10</span>)) <span class="hljs-comment">//22026.465794806718</span><br><span class="hljs-comment">//Math.round()等</span><br></code></pre></td></tr></table></figure><h4 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h4><ul><li><code>toString()</code> 主要是用于将数字转换为字符串（可以是任何进制），而 <code>toFixed()</code> 是用于将数字格式化为具有指定小数位数的字符串。</li><li><strong>四舍五入</strong>：<code>toString()</code> 不会进行四舍五入，它只是简单地将数字转换为字符串。而 <code>toFixed()</code> 会根据指定的小数位数对数字进行四舍五入。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-variable constant_">H1</span> = <span class="hljs-number">123</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">H1</span>.<span class="hljs-title function_">toString</span>()) <span class="hljs-comment">//123</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">H1</span>.<span class="hljs-title function_">toFixed</span>()) <span class="hljs-comment">//123</span><br><br><span class="hljs-keyword">let</span> num = <span class="hljs-number">123</span>;  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// 输出: &quot;123&quot;  </span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toString</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// 输出: &quot;1111011&quot; (二进制)  </span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)); <span class="hljs-comment">// 输出: &quot;7b&quot; (十六进制)</span><br><br><span class="hljs-keyword">let</span> num = <span class="hljs-number">123.456789</span>;  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// 输出: &quot;123.46&quot;  </span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">4</span>)); <span class="hljs-comment">// 输出: &quot;123.4568&quot;</span><br></code></pre></td></tr></table></figure><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>在 JavaScript 中，你可以选择单引号（<code>&#39;</code>）、双引号（<code>&quot;</code>）或反引号（&#96;&#96;&#96;）来包裹字符串。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> single = <span class="hljs-string">&#x27;单引号&#x27;</span><br><span class="hljs-keyword">const</span> double = <span class="hljs-string">&quot;双引号&quot;</span><br><span class="hljs-keyword">const</span> backtick = <span class="hljs-string">`反引号`</span><br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(single)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(double)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(backtick)<br></code></pre></td></tr></table></figure><h3 id="模版字面量"><a href="#模版字面量" class="headerlink" title="模版字面量"></a>模版字面量</h3><p>javascript中也有类似shell脚本中的模版字面量，使用${}</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">Str3</span> = <span class="hljs-string">&quot;ABC&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`this is a <span class="hljs-subst">$&#123;Str3&#125;</span>`</span>) <span class="hljs-comment">//this is a ABC</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`this result is <span class="hljs-subst">$&#123;(<span class="hljs-number">1</span>+<span class="hljs-number">2</span>+<span class="hljs-string">&quot;123&quot;</span>)&#125;</span>`</span>) <span class="hljs-comment">// this result is 3123</span><br></code></pre></td></tr></table></figure><h3 id="大小写转换"><a href="#大小写转换" class="headerlink" title="大小写转换"></a>大小写转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span>.<span class="hljs-title function_">toLowerCase</span>()) <span class="hljs-comment">//abc</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span>.<span class="hljs-title function_">toUpperCase</span>()) <span class="hljs-comment">//ABC</span><br></code></pre></td></tr></table></figure><h3 id="字符串长度"><a href="#字符串长度" class="headerlink" title="字符串长度"></a>字符串长度</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span>.<span class="hljs-property">length</span>) <span class="hljs-comment">//3</span><br></code></pre></td></tr></table></figure><h3 id="字符串分割"><a href="#字符串分割" class="headerlink" title="字符串分割"></a>字符串分割</h3><p>字符串切割返回的结果是数据类型。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>)) <span class="hljs-comment">//[ &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27; ] </span><br><span class="hljs-keyword">let</span> <span class="hljs-title class_">Str4</span> = <span class="hljs-string">&quot;A|B|C&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str4</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;|&quot;</span>))<span class="hljs-comment">//[ &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27; ] </span><br></code></pre></td></tr></table></figure><h3 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span> + <span class="hljs-string">&#x27;_&#x27;</span>+  <span class="hljs-title class_">Str4</span>) <span class="hljs-comment">//ABC_A|B|C</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Str4</span>)) <span class="hljs-comment">//ABCA|B|C</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str3</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Str4</span>,<span class="hljs-title class_">Str4</span>,str1)) <span class="hljs-comment">//ABCA|B|CA|B|CBSS</span><br></code></pre></td></tr></table></figure><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul><li><code>slice(start, end)</code>: 返回从 <code>start</code> 到 <code>end</code>（不包括 <code>end</code>）的字符串部分。</li><li><code>substring(start, end)</code>: 与 <code>slice()</code> 类似，但不接受负索引。</li><li><code>substr(start, length)</code>: 返回从 <code>start</code> 开始的，长度为 <code>length</code> 的字符串部分。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;Hello&quot;</span>;  <br><span class="hljs-keyword">let</span> firstChar = str[<span class="hljs-number">0</span>]; <span class="hljs-comment">// &quot;H&quot;</span><br><br><span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;Hello, world!&quot;</span>;  <br><span class="hljs-keyword">let</span> sliced = str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">7</span>, <span class="hljs-number">12</span>); <span class="hljs-comment">// &quot;world&quot;</span><br><br><span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;Hello, world!&quot;</span>;  <br><span class="hljs-keyword">let</span> replaced = str.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&quot;world&quot;</span>, <span class="hljs-string">&quot;JavaScript&quot;</span>); <span class="hljs-comment">// &quot;Hello, JavaScript!&quot;</span><br></code></pre></td></tr></table></figure><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><ul><li><code>indexOf(searchString, position)</code>: 返回指定字符串值在字符串中<strong>首次出现的位置</strong>，从指定的位置开始搜索。</li><li><code>lastIndexOf(searchString, position)</code>: 返回指定字符串值在字符串中<strong>最后出现的位置</strong>，从指定的位置开始反向搜索。</li><li><code>includes(searchString, position)</code>: 判断字符串是否包含指定的子串，返回布尔值。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">Str5</span> = <span class="hljs-string">&quot;hello world I use javascript&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str5</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;I&quot;</span>)) <span class="hljs-comment">// 12</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str5</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;java&quot;</span>))<span class="hljs-comment">//18</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str5</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;java&quot;</span>))<span class="hljs-comment">//true</span><br></code></pre></td></tr></table></figure><h3 id="字符串去除空格"><a href="#字符串去除空格" class="headerlink" title="字符串去除空格"></a>字符串去除空格</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">Str6</span> = <span class="hljs-string">&quot; ACD  &quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str6</span>.<span class="hljs-title function_">trim</span>())<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str6</span>.<span class="hljs-title function_">trimStart</span>())<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str6</span>.<span class="hljs-title function_">trimEnd</span>())<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_105e49d794f3fa840a32979b7314d708.png"> </p><h3 id="判断开头和结尾"><a href="#判断开头和结尾" class="headerlink" title="判断开头和结尾"></a>判断开头和结尾</h3><p>startsWith()和endsWith()返回布尔值</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str5</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;hello&quot;</span>))<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Str5</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;hello&quot;</span>))<br></code></pre></td></tr></table></figure><h2 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h2><p>javascript中的布尔值只有两个，分布是true和false，全是小写字母</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;test1&quot;</span>)<br>&#125; <span class="hljs-comment">//test1</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hdWGCNA中ModuleFeaturePlot分组进行绘图</title>
    <link href="/2024/05/30/hdWGCNA%E4%B8%ADModuleFeaturePlot%E5%88%86%E7%BB%84%E8%BF%9B%E8%A1%8C%E7%BB%98%E5%9B%BE-1/"/>
    <url>/2024/05/30/hdWGCNA%E4%B8%ADModuleFeaturePlot%E5%88%86%E7%BB%84%E8%BF%9B%E8%A1%8C%E7%BB%98%E5%9B%BE-1/</url>
    
    <content type="html"><![CDATA[<h2 id="hdWGCNA中ModuleFeaturePlot分组进行绘图"><a href="#hdWGCNA中ModuleFeaturePlot分组进行绘图" class="headerlink" title="hdWGCNA中ModuleFeaturePlot分组进行绘图"></a>hdWGCNA中ModuleFeaturePlot分组进行绘图</h2><h3 id="提取数据绘图"><a href="#提取数据绘图" class="headerlink" title="提取数据绘图"></a>提取数据绘图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs R">plot_score <span class="hljs-operator">&lt;-</span> ModuleFeaturePlot<span class="hljs-punctuation">(</span><br>    scRNA<span class="hljs-punctuation">,</span><br>    reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span><br>    features<span class="hljs-operator">=</span><span class="hljs-string">&#x27;hMEs&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># plot the hMEs</span><br>    order<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><span class="hljs-comment"># order so the points with highest hMEs are on top</span><br>    raster <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span><br>    ucell <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># [1] &quot;M1&quot;</span><br><span class="hljs-comment"># [1] &quot;M2&quot;</span><br><span class="hljs-comment"># [1] &quot;M3&quot;</span><br><span class="hljs-comment"># [1] &quot;M4&quot;</span><br><span class="hljs-comment"># [1] &quot;M5&quot;</span><br><span class="hljs-comment"># [1] &quot;M6&quot;</span><br><span class="hljs-comment"># [1] &quot;M7&quot;</span><br><span class="hljs-comment"># [1] &quot;M8&quot;</span><br><span class="hljs-comment"># [1] &quot;M9&quot;</span><br></code></pre></td></tr></table></figure><p>查看输出结果plot_score的结构</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">str<span class="hljs-punctuation">(</span>plot_score<span class="hljs-punctuation">,</span>max.level<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>存放绘图数据的位置：</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_cbdf0dd5f508cab46d4d67a75eb874dc.png"></p><p>查看数据格式</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">head<span class="hljs-punctuation">(</span>plot_score<span class="hljs-operator">$</span>M1<span class="hljs-operator">$</span>data<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_74dac19c986cadaf9ed8bc54f50ba946.png"></p><p>数据格式中rowname是细胞barcode，可以根据barcode信息添加在数据中添加其他的分组信息，以Seurat对象中的seurat_clusters为例。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_d8cb60099441f080ae4298f411f58569.png"></p><p>合并meta.data中的seurat_clusters和plot_score$M1$data数据</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 提取ModuleFeaturePlot绘图数据</span><br>test_data <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>plot_score<span class="hljs-operator">$</span>M1<span class="hljs-operator">$</span>data<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>tibble<span class="hljs-operator">::</span>rownames_to_column<span class="hljs-punctuation">(</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;cells&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-comment">#提取数据，将rownames改成列信息</span><br>head<span class="hljs-punctuation">(</span>test_data<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                  cells    UMAP_1     UMAP_2       val</span><br><span class="hljs-comment"># 1 GCAACCGCACATGGTT-1_3 -3.200459 -11.816769 -21.05015</span><br><span class="hljs-comment"># 2 GTTTGGAGTCCCAAAT-1_3 -8.262880  -3.907730 -20.83909</span><br><span class="hljs-comment"># 3 CCTCACAAGTCGAATA-1_3 -8.832568  -3.866324 -20.35668</span><br><span class="hljs-comment"># 4 GACCGTGTCTTCCCAG-1_3 -6.792917   5.364767 -20.29601</span><br><span class="hljs-comment"># 5 TGCGGCATCGTGCAGC-1_3 -8.499278  -4.433219 -20.13161</span><br><span class="hljs-comment"># 6 GGCAGTCTCTGAGGCC-1_3 -8.477210  -3.853339 -20.11608</span><br><br><span class="hljs-comment"># 提取分组信息</span><br>group_data <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span><span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>tibble<span class="hljs-operator">::</span>rownames_to_column<span class="hljs-punctuation">(</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;cells&#x27;</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>group_data<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                  cells seurat_clusters</span><br><span class="hljs-comment"># 1 AAACCCAAGGGTGAAA-1_1               7</span><br><span class="hljs-comment"># 2 AAACCCAAGGTGATAT-1_1              12</span><br><span class="hljs-comment"># 3 AAACCCAGTGCAATGG-1_1               5</span><br><span class="hljs-comment"># 4 AAACCCAGTTGAGTCT-1_1               2</span><br><span class="hljs-comment"># 5 AAACCCATCAGTCTTT-1_1               0</span><br><span class="hljs-comment"># 6 AAACGAAAGAAGGCTC-1_1              13</span><br><br><span class="hljs-comment"># 合并绘图数据和分组信息</span><br>test_data <span class="hljs-operator">&lt;-</span> test_data <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>left_join<span class="hljs-punctuation">(</span>group_data<span class="hljs-punctuation">,</span>by<span class="hljs-operator">=</span><span class="hljs-string">&quot;cells&quot;</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>test_data<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                  cells    UMAP_1     UMAP_2       val seurat_clusters</span><br><span class="hljs-comment"># 1 GCAACCGCACATGGTT-1_3 -3.200459 -11.816769 -21.05015               1</span><br><span class="hljs-comment"># 2 GTTTGGAGTCCCAAAT-1_3 -8.262880  -3.907730 -20.83909               2</span><br><span class="hljs-comment"># 3 CCTCACAAGTCGAATA-1_3 -8.832568  -3.866324 -20.35668               2</span><br><span class="hljs-comment"># 4 GACCGTGTCTTCCCAG-1_3 -6.792917   5.364767 -20.29601               0</span><br><span class="hljs-comment"># 5 TGCGGCATCGTGCAGC-1_3 -8.499278  -4.433219 -20.13161               2</span><br><span class="hljs-comment"># 6 GGCAGTCTCTGAGGCC-1_3 -8.477210  -3.853339 -20.11608               2</span><br></code></pre></td></tr></table></figure><p>绘图</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 设置颜色范围</span><br>restrict_range <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">TRUE</span><br>plot_range <span class="hljs-operator">&lt;-</span> test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">%&gt;%</span> <span class="hljs-built_in">range</span><br><span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>restrict_range<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">abs</span><span class="hljs-punctuation">(</span>plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&gt;</span> <span class="hljs-built_in">abs</span><span class="hljs-punctuation">(</span>plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span> <span class="hljs-operator">*</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>        plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span> <span class="hljs-operator">*</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>    test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span><br>        plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>    test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;</span><br>        plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> test_data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;val&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment"># 绘图</span><br>test_data <span class="hljs-operator">%&gt;%</span> ggplot<span class="hljs-punctuation">(</span>aes_string<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP_1&#x27;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP_2&#x27;</span><span class="hljs-punctuation">,</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;val&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>        geom_point<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0.6</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>        theme_classic<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        ggtitle<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;test Model&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> <br>        scale_color_gradient<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey95&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span><br>                breaks <span class="hljs-operator">=</span> plot_range<span class="hljs-punctuation">,</span> labels <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;+&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <br>                guide <span class="hljs-operator">=</span> guide_colorbar<span class="hljs-punctuation">(</span>ticks <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>                barwidth <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> barheight <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>facet_wrap<span class="hljs-punctuation">(</span>.<span class="hljs-operator">~</span>seurat_clusters<span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>scales <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;free&#x27;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_f5eeaa30c8d4668a513cac062c398843.png"></p><h3 id="修改原函数"><a href="#修改原函数" class="headerlink" title="修改原函数"></a>修改原函数</h3><p>对R包原绘图函数进行修改，修该如下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs R">ModuleFeaturePlot_02 <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span> <span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> module_names <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> wgcna_name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>    reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hMEs&quot;</span><span class="hljs-punctuation">,</span> order_points <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>    restrict_range <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> point_size <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> label_legend <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>    ucell <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> raster_dpi <span class="hljs-operator">=</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span> raster_scale <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    plot_ratio <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> title <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> split.by<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>ncol<span class="hljs-operator">=</span><span class="hljs-number">8</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>wgcna_name<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        wgcna_name <span class="hljs-operator">&lt;-</span> seurat_obj<span class="hljs-operator">@</span>misc<span class="hljs-operator">$</span>active_wgcna<br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>features <span class="hljs-operator">==</span> <span class="hljs-string">&quot;hMEs&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        MEs <span class="hljs-operator">&lt;-</span> GetMEs<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> wgcna_name<span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>features <span class="hljs-operator">==</span> <span class="hljs-string">&quot;MEs&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        MEs <span class="hljs-operator">&lt;-</span> GetMEs<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> wgcna_name<span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>features <span class="hljs-operator">==</span> <span class="hljs-string">&quot;scores&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        MEs <span class="hljs-operator">&lt;-</span> GetModuleScores<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> wgcna_name<span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>features <span class="hljs-operator">==</span> <span class="hljs-string">&quot;average&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        MEs <span class="hljs-operator">&lt;-</span> GetAvgModuleExpr<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> wgcna_name<span class="hljs-punctuation">)</span><br>        restrict_range <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">FALSE</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">(</span>stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Invalid feature selection. Valid choices: hMEs, MEs, scores, average&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>ucell<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        restrict_range <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">FALSE</span><br>    <span class="hljs-punctuation">&#125;</span><br>    modules <span class="hljs-operator">&lt;-</span> GetModules<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> wgcna_name<span class="hljs-punctuation">)</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>module_names<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        module_names <span class="hljs-operator">&lt;-</span> levels<span class="hljs-punctuation">(</span>modules<span class="hljs-operator">$</span>module<span class="hljs-punctuation">)</span><br>        module_names <span class="hljs-operator">&lt;-</span> module_names<span class="hljs-punctuation">[</span>module_names <span class="hljs-operator">!=</span> <span class="hljs-string">&quot;grey&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>split.by<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>            umap <span class="hljs-operator">&lt;-</span> seurat_obj<span class="hljs-operator">@</span>reductions<span class="hljs-punctuation">[[</span>reduction<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>cell.embeddings<br>            x_name <span class="hljs-operator">&lt;-</span> colnames<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>            y_name <span class="hljs-operator">&lt;-</span> colnames<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><br>            plot_df <span class="hljs-operator">&lt;-</span> cbind<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">,</span> MEs<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> as.data.frame<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>            print<span class="hljs-punctuation">(</span>head<span class="hljs-punctuation">(</span>plot_df<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span>split.by <span class="hljs-operator">%in%</span> colnames<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>            umap <span class="hljs-operator">&lt;-</span> seurat_obj<span class="hljs-operator">@</span>reductions<span class="hljs-punctuation">[[</span>reduction<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">@</span>cell.embeddings<br>            x_name <span class="hljs-operator">&lt;-</span> colnames<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>            y_name <span class="hljs-operator">&lt;-</span> colnames<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><br>            plot_df <span class="hljs-operator">&lt;-</span> cbind<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">,</span> MEs<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> as.data.frame<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>            plot_df <span class="hljs-operator">&lt;-</span> plot_df<span class="hljs-punctuation">[</span>rownames<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br>            plot_df <span class="hljs-operator">&lt;-</span> cbind<span class="hljs-punctuation">(</span>plot_df<span class="hljs-punctuation">,</span>seurat_obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span>split.by<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>           stop<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Column %s is not in Seurat Object,check again!&quot;</span><span class="hljs-punctuation">,</span>split.by<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>    plot_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>cur_mod <span class="hljs-keyword">in</span> module_names<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        print<span class="hljs-punctuation">(</span>cur_mod<span class="hljs-punctuation">)</span><br>        cur_color <span class="hljs-operator">&lt;-</span> modules <span class="hljs-operator">%&gt;%</span> subset<span class="hljs-punctuation">(</span>module <span class="hljs-operator">==</span> cur_mod<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>            .<span class="hljs-operator">$</span>color <span class="hljs-operator">%&gt;%</span> unique<br>        plot_range <span class="hljs-operator">&lt;-</span> plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span> <span class="hljs-operator">%&gt;%</span> <span class="hljs-built_in">range</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>restrict_range<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">abs</span><span class="hljs-punctuation">(</span>plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&gt;</span> <span class="hljs-built_in">abs</span><span class="hljs-punctuation">(</span>plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>                plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span> <span class="hljs-operator">*</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>                plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span> <span class="hljs-operator">*</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>            plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span> <span class="hljs-operator">&gt;</span><br>                plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>            plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;</span><br>                plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> plot_range<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        cur_plot_df <span class="hljs-operator">&lt;-</span> plot_df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>colnames<span class="hljs-punctuation">(</span>umap<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> cur_mod<span class="hljs-punctuation">,</span> split.by<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>        colnames<span class="hljs-punctuation">(</span>cur_plot_df<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">3</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&quot;val&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>order_points <span class="hljs-operator">==</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            cur_plot_df <span class="hljs-operator">&lt;-</span> cur_plot_df <span class="hljs-operator">%&gt;%</span> dplyr<span class="hljs-operator">::</span>arrange<span class="hljs-punctuation">(</span>val<span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>order_points <span class="hljs-operator">==</span> <span class="hljs-string">&quot;shuffle&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            cur_plot_df <span class="hljs-operator">&lt;-</span> cur_plot_df<span class="hljs-punctuation">[</span>sample<span class="hljs-punctuation">(</span>nrow<span class="hljs-punctuation">(</span>cur_plot_df<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>        p <span class="hljs-operator">&lt;-</span> cur_plot_df <span class="hljs-operator">%&gt;%</span> ggplot<span class="hljs-punctuation">(</span>aes_string<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> x_name<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> y_name<span class="hljs-punctuation">,</span><br>            color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;val&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>raster<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> ggrastr<span class="hljs-operator">::</span>rasterise<span class="hljs-punctuation">(</span>geom_point<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> point_size<span class="hljs-punctuation">,</span><br>                alpha <span class="hljs-operator">=</span> alpha<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> dpi <span class="hljs-operator">=</span> raster_dpi<span class="hljs-punctuation">,</span> scale <span class="hljs-operator">=</span> raster_scale<span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> geom_point<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> point_size<span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> alpha<span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> umap_theme<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span>title<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>cur_mod<span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">is.numeric</span><span class="hljs-punctuation">(</span>plot_ratio<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> coord_fixed<span class="hljs-punctuation">(</span>ratio <span class="hljs-operator">=</span> plot_ratio<span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-operator">!</span>ucell<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> scale_color_gradient2<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey75&quot;</span><span class="hljs-punctuation">,</span> mid <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey95&quot;</span><span class="hljs-punctuation">,</span><br>                high <span class="hljs-operator">=</span> cur_color<span class="hljs-punctuation">,</span> breaks <span class="hljs-operator">=</span> plot_range<span class="hljs-punctuation">,</span> labels <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;-&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-string">&quot;+&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> guide <span class="hljs-operator">=</span> guide_colorbar<span class="hljs-punctuation">(</span>ticks <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>                  barwidth <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> barheight <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span> scale_color_gradient<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grey95&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> cur_color<span class="hljs-punctuation">,</span><br>                breaks <span class="hljs-operator">=</span> plot_range<span class="hljs-punctuation">,</span> labels <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;+&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> guide <span class="hljs-operator">=</span> guide_colorbar<span class="hljs-punctuation">(</span>ticks <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>                  barwidth <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> barheight <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>split.by<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>split.by<span class="hljs-punctuation">)</span><span class="hljs-operator">==</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>            p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span>theme_test<span class="hljs-punctuation">(</span>base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>base_rect_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span>ggplot2<span class="hljs-operator">::</span>facet_wrap<span class="hljs-punctuation">(</span>formula<span class="hljs-punctuation">(</span>paste<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;~&quot;</span><span class="hljs-punctuation">,</span>split.by<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> ncol<span class="hljs-punctuation">)</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>split.by<span class="hljs-punctuation">)</span><span class="hljs-operator">==</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>                p <span class="hljs-operator">&lt;-</span> p <span class="hljs-operator">+</span>theme_test<span class="hljs-punctuation">(</span>base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>base_rect_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span>ggplot2<span class="hljs-operator">::</span>facet_wrap<span class="hljs-punctuation">(</span>formula<span class="hljs-punctuation">(</span>paste<span class="hljs-punctuation">(</span>split.by<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;~&quot;</span><span class="hljs-punctuation">,</span>split.by<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> ncol<span class="hljs-punctuation">)</span><br>            <span class="hljs-punctuation">&#125;</span> <br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-comment"># print(p)</span><br>        plot_list<span class="hljs-punctuation">[[</span>cur_mod<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> p<br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>plot_list<span class="hljs-punctuation">)</span> <span class="hljs-operator">==</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>        p <span class="hljs-operator">&lt;-</span> plot_list<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">&#123;</span><br>        p <span class="hljs-operator">&lt;-</span> plot_list<br>    <span class="hljs-punctuation">&#125;</span><br>    p<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>使用该函数进行绘图</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs R">plot_result <span class="hljs-operator">&lt;-</span> ModuleFeaturePlot_02<span class="hljs-punctuation">(</span><br>    scRNA<span class="hljs-punctuation">,</span><br>    reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span><br>    features<span class="hljs-operator">=</span><span class="hljs-string">&#x27;hMEs&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># plot the hMEs</span><br>    order<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><span class="hljs-comment"># order so the points with highest hMEs are on top</span><br>    raster <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span><br>    ucell <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>    split.by<span class="hljs-operator">=</span><span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 分组依据</span><br>    ncol<span class="hljs-operator">=</span><span class="hljs-number">8</span> <span class="hljs-comment"># 分面图列数</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>plot_result<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># [1] &quot;M1&quot; &quot;M2&quot; &quot;M3&quot; &quot;M4&quot; &quot;M5&quot; &quot;M6&quot; &quot;M7&quot; &quot;M8&quot; &quot;M9&quot;</span><br>plot_result<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_2437b624568c0c3f012d8309c604c3f7.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>单细胞hdWGCNA</title>
    <link href="/2024/05/30/%E5%8D%95%E7%BB%86%E8%83%9EhdWGCNA/"/>
    <url>/2024/05/30/%E5%8D%95%E7%BB%86%E8%83%9EhdWGCNA/</url>
    
    <content type="html"><![CDATA[<h1 id="hdWGCNA"><a href="#hdWGCNA" class="headerlink" title="hdWGCNA"></a>hdWGCNA</h1><p>部分流程来自公众号KS科研与服务。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># devtools::install_github(&#x27;smorabit/hdWGCNA&#x27;, ref=&#x27;dev&#x27;) #下载安装</span><br>library<span class="hljs-punctuation">(</span>hdWGCNA<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>WGCNA<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span> <br>library<span class="hljs-punctuation">(</span>tidyverse<span class="hljs-punctuation">)</span> <br>library<span class="hljs-punctuation">(</span>igraph<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>cowplot<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>stringr<span class="hljs-punctuation">)</span><br>theme_set<span class="hljs-punctuation">(</span>theme_cowplot<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">12345</span><span class="hljs-punctuation">)</span><br>enableWGCNAThreads<span class="hljs-punctuation">(</span>nThreads <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 读入数据</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/software/hdWGCNA-dev/test&#x27;</span><span class="hljs-punctuation">)</span><br>Test_data <span class="hljs-operator">&lt;-</span> readRDS<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Zhou_2020.rds&#x27;</span><span class="hljs-punctuation">)</span><br>colnames<span class="hljs-punctuation">(</span>Test_data<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#  [1] &quot;orig.ident&quot;              &quot;nCount_RNA&quot;              &quot;nFeature_RNA&quot;            &quot;orig_barcode&quot;            &quot;n_counts&quot;</span><br><span class="hljs-comment">#  [6] &quot;doublet_scores&quot;          &quot;doublets&quot;                &quot;Sample&quot;                  &quot;Study&quot;                   &quot;batch&quot;</span><br><span class="hljs-comment"># [11] &quot;barcode&quot;                 &quot;individualID&quot;            &quot;specimenID&quot;              &quot;group&quot;                   &quot;msex&quot;</span><br><span class="hljs-comment"># [16] &quot;apoe_genotype&quot;           &quot;age_death&quot;               &quot;pmi&quot;                     &quot;braaksc&quot;                 &quot;ceradsc&quot;</span><br><span class="hljs-comment"># [21] &quot;cogdx&quot;                   &quot;n_genes_by_counts&quot;       &quot;log1p_n_genes_by_counts&quot; &quot;total_counts&quot;            &quot;log1p_total_counts&quot;</span><br><span class="hljs-comment"># [26] &quot;total_counts_mt&quot;         &quot;log1p_total_counts_mt&quot;   &quot;pct_counts_mt&quot;           &quot;leiden&quot;                  &quot;cell_type&quot;</span><br><span class="hljs-comment"># [31] &quot;annotation&quot;              &quot;UMAP_1&quot;                  &quot;UMAP_2&quot;</span><br><br>unique<span class="hljs-punctuation">(</span>Test_data<span class="hljs-operator">$</span>batch<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#[1] 11 12 13 14 15 16 17 18 19 20 21</span><br>table<span class="hljs-punctuation">(</span>Test_data<span class="hljs-operator">$</span>batch<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#  11   12   13   14   15   16   17   18   19   20   21</span><br><span class="hljs-comment">#1788 3345 2333 1899 3002  711 6841 3320 2934 7618 2880</span><br>unique<span class="hljs-punctuation">(</span>Test_data<span class="hljs-operator">$</span>cell_type<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#[1] EX  INH ASC OPC MG  ODC</span><br><span class="hljs-comment">#Levels: INH EX OPC ODC ASC MG</span><br>p <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>seurat_obj<span class="hljs-punctuation">,</span> group.by<span class="hljs-operator">=</span><span class="hljs-string">&#x27;cell_type&#x27;</span><span class="hljs-punctuation">,</span> label<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>   umap_theme<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Zhou et al Control Cortex&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> NoLegend<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>p<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_2799ffd0e868128dcf0dd969224b1eb2.png"></p><blockquote></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>区分单细胞数据中真菌数据</title>
    <link href="/2024/05/30/%E5%8C%BA%E5%88%86%E5%8D%95%E7%BB%86%E8%83%9E%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%9C%9F%E8%8F%8C%E6%95%B0%E6%8D%AE/"/>
    <url>/2024/05/30/%E5%8C%BA%E5%88%86%E5%8D%95%E7%BB%86%E8%83%9E%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%9C%9F%E8%8F%8C%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="区分出单细胞数据中的细菌污染"><a href="#区分出单细胞数据中的细菌污染" class="headerlink" title="区分出单细胞数据中的细菌污染"></a>区分出单细胞数据中的细菌污染</h1><blockquote><p>博客文章：<a href="https://www.bilibili.com/read/cv24341361/">https://www.bilibili.com/read/cv24341361/</a></p></blockquote><p><strong>SAHMI</strong> 使得从宿主组织的基因组测序中系统地恢复和去噪微生物信号成为可能。该流程包括 R 命令行函数，这些函数执行以下主要步骤。</p><h2 id="Taxonomic-classification"><a href="#Taxonomic-classification" class="headerlink" title="Taxonomic classification"></a>Taxonomic classification</h2><blockquote><p>conda安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mamba search kraken2<br>mamba install -y  kraken2<br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查是否安装成功</span><br>kraken2 --version<br></code></pre></td></tr></table></figure><blockquote><p>kraken2 源码安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /root/wangje/software &amp;&amp; mkdir kraken2 &amp;&amp; cd ./kraken2<br>git clone https://github.com/DerrickWood/kraken2.git<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_fdf9c2ad4f784a0c1af2f6da05d7b2e9.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir src<br>./install_kraken2.sh ../src<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_84edf645bb678b7e9f8ef90bef4351b6.png"></p><p>查看编译的src目录中有什么内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tree -hL 2 ./src<br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_fc91a323ca5554a7b2dd13dedd14eed4.png"></p><p>将放有可执行程序的目录添加到环境变量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd src # 进入到存放<br>echo &quot;export PATH=$(pwd):\$PATH&quot; &gt;&gt; ~/.bashrc &amp;&amp; source ~/.bashrc<br><span class="hljs-meta prompt_">#</span><span class="language-bash">KRAKEN2_DIR=/root/wangje/software/kraken2/src</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">cp</span> <span class="hljs-variable">$KRAKEN2_DIR</span>/kraken2&#123;,-build,-inspect&#125; <span class="hljs-variable">$HOME</span>/bin</span><br></code></pre></td></tr></table></figure><blockquote><p>标准数据库的构建</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">DBNAME=/root/wangje/software/kraken2/db/2024<br>mkdir -p $DBNAME<br>kraken2-build --standard --threads  --db $DBNAME<br></code></pre></td></tr></table></figure><p>在进行建库的过程中可能会出现如下错误：</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_9bb5de1661365ee661c667ca6b3bfbf6.png"></p><p>尝试解决办法：</p><p><a href="https://blog.csdn.net/lanzhoushidabian/article/details/129599041">https://blog.csdn.net/lanzhoushidabian/article/details/129599041</a></p><p>对rsync_from_ncbi.pl文件内容替换成上面博客的内容，出现ftp问题，依然采用博客中的方法。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_452c3c5ea6bbbb8a940acf8fdaa87900.png"></p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_96faa22438463ea4704ec6da3327aedc.png"></p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_0e6b07674fcf87cfc6df417251fdb559.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">DBNAME=/root/wangje/software/kraken2/db/2024<br>kraken2-build --download-library plasmid  --threads 80 --db <span class="hljs-variable">$DBNAME</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>01单细胞文献数据</title>
    <link href="/2024/05/29/01%E5%8D%95%E7%BB%86%E8%83%9E%E6%96%87%E7%8C%AE%E6%95%B0%E6%8D%AE/"/>
    <url>/2024/05/29/01%E5%8D%95%E7%BB%86%E8%83%9E%E6%96%87%E7%8C%AE%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="单细胞文章数据使用"><a href="#单细胞文章数据使用" class="headerlink" title="单细胞文章数据使用"></a>单细胞文章数据使用</h1><blockquote><p>文章名: scRNA-seq profiling of breast cancer tumors, BRCA1 mutant pre-neoplastic mammary gland cells and normal mammary gland cells</p><p>文章链接：<a href="https://www.embopress.org/doi/full/10.15252/embj.2020107333">https://www.embopress.org/doi/full/10.15252/embj.2020107333</a></p><p>数据地址：<a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE161529">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE161529</a></p></blockquote><p>样本信息：</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_bfd48d0b6a82a75ad25fa0b39f18d152.png"></p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_1a042b91e7f2ec4f4fee990e31d60c6f.png"></p><h2 id="数据下载"><a href="#数据下载" class="headerlink" title="数据下载"></a>数据下载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 下载</span><br>wget -O GSE161529_RAW.tar https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE161529 <br>wget -O GSE161529_features.tsv.gz https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE161529&amp;format=file&amp;file=GSE161529%5Ffeatures%2Etsv%2Egz<br><span class="hljs-comment"># 解包解压</span><br>tar -xvf GSE161529_RAW.tar<br>gunzip GSE161529_features.tsv.gz<br></code></pre></td></tr></table></figure><h2 id="将数据转换成R包Seurat输入格式"><a href="#将数据转换成R包Seurat输入格式" class="headerlink" title="将数据转换成R包Seurat输入格式"></a>将数据转换成R包Seurat输入格式</h2><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_e404480bf9542f14dbc1b12c515a266e.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> *.gz &gt;&gt; sample.txt<br><span class="hljs-built_in">cd</span> /root/wangje/Project/GSE161529<br>baseDir=/root/wangje/Project/GSE161529<br><span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r line; <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">mkdir</span> -p  <span class="hljs-variable">$&#123;<span class="hljs-variable">$&#123;<span class="hljs-variable">$&#123;line&#125;</span>#*_&#125;</span>%-*&#125;</span><br>  pp=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$line</span>&quot;</span> | awk -F <span class="hljs-string">&#x27;-&#x27;</span> <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span>)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$pp</span><br>  dir_name=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;line#*_&#125;</span>&quot;</span><br>  dir_name=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;dir_name%-*&#125;</span>&quot;</span><br>  target_dir=<span class="hljs-string">&quot;./<span class="hljs-variable">$&#123;dir_name&#125;</span>&quot;</span><br>  target_link=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;target_dir&#125;</span>/<span class="hljs-variable">$&#123;pp&#125;</span>&quot;</span><br>  <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$target_dir</span>&quot;</span><br>  <span class="hljs-built_in">ln</span> -s <span class="hljs-string">&quot;<span class="hljs-variable">$baseDir</span>/<span class="hljs-variable">$line</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$target_link</span>&quot;</span><br>  <span class="hljs-built_in">ln</span> -s <span class="hljs-string">&quot;<span class="hljs-variable">$baseDir</span>/features.tsv.gz&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$target_dir</span>/features.tsv.gz&quot;</span><br><span class="hljs-keyword">done</span> &lt; <span class="hljs-string">&quot;./sample.txt&quot;</span><br></code></pre></td></tr></table></figure><p>样本数据中包括了样本上皮细胞数据和样本的淋巴结数据，这两个数据可以先不使用。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_8e65ab087ffbddd864c8f490e90b8fe5.png"></p><h2 id="生成Seurat对象数据"><a href="#生成Seurat对象数据" class="headerlink" title="生成Seurat对象数据"></a>生成Seurat对象数据</h2><blockquote><p>这里使用的Seurat Version 4.4.3</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs R">suppressMessages<span class="hljs-punctuation">(</span>suppressWarnings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span><br>  library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span> <span class="hljs-comment"># 4.3</span><br>  library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>SCP<span class="hljs-punctuation">)</span> <span class="hljs-comment"># plot</span><br>  library<span class="hljs-punctuation">(</span>scCustomize<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ggpubr<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ggsignif<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ComplexHeatmap<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>harmony<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>pheatmap<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>grid<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>gridExtra<span class="hljs-punctuation">)</span><br>  library<span class="hljs-punctuation">(</span>qs<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;/root/wangje/Project/GSE161529&#x27;</span><span class="hljs-punctuation">)</span><br>dirName <span class="hljs-operator">&lt;-</span> gsub<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-punctuation">,</span>list.dirs<span class="hljs-punctuation">(</span>path <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;.&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_3b98060d1db5b22aea32948030380423.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 去除上皮细胞和淋巴结的数据</span><br>dirName <span class="hljs-operator">&lt;-</span> dirName<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span>grep<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Epi|LN&#x27;</span><span class="hljs-punctuation">,</span>dirName<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>scRNAlist <span class="hljs-operator">&lt;-</span> setNames<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span>dirName<span class="hljs-punctuation">,</span>FUN<span class="hljs-operator">=</span><span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    message<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><br>    RenameCells<span class="hljs-punctuation">(</span>CreateSeuratObject<span class="hljs-punctuation">(</span>Read10X<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>min.cells <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>min.features <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>add.cell.id<span class="hljs-operator">=</span>x<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>dirName<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_7f3cb8689f517e6798834a9096856296.png"></p><blockquote><p>查看数据分布</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment">#合并数据</span><br>scRNA <span class="hljs-operator">&lt;-</span> merge<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>scRNAlist<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>scRNA<br><span class="hljs-comment"># n object of class Seurat</span><br><span class="hljs-comment"># 25503 features across 329921 samples within 1 assay</span><br><span class="hljs-comment"># Active assay: RNA (25503 features, 0 variable features)</span><br><span class="hljs-comment">#  2 layers present: counts, data</span><br>library<span class="hljs-punctuation">(</span>magrittr<span class="hljs-punctuation">)</span><br>scRNA <span class="hljs-operator">%&lt;&gt;%</span> PercentageFeatureSet<span class="hljs-punctuation">(</span>pattern <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;^MT-&#x27;</span><span class="hljs-punctuation">,</span>col.name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><br>scRNA<span class="hljs-operator">$</span>sample <span class="hljs-operator">&lt;-</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;_[A|T|G|C].*&#x27;</span><span class="hljs-punctuation">,</span> n <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br> unique<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>sample<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#  [1] &quot;B1-KCF0894&quot;     &quot;B1-MH0023&quot;      &quot;B1-MH0033&quot;      &quot;B1-MH0090&quot;      &quot;ER-AH0319&quot;      &quot;ER-MH0001&quot;      &quot;ER-MH0025&quot;      &quot;ER-MH0029-7C&quot;</span><br><span class="hljs-comment">#  [9] &quot;ER-MH0029-9C&quot;   &quot;ER-MH0032&quot;      &quot;ER-MH0040&quot;      &quot;ER-MH0042&quot;      &quot;ER-MH0043-T&quot;    &quot;ER-MH0056-T&quot;    &quot;ER-MH0064-T&quot;    &quot;ER-MH0114-T3&quot;</span><br><span class="hljs-comment"># [17] &quot;ER-MH0125&quot;      &quot;ER-MH0151&quot;      &quot;ER-MH0163&quot;      &quot;ER-MH0167-T&quot;    &quot;ER-MH0173-T&quot;    &quot;ER-PM0360&quot;      &quot;HER2-AH0308&quot;    &quot;HER2-MH0031&quot;</span><br><span class="hljs-comment"># [25] &quot;HER2-MH0069&quot;    &quot;HER2-MH0161&quot;    &quot;HER2-MH0176&quot;    &quot;HER2-PM0337&quot;    &quot;mER-MH0068-T&quot;   &quot;mER-PM0178&quot;     &quot;N-MH0021-Total&quot; &quot;N-MH0023-Total&quot;</span><br><span class="hljs-comment"># [33] &quot;N-MH0064-Total&quot; &quot;N-MH0169-Total&quot; &quot;N-MH275-Total&quot;  &quot;N-MH288-Total&quot;  &quot;N-PM0019-Total&quot; &quot;N-PM0092-Total&quot; &quot;N-PM0095-Total&quot; &quot;N-PM0230-Total&quot;</span><br><span class="hljs-comment"># [41] &quot;N-PM0233-Total&quot; &quot;N-PM0342-Total&quot; &quot;N-PM0372-Total&quot; &quot;TN-B1-MH0131&quot;   &quot;TN-B1-MH0177&quot;   &quot;TN-B1-MH4031&quot;   &quot;TN-B1-Tum0554&quot;  &quot;TN-MH0114-T2&quot;</span><br><span class="hljs-comment"># [49] &quot;TN-MH0126&quot;      &quot;TN-MH0135&quot;      &quot;TN-SH0106&quot;</span><br>p1 <span class="hljs-operator">&lt;-</span> VlnPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;nCount_RNA&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;nFeature_RNA&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span>pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_8f76179bb36294da0eb0681730df708e.png"></p><blockquote><p>数据粗过滤</p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs R">filterP <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">$</span>nFeature_RNA <span class="hljs-operator">&gt;=</span><span class="hljs-number">200</span> <span class="hljs-operator">&amp;</span> scRNA<span class="hljs-operator">$</span>nFeature_RNA <span class="hljs-operator">&lt;</span> <span class="hljs-number">5000</span> <span class="hljs-operator">&amp;</span> scRNA<span class="hljs-operator">$</span>percent.mt <span class="hljs-operator">&lt;</span><span class="hljs-number">15</span><br>scRNA <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>filterP<span class="hljs-punctuation">]</span><br>scRNA<br><span class="hljs-comment"># An object of class Seurat</span><br><span class="hljs-comment"># 25503 features across 282938 samples within 1 assay</span><br><span class="hljs-comment"># Active assay: RNA (25503 features, 0 variable features)</span><br><span class="hljs-comment">#  2 layers present: counts, data</span><br>p1 <span class="hljs-operator">&lt;-</span> VlnPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;nCount_RNA&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;nFeature_RNA&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span>pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_e511bae230a7f8780e9dcbec94570df0.png"></p><h2 id="去除双细胞"><a href="#去除双细胞" class="headerlink" title="去除双细胞"></a>去除双细胞</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>DoubletFinder<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>scRNAlist <span class="hljs-operator">&lt;-</span> SplitObject<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> split.by<span class="hljs-operator">=</span><span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span><span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  print<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span>  <br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> npcs <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span> verbose <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>  scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br>message<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;双细胞检测....&quot;</span><span class="hljs-punctuation">)</span><br>detectDoublet <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span><br>  obj<span class="hljs-punctuation">,</span> <span class="hljs-comment">#seurat obj</span><br>  dims<span class="hljs-punctuation">,</span> <span class="hljs-comment">#Pc数目</span><br>  estDubRate<span class="hljs-punctuation">,</span> <span class="hljs-comment">#期望双细胞率，该值最好通过细胞在10X/Drop-Seq装置上的负载密度来估计</span><br>  ncores<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-comment">#线程数</span><br>  SCTransform<span class="hljs-punctuation">,</span><span class="hljs-comment">#True or False</span><br>  Homotypic<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><span class="hljs-comment">#是否需要优化同源双细胞</span><br>  annotation<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">#听说最好是celltype</span><br>  <span class="hljs-comment">#use DoubletFinder packages</span><br>  require<span class="hljs-punctuation">(</span>DoubletFinder<span class="hljs-punctuation">)</span><span class="hljs-comment">#2.0.4</span><br>  <span class="hljs-comment">#select pK</span><br>  sweep.res.list <span class="hljs-operator">&lt;-</span> paramSweep<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">,</span> PCs<span class="hljs-operator">=</span>dims<span class="hljs-punctuation">,</span> sct<span class="hljs-operator">=</span>SCTransform<span class="hljs-punctuation">,</span> num.cores<span class="hljs-operator">=</span>ncores<span class="hljs-punctuation">)</span><br>  sweep.stats <span class="hljs-operator">&lt;-</span> summarizeSweep<span class="hljs-punctuation">(</span>sweep.res.list<span class="hljs-punctuation">,</span> GT<span class="hljs-operator">=</span><span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>  bcmvn <span class="hljs-operator">&lt;-</span> find.pK<span class="hljs-punctuation">(</span>sweep.stats<span class="hljs-punctuation">)</span><br>  pK <span class="hljs-operator">&lt;-</span> bcmvn<span class="hljs-operator">$</span>pK<span class="hljs-punctuation">[</span>which.max<span class="hljs-punctuation">(</span>bcmvn<span class="hljs-operator">$</span>BCmetric<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">%&gt;%</span> <span class="hljs-built_in">as.character</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>  message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Using pK = %s...&quot;</span><span class="hljs-punctuation">,</span> pK<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-comment">#Doublet Proportion Estimate</span><br>  <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span>Homotypic<span class="hljs-operator">==</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    nExp_poi <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>estDubRate <span class="hljs-operator">*</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>Cells<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span><span class="hljs-punctuation">&#123;</span><br>    homotypic.prop <span class="hljs-operator">&lt;-</span> modelHomotypic<span class="hljs-punctuation">(</span>obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>annotation<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>    nExp_poi <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>estDubRate <span class="hljs-operator">*</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>Cells<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    nExp_poi  <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>nExp_poi<span class="hljs-operator">*</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">-</span>homotypic.prop<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br>  obj <span class="hljs-operator">&lt;-</span> doubletFinder<span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">,</span> PCs <span class="hljs-operator">=</span> dims<span class="hljs-punctuation">,</span> pN <span class="hljs-operator">=</span> <span class="hljs-number">0.25</span><span class="hljs-punctuation">,</span> pK <span class="hljs-operator">=</span> pK<span class="hljs-punctuation">,</span> nExp <span class="hljs-operator">=</span> nExp_poi<span class="hljs-punctuation">,</span> reuse.pANN <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> sct <span class="hljs-operator">=</span> SCTransform<span class="hljs-punctuation">)</span><br>  pann <span class="hljs-operator">&lt;-</span> grep<span class="hljs-punctuation">(</span>pattern<span class="hljs-operator">=</span><span class="hljs-string">&quot;^pANN&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-operator">=</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> value<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>  message<span class="hljs-punctuation">(</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Using pANN = %s...&quot;</span><span class="hljs-punctuation">,</span> pann<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  classify <span class="hljs-operator">&lt;-</span> grep<span class="hljs-punctuation">(</span>pattern<span class="hljs-operator">=</span><span class="hljs-string">&quot;^DF.classifications&quot;</span><span class="hljs-punctuation">,</span> x<span class="hljs-operator">=</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>obj<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> value<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>  obj<span class="hljs-operator">$</span>pANN <span class="hljs-operator">&lt;-</span> obj<span class="hljs-punctuation">[[</span>pann<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>  obj<span class="hljs-operator">$</span>DF.classify <span class="hljs-operator">&lt;-</span> obj<span class="hljs-punctuation">[[</span>classify<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>  obj<span class="hljs-punctuation">[[</span>pann<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">NULL</span><br>  obj<span class="hljs-punctuation">[[</span>classify<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-literal">NULL</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>obj<span class="hljs-punctuation">)</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">#分样预测双细胞</span><br><span class="hljs-comment"># 对每个样本进行分析</span><br>message<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>Sys.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27; 开始进行双细胞检测...&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNAlist <span class="hljs-operator">&lt;-</span> lapply<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    detectDoublet<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">,</span><br>    estDubRate<span class="hljs-operator">=</span><span class="hljs-number">0.075</span><span class="hljs-punctuation">,</span><br>    ncores <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> <br>    SCTransform<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> <br>    Homotypic<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> <br>   annotation<span class="hljs-operator">=</span><span class="hljs-string">&quot;seurat_clusters&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 合并文件</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> merge<span class="hljs-punctuation">(</span>scRNAlist<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>scRNAlist<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> scRNA_harmony<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>scRNA_harmony<span class="hljs-operator">$</span>DF.classify<span class="hljs-operator">==</span><span class="hljs-string">&quot;Singlet&quot;</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><h2 id="查看细胞周期的影响"><a href="#查看细胞周期的影响" class="headerlink" title="查看细胞周期的影响"></a>查看细胞周期的影响</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>magrittr<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">%&lt;&gt;%</span> NormalizeData<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">%&lt;&gt;%</span> CellCycleScoring<span class="hljs-punctuation">(</span>g2m.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>g2m.genes<span class="hljs-punctuation">,</span><br>                                  s.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>s.genes<span class="hljs-punctuation">,</span><br>                                  g1.features <span class="hljs-operator">=</span> cc.genes<span class="hljs-operator">$</span>g1.genes<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_f212c24f2e4cfe53a674523bc3a7355b.png"></p><h2 id="聚类分群"><a href="#聚类分群" class="headerlink" title="聚类分群"></a>聚类分群</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs R">scRNA_harmony <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> vars.to.regress<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Phase&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;nCount_RNA&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;percent.mt&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> verbose<span class="hljs-operator">=</span><span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>harmony<span class="hljs-punctuation">)</span><br>system.time<span class="hljs-punctuation">(</span><span class="hljs-punctuation">&#123;</span>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunHarmony<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> group.by.vars <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>plot1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">,</span> group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span>raster<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>plot2 <span class="hljs-operator">&lt;-</span> ElbowPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> ndims<span class="hljs-operator">=</span><span class="hljs-number">50</span><span class="hljs-punctuation">,</span> reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;pca&quot;</span><span class="hljs-punctuation">)</span><br>plotc <span class="hljs-operator">&lt;-</span> plot1<span class="hljs-operator">+</span>plot2<br>plotc<br>pc.num <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> RunUMAP<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#scRNA_harmony &lt;- RunTSNE(scRNA_harmony, reduction = &quot;harmony&quot;, dims = pc.num)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> dims <span class="hljs-operator">=</span> pc.num<span class="hljs-punctuation">)</span><br>scRNA_harmony <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;harmony&quot;</span><span class="hljs-punctuation">,</span> resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>raster<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#DimPlot(scRNA_harmony, reduction = &quot;tsne&quot;, label=T)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA_harmony<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;001_大群Harmony.qs&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><h2 id="细胞注释"><a href="#细胞注释" class="headerlink" title="细胞注释"></a>细胞注释</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs R">source<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./Run_SingleR.R&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#scRNA &lt;- qs::qread(&#x27;001_大群Harmony.qs&#x27;)</span><br>scRNA <span class="hljs-operator">&lt;-</span> Run_singleR<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>cluster <span class="hljs-operator">=</span> scRNA<span class="hljs-operator">$</span>RNA_snn_res.0.8<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;RNA_snn_res.0.8&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 与经典注释marker进行比较</span><br>mark_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>  Immune <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;PTPRC&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  NK <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;KLRC1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;FCGR3A&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NCAM1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;KLRD1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;GNLY&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;T cells&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD3D&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD3G&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD2&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CD8A&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CD8B&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CD4&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Fibroblasts <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;COL1A1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;DCN&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;LUM&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;PDGFRA&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Myeloids <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;LYZ&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD68&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TYROBP&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Epithelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD24&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KRT19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;EPCAM&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;KRT18&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Bcells <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD79A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MS4A1&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Endothelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CLDN5&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FLT1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;RAMP2&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CDH5&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Keratinocytes <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;KRT5&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;KRT14&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;FABP5&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Plasma <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;IGHG1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;JCHAIN&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;MZB1&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;Smooth muscle&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;GJA4&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;PLAC9&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CRYAB&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ACTA2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;PLN&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ADIRF&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;MYH11&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CNN1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;MYL9&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Neutrophil <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;FCGR3B&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;S100P&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CMTM2&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  DC <span class="hljs-operator">=</span>  <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;LILRA4&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CXCR3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;IRF7&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Mast <span class="hljs-operator">=</span>  <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;CPA3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TPSAB1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TPSB2&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制气泡图</span><br>plotBigDotPlot <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span> group.by<span class="hljs-punctuation">,</span> marker<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  p1 <span class="hljs-operator">&lt;-</span> DotPlot<span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span> assay <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RNA&quot;</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> marker<span class="hljs-punctuation">,</span> scale <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> group.by<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>    scale_color_gradient2<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> mid <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span>  <br>    annotate<span class="hljs-punctuation">(</span>geom <span class="hljs-operator">=</span> <span class="hljs-string">&quot;segment&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> <br>    annotate<span class="hljs-punctuation">(</span>geom <span class="hljs-operator">=</span> <span class="hljs-string">&quot;segment&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-literal">Inf</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> <br>    theme<span class="hljs-punctuation">(</span><br>      axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>  <br>      strip.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <br>      axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span>  <br>    <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>    theme<span class="hljs-punctuation">(</span><br>      panel.border <span class="hljs-operator">=</span> element_rect<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> <span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> linewidth <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;solid&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>  <br>      legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;right&quot;</span><span class="hljs-punctuation">,</span>  <br>      panel.spacing.x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <br>      panel.spacing.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>      panel.grid <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;grey&#x27;</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dashed&#x27;</span><span class="hljs-punctuation">,</span> linewidth <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <br>    <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>    labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">)</span> <br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;RNA_snn_res.0.8&quot;</span><span class="hljs-punctuation">,</span>label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>repel<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>x<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap1&quot;</span><span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap2&quot;</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;singleR&quot;</span><span class="hljs-punctuation">,</span>label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>repel<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>x<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap1&quot;</span><span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap2&quot;</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;RNA_snn_res.0.8&quot;</span><span class="hljs-punctuation">,</span>mark_list<span class="hljs-punctuation">)</span><br>p4 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;singleR&quot;</span><span class="hljs-punctuation">,</span>mark_list<span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename<span class="hljs-operator">=</span><span class="hljs-string">&quot;./001.png&quot;</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">14</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">29</span><span class="hljs-punctuation">,</span>plot<span class="hljs-operator">=</span><span class="hljs-punctuation">(</span>p1<span class="hljs-operator">+</span>p3<span class="hljs-operator">+</span>p2<span class="hljs-operator">+</span>p4<span class="hljs-operator">+</span>patchwork<span class="hljs-operator">::</span>plot_layout<span class="hljs-punctuation">(</span>ncol<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>nrow<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>bg<span class="hljs-operator">=</span><span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span>limitsize <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_3a3051fa88819aff7733724469cbf890.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># Add Celltype</span><br>library<span class="hljs-punctuation">(</span>magrittr<span class="hljs-punctuation">)</span><br><br></code></pre></td></tr></table></figure><h2 id="绘图"><a href="#绘图" class="headerlink" title="绘图"></a>绘图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs R">scRNA<span class="hljs-operator">$</span>celltype <span class="hljs-operator">&lt;-</span> factor<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">,</span> levels <span class="hljs-operator">=</span> sort<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>sort<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">,</span> cols <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Accent&quot;</span><br>    <span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      guides<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>SCP<span class="hljs-operator">::</span>theme_blank<span class="hljs-punctuation">(</span>xlab <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP1&#x27;</span><span class="hljs-punctuation">,</span>ylab <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP2&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;nCells:&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_AllClutserCelltypeDimPlot.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_AllClutserCelltypeDimPlot.pdf&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> family <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ArialMT&quot;</span><span class="hljs-punctuation">)</span><br><br>mark_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>  Plasma <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;IGHG1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;JCHAIN&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;MZB1&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;NK &amp; T&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;NKG7&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;CD3D&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD3G&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Myeloids <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;LYZ&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD68&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;TYROBP&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Mast <span class="hljs-operator">=</span>  <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;CPA3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TPSAB1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TPSB2&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Keratinocytes <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;KRT5&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;KRT14&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;FABP5&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Fibroblasts <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;COL1A1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;DCN&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;LUM&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Epithelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD24&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;KRT19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;EPCAM&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Endothelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CLDN5&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;FLT1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;RAMP2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Bcells <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD79A&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;CD19&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MS4A1&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> plotBigDotPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>group.by<span class="hljs-operator">=</span><span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">,</span>mark_list<span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./002_DotPlot.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">13</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p2<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./002_DotPlot.pdf&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">13</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p2<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> family <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ArialMT&quot;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_109004b8f53d4a27d82db71c6e294699.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 绘制celltype Nums********************************************************</span><br>cols <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Accent&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>test <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>test<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> reorder<span class="hljs-punctuation">(</span>Var1<span class="hljs-punctuation">,</span> Freq<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>geom_col<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>geom_text_repel<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>label <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> position <span class="hljs-operator">=</span> position_dodge<span class="hljs-punctuation">(</span><span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>scale_fill_manual<span class="hljs-punctuation">(</span>values <span class="hljs-operator">=</span> cols<span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>theme_classic<span class="hljs-punctuation">(</span>base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;nCells&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>theme<span class="hljs-punctuation">(</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1.3, linetype = &quot;solid&quot;),</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.y <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 90, hjust = 1, vjust = 0.5),</span><br>    axis.text.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.length <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_大群细胞量.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>plot <span class="hljs-operator">=</span> p3<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制基因表达FeaturePlot********************************************************</span><br>mark_list <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>  NK <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;KLRD1&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;T cells&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD3E&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;Fibroblasts&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;DCN&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Myeloids <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD68&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Epithelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;EPCAM&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Endothelial <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CLDN5&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Keratinocytes <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;KRT5&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Bcells <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CD79A&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;Smooth muscle&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;PLAC9&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  Mast <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;CPA3&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br>plist <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>j <span class="hljs-keyword">in</span> mark_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    plist<span class="hljs-punctuation">[[</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;|&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span><br>      FeaturePlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span><br>        features <span class="hljs-operator">=</span> j<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> raster<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> max.cutoff <span class="hljs-operator">=</span> <span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><br>        cols <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;#FFEFD5&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#E6E6FA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#87CEFA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#6495ED&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#4169E1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#0000CD&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;#000080&quot;</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      scale_x_continuous<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> scale_y_continuous<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      theme_bw<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      theme<span class="hljs-punctuation">(</span><br>        panel.grid.major <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> panel.grid.minor <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.ticks <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> axis.text <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span><br>        plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">14</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot; (&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;)&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>ggsave<span class="hljs-punctuation">(</span><br>  filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_大群FeaturePlot.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span>plist<span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制基因表达密度图********************************************************</span><br>plist <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>mark_list<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>j <span class="hljs-keyword">in</span> mark_list<span class="hljs-punctuation">[[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>    print<span class="hljs-punctuation">(</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27; and &#x27;</span><span class="hljs-punctuation">,</span>j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    result <span class="hljs-operator">&lt;-</span> SCpubr<span class="hljs-operator">::</span>do_NebulosaPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> j<span class="hljs-punctuation">,</span> reduction <span class="hljs-operator">=</span> <span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">,</span> legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>    labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;:&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      Seurat<span class="hljs-operator">::</span>NoGrid<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      Seurat<span class="hljs-operator">::</span>NoAxes<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      theme_test<span class="hljs-punctuation">(</span><br>        base_size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span><br>        base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">,</span><br>        base_rect_size <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><br>      <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      theme<span class="hljs-punctuation">(</span><br>        plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.text <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.ticks <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        axis.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        legend.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>        legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">12</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-punctuation">)</span><br>    plist<span class="hljs-punctuation">[[</span>paste0<span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;|&quot;</span><span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> result<br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_大群Feature密度.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">17</span><span class="hljs-punctuation">,</span><br>  plot <span class="hljs-operator">=</span> patchwork<span class="hljs-operator">::</span>wrap_plots<span class="hljs-punctuation">(</span>plist<span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span>）<br>       <br><span class="hljs-comment"># group********************************************************</span><br>p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">,</span> cols <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Paired&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Set1&quot;</span><br>    <span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      guides<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>SCP<span class="hljs-operator">::</span>theme_blank<span class="hljs-punctuation">(</span>xlab <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP1&#x27;</span><span class="hljs-punctuation">,</span>ylab <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP2&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Group&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_AllClutserGroupDimPlot.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_AllClutserGroupDimPlot.pdf&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> family <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ArialMT&quot;</span><span class="hljs-punctuation">)</span><br>       <br><span class="hljs-comment"># sample********************************************************</span><br>p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span>reduction<span class="hljs-operator">=</span><span class="hljs-string">&quot;umap&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>      guides<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>SCP<span class="hljs-operator">::</span>theme_blank<span class="hljs-punctuation">(</span>xlab <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP1&#x27;</span><span class="hljs-punctuation">,</span>ylab <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UMAP2&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> ggtitle<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Sample&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_AllClutserSampleDimPlot.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_AllClutserSampleDimPlot.pdf&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> family <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ArialMT&quot;</span><span class="hljs-punctuation">)</span><br>       <br><span class="hljs-comment"># split Group********************************************************</span><br>cols <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Accent&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>scRNA<span class="hljs-operator">$</span>group <span class="hljs-operator">&lt;-</span> factor<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">,</span> levels<span class="hljs-operator">=</span>unique<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span><br>  group.by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">,</span> label <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span> repel <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> raster <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>split.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;group&#x27;</span><span class="hljs-punctuation">,</span>ncol <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  cols <span class="hljs-operator">=</span> cols<br><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  guides<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span>plot.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme_blank<span class="hljs-punctuation">(</span>xlab <span class="hljs-operator">=</span> <span class="hljs-string">&quot;UMAP_1&quot;</span><span class="hljs-punctuation">,</span> ylab <span class="hljs-operator">=</span> <span class="hljs-string">&quot;UMAP_2&quot;</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> p1 <span class="hljs-operator">+</span> theme<span class="hljs-punctuation">(</span>strip.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> face <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bold&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>strip.background <span class="hljs-operator">=</span> element_rect<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;#fffbe9&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./001_大群UMAP_不同分组.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">9.5</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span> bg <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>       <br><span class="hljs-comment"># 比例箱线图********************************************************</span><br>library<span class="hljs-punctuation">(</span>rstatix<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggpubr<span class="hljs-punctuation">)</span><br><br>df1 <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">@</span>meta.data <span class="hljs-operator">%&gt;%</span><br>  dplyr<span class="hljs-operator">::</span>select<span class="hljs-punctuation">(</span>sample<span class="hljs-punctuation">,</span> celltype<span class="hljs-punctuation">,</span> group<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>  dplyr<span class="hljs-operator">::</span>group_by<span class="hljs-punctuation">(</span>sample<span class="hljs-punctuation">,</span> celltype<span class="hljs-punctuation">,</span> group<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>  dplyr<span class="hljs-operator">::</span>count<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>  dplyr<span class="hljs-operator">::</span>rename<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;n1&quot;</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;n&quot;</span><span class="hljs-punctuation">)</span><br>df2 <span class="hljs-operator">&lt;-</span> scRNA<span class="hljs-operator">@</span>meta.data <span class="hljs-operator">%&gt;%</span><br>  dplyr<span class="hljs-operator">::</span>group_by<span class="hljs-punctuation">(</span>sample<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>  dplyr<span class="hljs-operator">::</span>count<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>df <span class="hljs-operator">&lt;-</span> df1 <span class="hljs-operator">%&gt;%</span><br>  left_join<span class="hljs-punctuation">(</span>df2<span class="hljs-punctuation">,</span> by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>  data.table<span class="hljs-operator">::</span>setDT<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 计算比例</span><br>df<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> Prop <span class="hljs-operator">:=</span> n1 <span class="hljs-operator">/</span> n<span class="hljs-punctuation">]</span><br><span class="hljs-comment"># 绘制箱线图</span><br>df<span class="hljs-operator">$</span>celltype <span class="hljs-operator">&lt;-</span> varhandle<span class="hljs-operator">::</span>unfactor<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">)</span><br>compair <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Normal&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;ER&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Normal&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TNBC&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Normal&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HER2&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;TNBC&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ER&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;TNBC&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HER2&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;ER&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HER2&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>lapply<span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>df<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> FUN <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  tryCatch<span class="hljs-punctuation">(</span><br>    <span class="hljs-punctuation">&#123;</span><br>      df_sub <span class="hljs-operator">&lt;-</span> df<span class="hljs-punctuation">[</span>df<span class="hljs-operator">$</span>celltype <span class="hljs-operator">==</span> x<span class="hljs-punctuation">,</span> <span class="hljs-punctuation">]</span><br>      print<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><br>      <span class="hljs-comment"># plot_boxplot</span><br>      p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>df_sub<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        geom_boxplot<span class="hljs-punctuation">(</span><br>          aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> celltype<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Prop<span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> group<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          position <span class="hljs-operator">=</span> position_dodge<span class="hljs-punctuation">(</span>width <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          outlier.shape <span class="hljs-operator">=</span> <span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><br>        <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        geom_jitter<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> celltype<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Prop<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> position <span class="hljs-operator">=</span> position_dodge<span class="hljs-punctuation">(</span>width <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> pch <span class="hljs-operator">=</span> <span class="hljs-number">21</span><br>        <span class="hljs-punctuation">)</span><br>      <span class="hljs-comment"># 计算显著性</span><br>      stat.test <span class="hljs-operator">&lt;&lt;-</span> df_sub <span class="hljs-operator">%&gt;%</span><br>        group_by<span class="hljs-punctuation">(</span>celltype<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>        wilcox_test<span class="hljs-punctuation">(</span>Prop <span class="hljs-operator">~</span> group<span class="hljs-punctuation">,</span> comparisons <span class="hljs-operator">=</span> compair<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span><br>        add_xy_position<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">,</span> dodge <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-comment"># print(head(stat.test))</span><br>      <span class="hljs-comment">#添加新的显著性</span><br>      stat.test<span class="hljs-operator">$</span>new_signif <span class="hljs-operator">&lt;-</span> case_when<span class="hljs-punctuation">(</span><br>          <span class="hljs-number">0</span> <span class="hljs-operator">&lt;=</span> stat.test<span class="hljs-operator">$</span>p <span class="hljs-operator">&amp;</span> stat.test<span class="hljs-operator">$</span>p <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.001</span> <span class="hljs-operator">~</span> <span class="hljs-string">&#x27;***&#x27;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">0.01</span> <span class="hljs-operator">&lt;=</span> stat.test<span class="hljs-operator">$</span>p <span class="hljs-operator">&amp;</span> stat.test<span class="hljs-operator">$</span>p <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.05</span> <span class="hljs-operator">~</span> <span class="hljs-string">&#x27;*&#x27;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">0.05</span> <span class="hljs-operator">&lt;=</span> stat.test<span class="hljs-operator">$</span>p <span class="hljs-operator">&amp;</span> stat.test<span class="hljs-operator">$</span>p <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.01</span> <span class="hljs-operator">~</span> <span class="hljs-string">&#x27;*&#x27;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-literal">TRUE</span> <span class="hljs-operator">~</span> <span class="hljs-string">&#x27;ns&#x27;</span><br>      <span class="hljs-punctuation">)</span><br>      stat.test <span class="hljs-operator">&lt;-</span> stat.test <span class="hljs-operator">%&gt;%</span> filter<span class="hljs-punctuation">(</span>new_signif <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;ns&#x27;</span><span class="hljs-punctuation">)</span><br>      p2 <span class="hljs-operator">&lt;-</span> p1 <span class="hljs-operator">+</span> stat_pvalue_manual<span class="hljs-punctuation">(</span><br>        stat.test<span class="hljs-punctuation">,</span><br>        label <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;p&#125; &#123;new_signif&#125;&quot;</span><span class="hljs-punctuation">,</span> tip.length <span class="hljs-operator">=</span> <span class="hljs-number">0.00</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>        hide.ns <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><br>      <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> labs<span class="hljs-punctuation">(</span>y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Fraction&quot;</span><span class="hljs-punctuation">,</span> x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> title <span class="hljs-operator">=</span> x<span class="hljs-punctuation">)</span><br>      p2 <span class="hljs-operator">&lt;-</span> p2 <span class="hljs-operator">+</span><br>        theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        scale_fill_brewer<span class="hljs-punctuation">(</span>palette <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Set1&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        theme<span class="hljs-punctuation">(</span><br>          axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.text.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.ticks.y <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.ticks.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          axis.ticks.length <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br>        <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>        scale_x_discrete<span class="hljs-punctuation">(</span>expand <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.45</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>      <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p2<span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    error <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>e<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>      message<span class="hljs-punctuation">(</span>e<span class="hljs-operator">$</span>message<span class="hljs-punctuation">)</span><br>      <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">-&gt;</span> plist<br>p1 <span class="hljs-operator">&lt;-</span> ggpubr<span class="hljs-operator">::</span>ggarrange<span class="hljs-punctuation">(</span>plotlist <span class="hljs-operator">=</span> plist<span class="hljs-punctuation">,</span> ncol <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> common.legend <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> align <span class="hljs-operator">=</span> <span class="hljs-string">&quot;v&quot;</span><span class="hljs-punctuation">,</span> legend <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bottom&quot;</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename<span class="hljs-operator">=</span><span class="hljs-string">&quot;./001_大群细胞比例箱线图.png&quot;</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>plot<span class="hljs-operator">=</span>p1<span class="hljs-punctuation">,</span>bg<span class="hljs-operator">=</span><span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span><br>       <br><span class="hljs-comment"># 绘制OR值热图********************************************************</span><br>library<span class="hljs-punctuation">(</span>plyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>data.table<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>tidyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>pheatmap<span class="hljs-punctuation">)</span><br><br>Caculate.OR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span>loc<span class="hljs-punctuation">,</span>celltype<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-operator">!</span>inherits<span class="hljs-punctuation">(</span>srt<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Seurat&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>      stop<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;input file is not Seurat Object, Please check!&quot;</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-comment"># 计算不同组织中不同细胞类型的细胞量</span><br>  count.dist.melt.tb <span class="hljs-operator">&lt;-</span>             as.data.frame<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>loc<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  colnames<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;cid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;count&#x27;</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.tb<span class="hljs-operator">$</span>rid <span class="hljs-operator">&lt;-</span> unfactor<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-operator">$</span>rid<span class="hljs-punctuation">)</span><br>  count.dist.melt.tb<span class="hljs-operator">$</span>cid <span class="hljs-operator">&lt;-</span> unfactor<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-operator">$</span>cid<span class="hljs-punctuation">)</span><br>  sum.col <span class="hljs-operator">&lt;-</span> table<span class="hljs-punctuation">(</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>loc<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>  sum.row <span class="hljs-operator">&lt;-</span> table<span class="hljs-punctuation">(</span>srt<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[[</span>celltype<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb <span class="hljs-operator">&lt;-</span><br>    as.data.table<span class="hljs-punctuation">(</span>ldply<span class="hljs-punctuation">(</span><span class="hljs-built_in">seq_len</span><span class="hljs-punctuation">(</span>nrow<span class="hljs-punctuation">(</span><br>      count.dist.melt.tb<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>      this.row <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>rid<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>      this.col <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>cid<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>      this.c <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>count<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>      other.col.c <span class="hljs-operator">&lt;-</span> sum.col<span class="hljs-punctuation">[</span>this.col<span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span> this.c<br>      this.m <span class="hljs-operator">&lt;-</span> matrix<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><br>          this.c<span class="hljs-punctuation">,</span><br>          sum.row<span class="hljs-punctuation">[</span>this.row<span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span> this.c<span class="hljs-punctuation">,</span><br>          other.col.c<span class="hljs-punctuation">,</span><br>          <span class="hljs-built_in">sum</span><span class="hljs-punctuation">(</span>sum.col<span class="hljs-punctuation">)</span> <span class="hljs-operator">-</span> sum.row<span class="hljs-punctuation">[</span>this.row<span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span> other.col.c<br>      <span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>      ncol <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br>      res.test <span class="hljs-operator">&lt;-</span> fisher.test<span class="hljs-punctuation">(</span>this.m<span class="hljs-punctuation">)</span><br>      data.frame<span class="hljs-punctuation">(</span><br>          rid <span class="hljs-operator">=</span> this.row<span class="hljs-punctuation">,</span><br>          cid <span class="hljs-operator">=</span> this.col<span class="hljs-punctuation">,</span><br>          p.value <span class="hljs-operator">=</span> res.test<span class="hljs-operator">$</span>p.value<span class="hljs-punctuation">,</span><br>          OR <span class="hljs-operator">=</span> res.test<span class="hljs-operator">$</span>estimate<br>      <span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> adj.p.value <span class="hljs-operator">:=</span> p.adjust<span class="hljs-punctuation">(</span>p.value<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;BH&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>as.data.frame<span class="hljs-punctuation">(</span>count.dist.melt.ext.tb<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>or <span class="hljs-operator">&lt;-</span> Caculate.OR<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span>loc <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span><span class="hljs-punctuation">,</span>celltype <span class="hljs-operator">=</span> <span class="hljs-string">&quot;celltype&quot;</span><span class="hljs-punctuation">)</span><br><br>Plot_OR <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  test <span class="hljs-operator">&lt;-</span> pivot_wider<span class="hljs-punctuation">(</span>inputfile<span class="hljs-punctuation">,</span><br>      names_from <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;cid&#x27;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment"># 指定哪些列的值应该变成新列的名称</span><br>      values_from <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OR&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 指定哪些列的值应该填充到新列中</span><br>      id_cols <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;rid&#x27;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">-&gt;</span> test2<br>  test <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>test<span class="hljs-punctuation">)</span><br>  test2 <span class="hljs-operator">=</span> test2 <span class="hljs-operator">%&gt;%</span> tibble<span class="hljs-operator">::</span>column_to_rownames<span class="hljs-punctuation">(</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;rid&#x27;</span><span class="hljs-punctuation">)</span><br>  p1 <span class="hljs-operator">&lt;-</span> pheatmap<span class="hljs-punctuation">(</span>test2<span class="hljs-punctuation">,</span> <br>      scale <span class="hljs-operator">=</span> <span class="hljs-string">&quot;row&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 按行归一化，查看因子在不同样本中的分布情况</span><br>      cluster_cols <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> clustering_distance_rows <span class="hljs-operator">=</span> <span class="hljs-string">&quot;correlation&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#取消列聚类，表示行聚类使用皮尔森相关系数聚类</span><br>      treeheight_row <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置行聚类树高</span><br>      cutree_rows <span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#根据样品列聚类情况将热图的行方向隔开为3份</span><br>      cellwidth <span class="hljs-operator">=</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>cellheight <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置热图方块宽度和高度</span><br>      fontsize_number <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#热图上数值的字体大小</span><br>      number_color<span class="hljs-operator">=</span><span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">#热图上数值的字体颜色</span><br>      display_numbers <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>      main<span class="hljs-operator">=</span><span class="hljs-string">&quot;OR(odds ratios)&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置图形标题</span><br>      show_colnames <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置行列标签的显示</span><br>      show_rownames <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span><br>      border<span class="hljs-operator">=</span><span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> <br>      legend <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># FALSE去除图例; T显示图例</span><br>      <span class="hljs-comment"># legend_breaks=c(0,0.5,1,1.5,2,2.5,3), # 设置图例的范围</span><br>      fontsize_row <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 分别设置行列标签字体大小</span><br>      fontsize_col <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>      angle_col <span class="hljs-operator">=</span> <span class="hljs-string">&quot;45&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 设置标签显示角度</span><br>        <span class="hljs-punctuation">)</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>p1<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment"># 绘图</span><br>png<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;./OR值热图.png&#x27;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>width <span class="hljs-operator">=</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> unit<span class="hljs-operator">=</span><span class="hljs-string">&#x27;in&#x27;</span><span class="hljs-punctuation">,</span> res<span class="hljs-operator">=</span><span class="hljs-number">300</span><span class="hljs-punctuation">)</span> <br>Plot_OR<span class="hljs-punctuation">(</span>or<span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>       <br><span class="hljs-comment">#绘制细胞比例柱形图********************************************************</span><br><span class="hljs-comment">## group</span><br>prop <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>prop.table<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> margin <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                Var1   Var2        Freq</span><br><span class="hljs-comment"># 1           B cells Normal 0.001589761</span><br><span class="hljs-comment"># 2 Endothelial_cells Normal 0.153640957</span><br><span class="hljs-comment"># 3  Epithelial cells Normal 0.295884136</span><br><span class="hljs-comment"># 4       Fibroblasts Normal 0.359043449</span><br><span class="hljs-comment"># 5     Keratinocytes Normal 0.139710340</span><br><span class="hljs-comment"># 6              Mast Normal 0.001037386</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> Var2<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> stratum <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> alluvium <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_flow<span class="hljs-punctuation">(</span>stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;alluvium&quot;</span><span class="hljs-punctuation">,</span> lode.guidance <span class="hljs-operator">=</span> <span class="hljs-string">&quot;frontback&quot;</span><span class="hljs-punctuation">,</span> curve_type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;linear&quot;</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_stratum<span class="hljs-punctuation">(</span>alpha <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  <span class="hljs-comment"># geom_text(aes(label = Prop),position = position_stack(vjust = .5),size =3.5, color = &#x27;black&#x27;) +</span><br>  theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  guides<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  <span class="hljs-comment"># scale_x_discrete(expand = c(0.04,0))+</span><br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;% Fraction&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1.3, linetype = &quot;solid&quot;),</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 90, hjust = 1, vjust = 0.5),</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 45, hjust = 1, vjust = 1),</span><br>    axis.ticks.y <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.length.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  scale_fill_manual<span class="hljs-punctuation">(</span>values<span class="hljs-operator">=</span>cols<span class="hljs-punctuation">)</span><br><br>num <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>num<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_bar<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#1B9E77&quot;</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;identity&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot; &quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Cell Num&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span><br>    axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.x <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span> hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1, linetype = &quot;solid&quot;),</span><br>    axis.ticks.length <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.3</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 合并图片</span><br>p3 <span class="hljs-operator">&lt;-</span> p1 <span class="hljs-operator">+</span> p2 <span class="hljs-operator">+</span> patchwork<span class="hljs-operator">::</span>plot_layout<span class="hljs-punctuation">(</span>nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> heights <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span><span class="hljs-string">&quot;001_大群celltype_group_barplot05.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p3<span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span><span class="hljs-string">&#x27;white&#x27;</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment">## sample</span><br>scRNA<span class="hljs-operator">$</span>group1 <span class="hljs-operator">&lt;-</span>paste0<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>sample<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>scRNA<span class="hljs-operator">$</span>group<span class="hljs-punctuation">)</span><br>prop <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>prop.table<span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>scRNA<span class="hljs-operator">$</span>celltype<span class="hljs-punctuation">,</span> scRNA<span class="hljs-operator">$</span>group1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> margin <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>mutate<span class="hljs-punctuation">(</span><br>    sample <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>Var2<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    group <span class="hljs-operator">=</span> stringr<span class="hljs-operator">::</span>str_split_fixed<span class="hljs-punctuation">(</span>Var2<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;--&#x27;</span><span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#                Var1               Var2         Freq     sample  group</span><br><span class="hljs-comment"># 1           B cells B1-KCF0894--Normal 0.0002835673 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 2 Endothelial_cells B1-KCF0894--Normal 0.1811994896 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 3  Epithelial cells B1-KCF0894--Normal 0.2549269814 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 4       Fibroblasts B1-KCF0894--Normal 0.3387211116 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 5     Keratinocytes B1-KCF0894--Normal 0.1959449879 B1-KCF0894 Normal</span><br><span class="hljs-comment"># 6              Mast B1-KCF0894--Normal 0.0000000000 B1-KCF0894 Normal</span><br>p1 <span class="hljs-operator">&lt;-</span> ggplot<span class="hljs-punctuation">(</span>prop<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> sample<span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> Freq<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> stratum <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">,</span> alluvium <span class="hljs-operator">=</span> Var1<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_flow<span class="hljs-punctuation">(</span>stat <span class="hljs-operator">=</span> <span class="hljs-string">&quot;alluvium&quot;</span><span class="hljs-punctuation">,</span> lode.guidance <span class="hljs-operator">=</span> <span class="hljs-string">&quot;frontback&quot;</span><span class="hljs-punctuation">,</span> curve_type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;linear&quot;</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_stratum<span class="hljs-punctuation">(</span>alpha <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  facet_grid<span class="hljs-punctuation">(</span>cols <span class="hljs-operator">=</span> vars<span class="hljs-punctuation">(</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> scales <span class="hljs-operator">=</span> <span class="hljs-string">&quot;free&quot;</span><span class="hljs-punctuation">,</span> space <span class="hljs-operator">=</span> <span class="hljs-string">&quot;free_x&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">switch</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;y&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  <span class="hljs-comment"># geom_text(aes(label = Prop),position = position_stack(vjust = .5),size =3.5, color = &#x27;black&#x27;) +</span><br>  theme_classic<span class="hljs-punctuation">(</span>base_size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> base_line_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  guides<span class="hljs-punctuation">(</span>fill <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>override.aes <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  <span class="hljs-comment"># scale_x_discrete(expand = c(0.04,0))+</span><br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-string">&quot;% Fraction&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span><br>    legend.title <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> vjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># panel.border = element_rect(fill = NA, color = &quot;black&quot;, size = 1.3, linetype = &quot;solid&quot;),</span><br>    legend.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.y <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> colour <span class="hljs-operator">=</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    strip.text <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>size<span class="hljs-operator">=</span><span class="hljs-number">26</span><span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 90, hjust = 1, vjust = 0.5),</span><br>    <span class="hljs-comment"># axis.text.x = element_text(size = 20, colour = &quot;black&quot;, angle = 45, hjust = 1, vjust = 1),</span><br>    axis.ticks.y <span class="hljs-operator">=</span> element_line<span class="hljs-punctuation">(</span>linewidth <span class="hljs-operator">=</span> <span class="hljs-number">1.3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.length.y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;cm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.text.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.title.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    axis.ticks.x <span class="hljs-operator">=</span> element_blank<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  scale_fill_manual<span class="hljs-punctuation">(</span>values<span class="hljs-operator">=</span>cols<span class="hljs-punctuation">)</span><br>ggsave<span class="hljs-punctuation">(</span>filename <span class="hljs-operator">=</span><span class="hljs-string">&quot;001_大群celltype_sample_barplot05.png&quot;</span><span class="hljs-punctuation">,</span> height <span class="hljs-operator">=</span><span class="hljs-number">9</span><span class="hljs-punctuation">,</span> width <span class="hljs-operator">=</span><span class="hljs-number">30</span><span class="hljs-punctuation">,</span> plot <span class="hljs-operator">=</span> p1<span class="hljs-punctuation">,</span>bg <span class="hljs-operator">=</span><span class="hljs-string">&#x27;white&#x27;</span><span class="hljs-punctuation">,</span> limitsize <span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_11e1531ecb4d0fb128f69bd87550b63c.png"></p><h2 id="T-cells"><a href="#T-cells" class="headerlink" title="T cells"></a>T cells</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs R">scRNA <span class="hljs-operator">&lt;-</span> SCP<span class="hljs-operator">::</span>Integration_SCP<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> batch <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span> integration_method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Harmony&#x27;</span><span class="hljs-punctuation">,</span>cluster_resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;./T细胞数据_scp.qs&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># BBKNN聚类</span><br>scRNA <span class="hljs-operator">&lt;-</span> SCP<span class="hljs-operator">::</span>Integration_SCP<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> batch <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span> integration_method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BBKNN&#x27;</span><span class="hljs-punctuation">,</span>cluster_resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;./T细胞数据_scp.qs&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># scVI聚类</span><br>scRNA <span class="hljs-operator">&lt;-</span> SCP<span class="hljs-operator">::</span>Integration_SCP<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> batch <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">,</span> integration_method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;scVI&#x27;</span><span class="hljs-punctuation">,</span>cluster_resolution <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">1.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>qsave<span class="hljs-punctuation">(</span>scRNA<span class="hljs-punctuation">,</span> file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;./T细胞数据_scp.qs&#x27;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>BRAC</category>
      
    </categories>
    
    
    <tags>
      
      <tag>scRNA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2024/05/28/%E8%A7%86%E9%A2%91%E5%88%B6%E4%BD%9C/"/>
    <url>/2024/05/28/%E8%A7%86%E9%A2%91%E5%88%B6%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h2 id="视频制作"><a href="#视频制作" class="headerlink" title="视频制作"></a>视频制作</h2><h3 id="远程连接工具的使用"><a href="#远程连接工具的使用" class="headerlink" title="远程连接工具的使用"></a>远程连接工具的使用</h3><blockquote><p>windows系统</p></blockquote><h4 id="xshell"><a href="#xshell" class="headerlink" title="xshell"></a>xshell</h4><h4 id="Mobaxterm"><a href="#Mobaxterm" class="headerlink" title="Mobaxterm"></a>Mobaxterm</h4><blockquote><p>MAC系统</p></blockquote><h4 id="windterm"><a href="#windterm" class="headerlink" title="windterm"></a>windterm</h4><h4 id="tabby"><a href="#tabby" class="headerlink" title="tabby"></a>tabby</h4><h3 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h3><blockquote><p>服务器和电脑之间文件传输</p></blockquote><h4 id="命令行传输"><a href="#命令行传输" class="headerlink" title="命令行传输"></a>命令行传输</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">lrzsz中的rz和sz命令<br>ftp和sftp<br></code></pre></td></tr></table></figure><h4 id="图形界面软件"><a href="#图形界面软件" class="headerlink" title="图形界面软件"></a>图形界面软件</h4><p>windows系统: Winscp</p><p>Mac系统：<a href="https://www.filezilla.cn/">FileZilla</a></p><blockquote><p>服务器和服务器之间传输</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">SCP<br>rcp<br>rsync<br></code></pre></td></tr></table></figure><h3 id="硬盘挂载"><a href="#硬盘挂载" class="headerlink" title="硬盘挂载"></a>硬盘挂载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount<br>unmount<br></code></pre></td></tr></table></figure><h3 id="虚拟桌面或终端复用工具"><a href="#虚拟桌面或终端复用工具" class="headerlink" title="虚拟桌面或终端复用工具"></a>虚拟桌面或终端复用工具</h3><h4 id="Tmux"><a href="#Tmux" class="headerlink" title="Tmux"></a>Tmux</h4><h4 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h4><h3 id="服务器中conda的使用"><a href="#服务器中conda的使用" class="headerlink" title="服务器中conda的使用"></a>服务器中conda的使用</h3><h3 id="服务其中R包的安装方式"><a href="#服务其中R包的安装方式" class="headerlink" title="服务其中R包的安装方式"></a>服务其中R包的安装方式</h3><h4 id="conda-安装"><a href="#conda-安装" class="headerlink" title="conda 安装"></a>conda 安装</h4><h4 id="本地安装"><a href="#本地安装" class="headerlink" title="本地安装"></a>本地安装</h4><h4 id="命令行安装"><a href="#命令行安装" class="headerlink" title="命令行安装"></a>命令行安装</h4><h3 id="集群服务器的使用"><a href="#集群服务器的使用" class="headerlink" title="集群服务器的使用"></a>集群服务器的使用</h3><h4 id="计算节点和管理节点"><a href="#计算节点和管理节点" class="headerlink" title="计算节点和管理节点"></a>计算节点和管理节点</h4><h4 id="pbs任务管理器的使用"><a href="#pbs任务管理器的使用" class="headerlink" title="pbs任务管理器的使用"></a>pbs任务管理器的使用</h4><h5 id="任务提交及查询"><a href="#任务提交及查询" class="headerlink" title="任务提交及查询"></a>任务提交及查询</h5><h5 id="计算节点的切换"><a href="#计算节点的切换" class="headerlink" title="计算节点的切换"></a>计算节点的切换</h5><h5 id="任务终止"><a href="#任务终止" class="headerlink" title="任务终止"></a>任务终止</h5><h3 id="服务器终端radian使用R语言"><a href="#服务器终端radian使用R语言" class="headerlink" title="服务器终端radian使用R语言"></a>服务器终端radian使用R语言</h3><h3 id="服务器终端ipython使用python"><a href="#服务器终端ipython使用python" class="headerlink" title="服务器终端ipython使用python"></a>服务器终端ipython使用python</h3><h3 id="服务器中Rstudio使用R语言"><a href="#服务器中Rstudio使用R语言" class="headerlink" title="服务器中Rstudio使用R语言"></a>服务器中Rstudio使用R语言</h3><h3 id="服务器中jupyter使用python"><a href="#服务器中jupyter使用python" class="headerlink" title="服务器中jupyter使用python"></a>服务器中jupyter使用python</h3><h4 id="常用编辑器的使用"><a href="#常用编辑器的使用" class="headerlink" title="常用编辑器的使用"></a>常用编辑器的使用</h4><h5 id="vscode"><a href="#vscode" class="headerlink" title="vscode"></a>vscode</h5><h5 id="sublime"><a href="#sublime" class="headerlink" title="sublime"></a>sublime</h5>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>java学习</title>
    <link href="/2024/05/28/java%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/05/28/java%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-基础语法"><a href="#Java-基础语法" class="headerlink" title="Java 基础语法"></a>Java 基础语法</h1><h3 id="基础数据类型"><a href="#基础数据类型" class="headerlink" title="基础数据类型"></a>基础数据类型</h3><p>Java语言提供了8种基本数据类型，分别是<strong>byte、short、int、long、float、double、boolean、char</strong></p><p>一个字节有8个比特位。</p><table><thead><tr><th>byte</th><th>8位</th><th>1个字节</th></tr></thead><tbody><tr><td>short</td><td>16位</td><td>2个字节</td></tr><tr><td>int</td><td>32位</td><td>4个字节</td></tr><tr><td>long</td><td>64位</td><td>8个字节</td></tr><tr><td>float</td><td>32位</td><td>4个字节</td></tr><tr><td>double</td><td>64位</td><td>8个字节</td></tr><tr><td>boolean</td><td>8位</td><td>1个字节</td></tr><tr><td>char</td><td>16位</td><td>2个字节</td></tr></tbody></table><p>字节最左位是符号位，例如：byte的最大值为2^(16-1)-1，最小值为-（2^15）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">dataType</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>        <span class="hljs-type">short</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> <span class="hljs-number">40</span>;<br>        <span class="hljs-type">float</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-number">50.0f</span>;<br>        <span class="hljs-type">double</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-number">60.0</span>;<br>        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;A&#x27;</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">bo</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        System.out.println(<span class="hljs-string">&quot;byte: &quot;</span> + b);<br>        System.out.println(<span class="hljs-string">&quot;short: &quot;</span> + s);<br>        System.out.println(<span class="hljs-string">&quot;int: &quot;</span> + i);<br>        System.out.println(<span class="hljs-string">&quot;long: &quot;</span> + l);<br>        System.out.println(<span class="hljs-string">&quot;float: &quot;</span> + f);<br>        System.out.println(<span class="hljs-string">&quot;double: &quot;</span> + d);<br>        System.out.println(<span class="hljs-string">&quot;char: &quot;</span> + c);<br>        System.out.println(<span class="hljs-string">&quot;boolean: &quot;</span> + bo);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//byte: 10</span><br><span class="hljs-comment">//short: 20</span><br><span class="hljs-comment">//int: 30</span><br><span class="hljs-comment">//long: 40</span><br><span class="hljs-comment">//float: 50.0</span><br><span class="hljs-comment">//double: 60.0</span><br><span class="hljs-comment">//char: A</span><br><span class="hljs-comment">//boolean: true</span><br></code></pre></td></tr></table></figure><p>tips: 什么是双精度，什么是单精度？</p><p>在Java中，单精度（float）和双精度（double）是两种用于表示浮点数的数据类型。浮点数是用于表示实数（即有小数部分的数）的数值数据类型。这两种类型的主要区别在于它们的精度（即存储的数字的准确程度）和范围（即可以表示的最大和最小数值）。</p><ol><li><strong>单精度（float）</strong>：<ul><li>占用32位（4字节）的存储空间。</li><li>大约有7位有效数字。</li><li>表示的数值范围较小，但足够大多数日常计算使用。</li><li>在声明时，可以使用<code>float</code>关键字，但在赋值时，通常需要在数字后面加上<code>f</code>或<code>F</code>来表明这是一个单精度浮点数，例如：<code>float myFloat = 3.14f;</code>。</li></ul></li><li><strong>双精度（double）</strong>：<ul><li>占用64位（8字节）的存储空间。</li><li>大约有15-16位有效数字。</li><li>表示的数值范围更大，精度也更高。</li><li>在声明时，可以使用<code>double</code>关键字，例如：<code>double myDouble = 3.141592653589793;</code>。</li></ul></li></ol><p>由于双精度浮点数具有更高的精度和更大的范围，因此在大多数需要高精度计算的场景中，建议使用双精度浮点数。但是，如果你知道你的数据不需要那么高的精度，或者为了节省存储空间，可以使用单精度浮点数</p><h3 id="java中基础数据类型转换"><a href="#java中基础数据类型转换" class="headerlink" title="java中基础数据类型转换"></a>java中基础数据类型转换</h3><h4 id="自动类型转换"><a href="#自动类型转换" class="headerlink" title="自动类型转换"></a>自动类型转换</h4><p>当低精度向高精度转换的时候，可以进行自动类型转换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span> -&gt; <span class="hljs-type">short</span> -&gt; <span class="hljs-type">int</span> -&gt; <span class="hljs-type">long</span> -&gt; <span class="hljs-type">float</span> -&gt; <span class="hljs-type">double</span><br><span class="hljs-type">char</span> -&gt; <span class="hljs-type">int</span> -&gt; <span class="hljs-type">long</span> -&gt; <span class="hljs-type">float</span> -&gt; <span class="hljs-type">double</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Type;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">dataType01</span> &#123;<br>   <span class="hljs-comment">// 定义一个方法，根据传入的对象，返回其数据类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDataType</span><span class="hljs-params">(Object obj)</span> &#123;<br>        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;null&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Integer) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;int&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Double) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;double&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Byte) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;byte&quot;</span>;<br>        &#125; <span class="hljs-comment">// ... 其他类型检查</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> obj.getClass().getSimpleName();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br>        <span class="hljs-type">short</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-number">32767</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2147483647</span>;<br>        <span class="hljs-type">double</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-number">123.456</span>;<br>        <span class="hljs-type">double</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> d * s;<br>        System.out.println(result);<br>        System.out.println(getDataType(result));<br>        System.out.println(<span class="hljs-string">&quot;-------------------&quot;</span>);<br>        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;A&#x27;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> c + <span class="hljs-number">1</span>;<br>        System.out.println(result1);<br>        System.out.println(getDataType(result1));<br>    &#125;<br>&#125;<br><span class="hljs-comment">//4045282.7520000003</span><br><span class="hljs-comment">//double</span><br><span class="hljs-comment">//-------------------</span><br><span class="hljs-comment">//66</span><br><span class="hljs-comment">//int</span><br></code></pre></td></tr></table></figure><h3 id="强制类型转换"><a href="#强制类型转换" class="headerlink" title="强制类型转换"></a>强制类型转换</h3><p>在Java中，强制类型转换（也称为窄化转换或<strong>向下转型</strong>）是一种显式地将一种数据类型的值转换为另一种数据类型的操作。<strong>这种转换在源类型和目标类型之间存在潜在的信息丢失风险时是必需的</strong>，因为编译器不会自动进行这样的转换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">dataType02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">20.5</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) b;<br>        System.out.println(a);<br>        System.out.println(a ==b ? <span class="hljs-string">&quot;Equal&quot;</span> : <span class="hljs-string">&quot;Not Equal&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//20</span><br><span class="hljs-comment">//Not Equal</span><br></code></pre></td></tr></table></figure><h3 id="java中流程控制"><a href="#java中流程控制" class="headerlink" title="java中流程控制"></a>java中流程控制</h3><h4 id="顺序控制"><a href="#顺序控制" class="headerlink" title="顺序控制"></a>顺序控制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在Java中，if语句的基本语法如下：</span><br><span class="hljs-keyword">if</span> (condition) &#123;<br>    <span class="hljs-comment">// 如果条件为真执行的代码块</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 如果条件为假执行的代码块</span><br>&#125;<br><span class="hljs-comment">// condation是布尔值</span><br></code></pre></td></tr></table></figure><blockquote><p>单分支结构</p></blockquote><p>举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IfDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        System.out.print(<span class="hljs-string">&quot;Enter the first number: &quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> scanner.nextInt();<br>        <span class="hljs-keyword">if</span> (num1 &gt; <span class="hljs-number">60</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;The first number is greater than 60&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;The first number is less than or equal to 60&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 70</span><br><span class="hljs-comment">// The first number is greater than 60</span><br></code></pre></td></tr></table></figure><blockquote><p>多分支结构</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在Java中，if语句多分支的基本语法如下：</span><br><span class="hljs-keyword">if</span> (condition) &#123;<br>    <span class="hljs-comment">// 如果条件为真执行的代码块</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>&#123;<br>    <span class="hljs-comment">// 如果条件为假执行的代码块</span><br>&#125;<br><span class="hljs-comment">// condation是布尔值</span><br></code></pre></td></tr></table></figure><p>举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IfDemo02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        System.out.print(<span class="hljs-string">&quot;Enter the first number: &quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> scanner.nextInt();<br>        System.out.print(<span class="hljs-string">&quot;Enter the second number: &quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">num2</span> <span class="hljs-operator">=</span> scanner.nextInt();<br>        <span class="hljs-keyword">if</span> (num1 &gt; num2) &#123;<br>            System.out.println(num1 + <span class="hljs-string">&quot; is greater than &quot;</span> + num2);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (num1 &lt; num2) &#123;<br>            System.out.println(num2 + <span class="hljs-string">&quot; is greater than &quot;</span> + num1);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;Both numbers are equal&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Enter the first number: 10</span><br><span class="hljs-comment">//Enter the second number: 20</span><br><span class="hljs-comment">//20 is greater than 10</span><br></code></pre></td></tr></table></figure><h3 id="循环结构"><a href="#循环结构" class="headerlink" title="循环结构"></a>循环结构</h3><h4 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span>(初始化; 布尔表达式; 更新) &#123;<br>    <span class="hljs-comment">//代码语句</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>举例</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i++) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Element at index &quot;</span> + i + <span class="hljs-string">&quot; is &quot;</span> +arr[i]);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Element at index 0 is 1</span><br><span class="hljs-comment">//Element at index 1 is 2</span><br><span class="hljs-comment">//Element at index 2 is 3</span><br><span class="hljs-comment">//Element at index 3 is 4</span><br><span class="hljs-comment">//Element at index 4 is 5</span><br></code></pre></td></tr></table></figure><h4 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">while</span>( 布尔表达式 ) &#123;<br>  <span class="hljs-comment">//循环内容</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>举例</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">whileDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        System.out.println(<span class="hljs-string">&quot;Enter a number:&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> sc.nextInt();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (i &lt;= num) &#123;<br>            System.out.println(<span class="hljs-string">&quot;hello world&quot;</span>);<br>            i++;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Enter a number:</span><br><span class="hljs-comment">//7</span><br><span class="hljs-comment">//hello world</span><br><span class="hljs-comment">//hello world</span><br><span class="hljs-comment">//hello world</span><br><span class="hljs-comment">//hello world</span><br><span class="hljs-comment">//hello world</span><br><span class="hljs-comment">//hello world</span><br><span class="hljs-comment">//hello world</span><br></code></pre></td></tr></table></figure><h4 id="do-while循环"><a href="#do-while循环" class="headerlink" title="do..while循环"></a>do..while循环</h4><p>对于 while 语句而言，如果不满足条件，则不能进入循环。但有时候我们需要即使不满足条件，也至少执行一次。do…while 循环和 while 循环相似，不同的是，do…while 循环至少会执行一次。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">do</span> &#123;<br>       <span class="hljs-comment">//代码语句</span><br>&#125;<span class="hljs-keyword">while</span>(布尔表达式);<br></code></pre></td></tr></table></figure><blockquote><p>举例</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.New;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DowhileDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            System.out.println(i);<br>            i++;<br>        &#125;<span class="hljs-keyword">while</span>(i &lt; <span class="hljs-number">5</span>);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//0</span><br><span class="hljs-comment">//1</span><br><span class="hljs-comment">//2</span><br><span class="hljs-comment">//3</span><br><span class="hljs-comment">//4</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python中的闭包和装饰器</title>
    <link href="/2024/05/28/python%E4%B8%AD%E7%9A%84%E9%97%AD%E5%8C%85%E5%92%8C%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
    <url>/2024/05/28/python%E4%B8%AD%E7%9A%84%E9%97%AD%E5%8C%85%E5%92%8C%E8%A3%85%E9%A5%B0%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="python中的闭包和装饰器"><a href="#python中的闭包和装饰器" class="headerlink" title="python中的闭包和装饰器"></a>python中的闭包和装饰器</h2><hr><p>title: python中的闭包和装饰器</p><p>date: 2024-01-14 16:35:20 </p><p>tags: - 原创 </p><p>categories: - python</p><hr><h3 id="引入闭包"><a href="#引入闭包" class="headerlink" title="引入闭包"></a>引入闭包</h3><p>在python的函数中，变量的作用域是有生命周期的，在函数运行完成以后，函数中的变量便会死去。出于种种原因，我们有时候需要在函数外部得到函数内的局部变量。但是，由于<a href="https://zhuanlan.zhihu.com/p/400388568">Python中作用域的搜索顺序</a>（”链式作用域”结构（chain scope）：子对象会一级一级地向上寻找所有父对象的变量），这一点通常是无法实现的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 函数中的变量的作用域</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fun1</span>():<br>    n = <span class="hljs-number">1000</span><br><br><span class="hljs-built_in">print</span>(n)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/14/hbsoOEzdrnA3B8L.png" alt="image-20240114163423406"></p><p>在函数的外部访问函数内部的变量会报错，函数中的变量作用域是局部变量，在全局环境中无法访问。如果想要能够访问函数中的变量，可以在函数中再建立一个函数，然后返回函数中的内部函数，内部函数中再返回函数中的变量，这样就可以访问函数中的变量了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fun1</span>():<br>    n = <span class="hljs-number">999</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fun2</span>():<br>        <span class="hljs-built_in">print</span>(n)<br>    <span class="hljs-keyword">return</span> fun2<br><br>var = fun1()<br>var()<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/14/5ux7zXi8J3YryVM.png" alt="image-20240114164022916"></p><p>从上面的程序中可以看出，外部函数的返回值是一个函数地址，调用函数地址就可以使用返回的函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fun3</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hello word&quot;</span>)<br><br><br><span class="hljs-built_in">print</span>(fun3)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/14/TWnB7HyDNSwbx3z.png" alt="image-20240114164410201"></p><h3 id="闭包的概念"><a href="#闭包的概念" class="headerlink" title="闭包的概念"></a>闭包的概念</h3><p>在一个外函数中定义了一个内函数，内函数里运用了外函数的临时变量，并且外函数的返回值是内函数的引<br>用。这样就构成了一个闭包。</p><p>一般情况下，在我们认知当中，如果一个函数结束，函数的内部所有东西都会释放掉，还给内存，局部变量都会消失。但是闭包是一种特殊情况，如果外函数在结束的时候发现有自己的临时变量将来会在内部函数中用到，就把这个临时变量绑定给了内部函数，然后自己再结束。</p><ul><li>作用1：闭包是将外层函数内的局部变量和外层函数的外部连接起来的一座桥梁。</li><li>作用2：将外层函数的变量持久地保存在内存中。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x,y</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">z</span>):<br>        <span class="hljs-keyword">return</span> x+y+z<br>    <span class="hljs-keyword">return</span> f<br><br>d = add(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>)<br><span class="hljs-built_in">print</span>(d(<span class="hljs-number">9</span>))<br><span class="hljs-built_in">print</span>(d(<span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/14/5mYruainXA9JToO.png" alt="image-20240114170539463"></p><h3 id="引入装饰器"><a href="#引入装饰器" class="headerlink" title="引入装饰器"></a>引入装饰器</h3><p>实现一个应用，在函数执行之前输出befor，在函数执行之后使用after。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用最粗暴的方法</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;before&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    value = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>    <span class="hljs-keyword">return</span> value<br><span class="hljs-comment"># 调用func函数</span><br>func()<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/14/n8bNDrgXOVBf3w4.png" alt="image-20240114235427163"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用闭包</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br>func2 = func1(func)<br>result = func2()<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/tAdCaV9wOWFHech.png" alt="image-20240115000425465"></p><p>上方的func1(func)的结果是获得inner_func的函数地址，result的结果是调用inner_func函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;inner_func的函数地址<span class="hljs-subst">&#123;inner_func&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br>func2 = func1(func)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;func2的地址是<span class="hljs-subst">&#123;func2&#125;</span>&quot;</span>)<br>result = func2()<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/qs3hUaY89zWLwMc.png" alt="image-20240115003213204"></p><p>在python中可以使用装饰器来简化上方的过程。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;inner_func的函数地址<span class="hljs-subst">&#123;inner_func&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br><span class="hljs-meta">@func1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;func函数的地址是<span class="hljs-subst">&#123;func&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br>func()<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/bGMq93h25iLJ6uV.png" alt="image-20240115004506286"></p><h3 id="装饰器添加参数"><a href="#装饰器添加参数" class="headerlink" title="装饰器添加参数"></a>装饰器添加参数</h3><p>上面的例子都是无参函数，如果是有参数的函数，上面的程序是否还有正确运行呢？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;inner_func的函数地址<span class="hljs-subst">&#123;inner_func&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br><span class="hljs-meta">@func1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>(<span class="hljs-params">a</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;func函数的地址是<span class="hljs-subst">&#123;func&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;函数的参数是:<span class="hljs-subst">&#123;a&#125;</span>&quot;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br>func(a=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/XPn89TWm47Cev3b.png" alt="image-20240115004956314"></p><p>在函数中添加*args和**kwargs</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;inner_func的函数地址<span class="hljs-subst">&#123;inner_func&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f(*args, **kwargs)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br><span class="hljs-meta">@func1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>(<span class="hljs-params">a</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;func函数的地址是<span class="hljs-subst">&#123;func&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;函数的参数是:<span class="hljs-subst">&#123;a&#125;</span>&quot;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br>func(a=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/ejLG8qOrfdpsZgR.png" alt="image-20240115010955515"></p><h3 id="装饰器扩展"><a href="#装饰器扩展" class="headerlink" title="装饰器扩展"></a>装饰器扩展</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;这是inner_func函数&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f(*args, **kwargs)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br><span class="hljs-meta">@func1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>(<span class="hljs-params">a</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;这是func函数&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br><span class="hljs-built_in">print</span>(func.__doc__)<br><span class="hljs-built_in">print</span>(func.__name__)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/DIHiOhUlbckXSoP.png" alt="image-20240115011512053"></p><p>在函数中答应文档信息和函数名称，可以很明显的看出当func函数使用装饰器装饰后，文档和函数名均输出为inner_func的函数名和doc文档。这也与上方的闭包符合。如果想打印出func函数的文档信息和函数名称的话，需要使用functiontools函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> functools<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params">f</span>):<br><span class="hljs-meta">    @functools.wraps(<span class="hljs-params">f</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_func</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;这是inner_func函数&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>        result = f(*args, **kwargs)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner_func<br><br><br><span class="hljs-meta">@func1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>(<span class="hljs-params">a</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;这是func函数&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;我是func函数&#x27;</span>)<br>    value = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br>    <span class="hljs-keyword">return</span> value<br><br><br>func(a=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(func.__name__)<br><span class="hljs-built_in">print</span>(func.__doc__)<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/01/15/Lw9txQuzCXVnbiH.png" alt="image-20240115012317116"></p>]]></content>
    
    
    <categories>
      
      <category>python base</category>
      
    </categories>
    
    
    <tags>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文章代码学习01</title>
    <link href="/2024/05/28/%E6%96%87%E7%AB%A0%E4%BB%A3%E7%A0%81%E5%AD%A6%E4%B9%A001/"/>
    <url>/2024/05/28/%E6%96%87%E7%AB%A0%E4%BB%A3%E7%A0%81%E5%AD%A6%E4%B9%A001/</url>
    
    <content type="html"><![CDATA[<h1 id="R语言文章代码学习"><a href="#R语言文章代码学习" class="headerlink" title="R语言文章代码学习"></a>R语言文章代码学习</h1><blockquote><p>文章链接:Single-cell analysis of anti-BCMA CAR T cell therapy inpatients with central nervous system autoimmunity</p><p>代码地址:</p></blockquote><blockquote><p>文章链接：<a href="https://journals.lww.com/hep/fulltext/2024/06000/single_cell_dissection_of_the_multicellular.12.aspx">https://journals.lww.com/hep/fulltext/2024/06000/single_cell_dissection_of_the_multicellular.12.aspx</a></p><p>代码地址：<a href="https://github.com/ZhoulabCPH/MVI_HCC/blob/main/">https://github.com/ZhoulabCPH/MVI_HCC/blob/main/</a></p></blockquote><h3 id="亚群间组织偏好性分布热图"><a href="#亚群间组织偏好性分布热图" class="headerlink" title="亚群间组织偏好性分布热图"></a>亚群间组织偏好性分布热图</h3><p>Fig D 图</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_bc8d943c5f5c0b8adb283cc00fd91e98.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs R">do.tissueDist <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>cellInfo.tb <span class="hljs-operator">=</span> cellInfo.tb<span class="hljs-punctuation">,</span><br>                          meta.cluster <span class="hljs-operator">=</span> cellInfo.tb<span class="hljs-operator">$</span>meta.cluster<span class="hljs-punctuation">,</span><br>                          colname.patient <span class="hljs-operator">=</span> <span class="hljs-string">&quot;patient&quot;</span><span class="hljs-punctuation">,</span><br>                          loc <span class="hljs-operator">=</span> cellInfo.tb<span class="hljs-operator">$</span>loc<span class="hljs-punctuation">,</span><br>                          out.prefix<span class="hljs-punctuation">,</span><br>                          pdf.width<span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>                          pdf.height<span class="hljs-operator">=</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>                          verbose<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-comment">##input data </span><br>  library<span class="hljs-punctuation">(</span>data.table<span class="hljs-punctuation">)</span><br>  dir.create<span class="hljs-punctuation">(</span>dirname<span class="hljs-punctuation">(</span>out.prefix<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>  <br>  cellInfo.tb <span class="hljs-operator">=</span> data.table<span class="hljs-punctuation">(</span>cellInfo.tb<span class="hljs-punctuation">)</span><br>  cellInfo.tb<span class="hljs-operator">$</span>meta.cluster <span class="hljs-operator">=</span> <span class="hljs-built_in">as.character</span><span class="hljs-punctuation">(</span>meta.cluster<span class="hljs-punctuation">)</span><br>  <br>  <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span>is.factor<span class="hljs-punctuation">(</span>loc<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    cellInfo.tb<span class="hljs-operator">$</span>loc <span class="hljs-operator">=</span> loc<br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span><span class="hljs-punctuation">&#123;</span>cellInfo.tb<span class="hljs-operator">$</span>loc <span class="hljs-operator">=</span> as.factor<span class="hljs-punctuation">(</span>loc<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><br>  <br>  loc.avai.vec <span class="hljs-operator">&lt;-</span> levels<span class="hljs-punctuation">(</span>cellInfo.tb<span class="hljs-punctuation">[[</span><span class="hljs-string">&quot;loc&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>  count.dist <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">unclass</span><span class="hljs-punctuation">(</span>cellInfo.tb<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>table<span class="hljs-punctuation">(</span>meta.cluster<span class="hljs-punctuation">,</span>loc<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>loc.avai.vec<span class="hljs-punctuation">]</span><br>  freq.dist <span class="hljs-operator">&lt;-</span> sweep<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>rowSums<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;/&quot;</span><span class="hljs-punctuation">)</span><br>  freq.dist.bin <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">floor</span><span class="hljs-punctuation">(</span>freq.dist <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">/</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>  print<span class="hljs-punctuation">(</span>freq.dist.bin<span class="hljs-punctuation">)</span><br>  <br>  <span class="hljs-punctuation">&#123;</span><br>    count.dist.melt.ext.tb <span class="hljs-operator">&lt;-</span> test.dist.table<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">)</span><br>    p.dist.tb <span class="hljs-operator">&lt;-</span> dcast<span class="hljs-punctuation">(</span>count.dist.melt.ext.tb<span class="hljs-punctuation">,</span>rid<span class="hljs-operator">~</span>cid<span class="hljs-punctuation">,</span>value.var<span class="hljs-operator">=</span><span class="hljs-string">&quot;p.value&quot;</span><span class="hljs-punctuation">)</span><br>    OR.dist.tb <span class="hljs-operator">&lt;-</span> dcast<span class="hljs-punctuation">(</span>count.dist.melt.ext.tb<span class="hljs-punctuation">,</span>rid<span class="hljs-operator">~</span>cid<span class="hljs-punctuation">,</span>value.var<span class="hljs-operator">=</span><span class="hljs-string">&quot;OR&quot;</span><span class="hljs-punctuation">)</span><br>    OR.dist.mtx <span class="hljs-operator">&lt;-</span> as.matrix<span class="hljs-punctuation">(</span>OR.dist.tb<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>    rownames<span class="hljs-punctuation">(</span>OR.dist.mtx<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> OR.dist.tb<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br>  <br>  sscVis<span class="hljs-operator">::</span>plotMatrix.simple<span class="hljs-punctuation">(</span>OR.dist.mtx<span class="hljs-punctuation">,</span><br>                            out.prefix<span class="hljs-operator">=</span>sprintf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;%s.OR.dist&quot;</span><span class="hljs-punctuation">,</span>out.prefix<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                            show.number<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span><br>                            waterfall.row<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>par.warterfall <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>score.alpha <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>do.norm<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                            exp.name<span class="hljs-operator">=</span><span class="hljs-built_in">expression</span><span class="hljs-punctuation">(</span>italic<span class="hljs-punctuation">(</span>OR<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                            z.hi<span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>                            palatte<span class="hljs-operator">=</span>viridis<span class="hljs-operator">::</span>viridis<span class="hljs-punctuation">(</span><span class="hljs-number">7</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                            pdf.width <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> pdf.height <span class="hljs-operator">=</span> pdf.height<span class="hljs-punctuation">)</span><br>  <span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span>verbose<span class="hljs-operator">==</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;count.dist.melt.ext.tb&quot;</span><span class="hljs-operator">=</span>count.dist.melt.ext.tb<span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;p.dist.tb&quot;</span><span class="hljs-operator">=</span>p.dist.tb<span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;OR.dist.tb&quot;</span><span class="hljs-operator">=</span>OR.dist.tb<span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;OR.dist.mtx&quot;</span><span class="hljs-operator">=</span>OR.dist.mtx<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">else</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>OR.dist.mtx<span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br>test.dist.table <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">,</span>min.rowSum<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#123;</span><br>  count.dist <span class="hljs-operator">&lt;-</span> count.dist<span class="hljs-punctuation">[</span>rowSums<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">)</span><span class="hljs-operator">&gt;=</span>min.rowSum<span class="hljs-punctuation">,</span><span class="hljs-punctuation">,</span>drop<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">]</span><br>  sum.col <span class="hljs-operator">&lt;-</span> colSums<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">)</span><br>  sum.row <span class="hljs-operator">&lt;-</span> rowSums<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">)</span><br>  count.dist.tb <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>count.dist<span class="hljs-punctuation">)</span><br>  setDT<span class="hljs-punctuation">(</span>count.dist.tb<span class="hljs-punctuation">,</span>keep.rownames<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.tb <span class="hljs-operator">&lt;-</span> melt<span class="hljs-punctuation">(</span>count.dist.tb<span class="hljs-punctuation">,</span>id.vars<span class="hljs-operator">=</span><span class="hljs-string">&quot;rn&quot;</span><span class="hljs-punctuation">)</span><br>  colnames<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;rid&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;cid&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;count&quot;</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb <span class="hljs-operator">&lt;-</span> as.data.table<span class="hljs-punctuation">(</span>ldply<span class="hljs-punctuation">(</span><span class="hljs-built_in">seq_len</span><span class="hljs-punctuation">(</span>nrow<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>i<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    this.row <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>rid<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>    this.col <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>cid<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>    this.c <span class="hljs-operator">&lt;-</span> count.dist.melt.tb<span class="hljs-operator">$</span>count<span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><br>    other.col.c <span class="hljs-operator">&lt;-</span> sum.col<span class="hljs-punctuation">[</span>this.col<span class="hljs-punctuation">]</span><span class="hljs-operator">-</span>this.c<br>    this.m <span class="hljs-operator">&lt;-</span> matrix<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>this.c<span class="hljs-punctuation">,</span><br>                       sum.row<span class="hljs-punctuation">[</span>this.row<span class="hljs-punctuation">]</span><span class="hljs-operator">-</span>this.c<span class="hljs-punctuation">,</span><br>                       other.col.c<span class="hljs-punctuation">,</span><br>                       <span class="hljs-built_in">sum</span><span class="hljs-punctuation">(</span>sum.col<span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>sum.row<span class="hljs-punctuation">[</span>this.row<span class="hljs-punctuation">]</span><span class="hljs-operator">-</span>other.col.c<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                     ncol<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br>    res.test <span class="hljs-operator">&lt;-</span> fisher.test<span class="hljs-punctuation">(</span>this.m<span class="hljs-punctuation">)</span><br>    data.frame<span class="hljs-punctuation">(</span>rid<span class="hljs-operator">=</span>this.row<span class="hljs-punctuation">,</span><br>               cid<span class="hljs-operator">=</span>this.col<span class="hljs-punctuation">,</span><br>               p.value<span class="hljs-operator">=</span>res.test<span class="hljs-operator">$</span>p.value<span class="hljs-punctuation">,</span><br>               OR<span class="hljs-operator">=</span>res.test<span class="hljs-operator">$</span>estimate<span class="hljs-punctuation">)</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb <span class="hljs-operator">&lt;-</span> merge<span class="hljs-punctuation">(</span>count.dist.melt.tb<span class="hljs-punctuation">,</span>count.dist.melt.ext.tb<span class="hljs-punctuation">,</span><br>                                  by<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;rid&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;cid&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  count.dist.melt.ext.tb<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>adj.p.value<span class="hljs-operator">:=</span>p.adjust<span class="hljs-punctuation">(</span>p.value<span class="hljs-punctuation">,</span><span class="hljs-string">&quot;BH&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>count.dist.melt.ext.tb<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="Monocle2分析"><a href="#Monocle2分析" class="headerlink" title="Monocle2分析"></a>Monocle2分析</h3><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_d5b03df65f4d857becff4ef3838e525b.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment">######## Figure 5e-f</span><br>library<span class="hljs-punctuation">(</span>monocle<span class="hljs-punctuation">)</span><br>Mono_matrix <span class="hljs-operator">=</span> as<span class="hljs-punctuation">(</span>as.matrix<span class="hljs-punctuation">(</span>GetAssayData<span class="hljs-punctuation">(</span>HC2<span class="hljs-punctuation">,</span>slot <span class="hljs-operator">=</span> <span class="hljs-string">&quot;count&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;sparseMatrix&#x27;</span><span class="hljs-punctuation">)</span><br>feature_ann <span class="hljs-operator">=</span> data.frame<span class="hljs-punctuation">(</span>gene_id<span class="hljs-operator">=</span>rownames<span class="hljs-punctuation">(</span>Mono_matrix<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gene_short_name<span class="hljs-operator">=</span>rownames<span class="hljs-punctuation">(</span>Mono_matrix<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>rownames<span class="hljs-punctuation">(</span>feature_ann<span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span> rownames<span class="hljs-punctuation">(</span>Mono_matrix<span class="hljs-punctuation">)</span><br>Mono_fd <span class="hljs-operator">=</span> new<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;AnnotatedDataFrame&quot;</span><span class="hljs-punctuation">,</span> data <span class="hljs-operator">=</span> feature_ann<span class="hljs-punctuation">)</span><br>sample_ann <span class="hljs-operator">=</span> HC2<span class="hljs-operator">@</span>meta.data<br>Mono_pd <span class="hljs-operator">=</span> new<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;AnnotatedDataFrame&quot;</span><span class="hljs-punctuation">,</span> data <span class="hljs-operator">=</span>sample_ann<span class="hljs-punctuation">)</span><br>Mono.cds <span class="hljs-operator">=</span> newCellDataSet<span class="hljs-punctuation">(</span>Mono_matrix<span class="hljs-punctuation">,</span>phenoData <span class="hljs-operator">=</span>Mono_pd<span class="hljs-punctuation">,</span>featureData <span class="hljs-operator">=</span>Mono_fd<span class="hljs-punctuation">,</span>expressionFamily<span class="hljs-operator">=</span>negbinomial.size<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>Mono.cds <span class="hljs-operator">=</span> estimateSizeFactors<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">)</span>                                     <br>Mono.cds <span class="hljs-operator">=</span> estimateDispersions<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">)</span><br>disp_table <span class="hljs-operator">=</span> dispersionTable<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">)</span>                                   <br>unsup_clustering_genes <span class="hljs-operator">=</span> subset<span class="hljs-punctuation">(</span>disp_table<span class="hljs-punctuation">,</span> mean_expression <span class="hljs-operator">&gt;=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><br>Mono.cds <span class="hljs-operator">=</span> setOrderingFilter<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span> unsup_clustering_genes<span class="hljs-operator">$</span>gene_id<span class="hljs-punctuation">)</span><br>Mono.cds <span class="hljs-operator">=</span> reduceDimension<span class="hljs-punctuation">(</span> Mono.cds<span class="hljs-punctuation">,</span> max_components <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>method <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;DDRTree&#x27;</span><span class="hljs-punctuation">)</span>  <br>Mono.cds <span class="hljs-operator">=</span> orderCells<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span>root_state<span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span>      <br><br>plot_cell_trajectory<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span> color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;State&quot;</span><span class="hljs-punctuation">,</span>cell_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>show_branch_points<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>plot_cell_trajectory<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span> color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Pseudotime&quot;</span><span class="hljs-punctuation">,</span>cell_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>show_branch_points<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>  theme<span class="hljs-punctuation">(</span>legend.position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;right&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> scale_colour_gradient<span class="hljs-punctuation">(</span>low <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#FAF5A9&quot;</span><span class="hljs-punctuation">,</span> high <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#C52F2D&quot;</span><span class="hljs-punctuation">)</span><br>plot_cell_trajectory<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span> color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Patient&quot;</span><span class="hljs-punctuation">,</span>cell_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>show_branch_points<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> facet_wrap<span class="hljs-punctuation">(</span><span class="hljs-operator">~</span>Patient<span class="hljs-punctuation">)</span><br>plot_cell_trajectory<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span> color_by <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MVI&quot;</span><span class="hljs-punctuation">,</span>cell_size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>show_branch_points<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>  scale_color_manual<span class="hljs-punctuation">(</span>values<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;#FC6F13&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#2BBAD7&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#F0C0BD&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>Time_diff <span class="hljs-operator">&lt;-</span> differentialGeneTest<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">,</span> cores <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br><br>plot_pseudotime_heatmap<span class="hljs-punctuation">(</span>Mono.cds<span class="hljs-punctuation">[</span>filter<span class="hljs-punctuation">(</span>Time_diff<span class="hljs-punctuation">,</span>qval<span class="hljs-operator">==</span><span class="hljs-number">0</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> rownames<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>                        num_clusters <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>                        show_rownames <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>return_heatmap<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span><br>                        hmcols <span class="hljs-operator">=</span> colorRampPalette<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;#5773D8&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;white&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;#C22E31&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">(</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>R</category>
      
    </categories>
    
    
    <tags>
      
      <tag>R</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2024/05/27/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/"/>
    <url>/2024/05/27/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/</url>
    
    <content type="html"><![CDATA[<h1 id="R语言中参数传递"><a href="#R语言中参数传递" class="headerlink" title="R语言中参数传递"></a>R语言中参数传递</h1><h2 id="getopt"><a href="#getopt" class="headerlink" title="getopt"></a>getopt</h2><blockquote><p><a href="https://github.com/trevorld/r-getopt">https://github.com/trevorld/r-getopt</a></p></blockquote><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R">getopt<span class="hljs-punctuation">(</span><br>     spec <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>     opt <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>     command <span class="hljs-operator">=</span> get_Rscript_filename<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>     usage <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>     debug <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>space是一个参数矩阵，该参数矩阵至少包括4列，使用matrix(x,ncol&#x3D;4,byrow&#x3D;TRUE)。</p><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_984b6d64c8b842bc76ff984b2144752d.png"></p><h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>getopt<span class="hljs-punctuation">)</span><br><br>spac <span class="hljs-operator">=</span> matrix<span class="hljs-punctuation">(</span><br><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;first&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;f&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;integer&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;This is first!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;second&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;s&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;character&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;This is second!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;third&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;t&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;double&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;This is third!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;help&quot;</span><span class="hljs-punctuation">,</span>   <span class="hljs-string">&quot;h&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;logical&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;This is Help!&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  byrow<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> ncol<span class="hljs-operator">=</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><br><br>opt <span class="hljs-operator">=</span> getopt<span class="hljs-punctuation">(</span>spac<span class="hljs-punctuation">)</span><br>opt <span class="hljs-operator">=</span> getopt<span class="hljs-punctuation">(</span>spac<span class="hljs-punctuation">)</span><br>cat<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;第一个参数&#x27;</span><span class="hljs-punctuation">,</span>opt<span class="hljs-operator">$</span>first<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;\n&#x27;</span><span class="hljs-punctuation">)</span><br>cat<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;第二个参数&#x27;</span><span class="hljs-punctuation">,</span>opt<span class="hljs-operator">$</span>second<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;\n&#x27;</span><span class="hljs-punctuation">)</span><br>cat<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;第三个参数&#x27;</span><span class="hljs-punctuation">,</span>opt<span class="hljs-operator">$</span>third<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;\n&#x27;</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>将上面的代码封装在getopttest.R文件中，使用Rscript调用该文件</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs R">Rscript getopttest.R <span class="hljs-operator">-</span>f <span class="hljs-number">123</span> <span class="hljs-operator">-</span>s ABC <span class="hljs-operator">-</span>t <span class="hljs-number">23</span><br><span class="hljs-comment"># 第一个参数 123 </span><br><span class="hljs-comment"># 第二个参数 ABC </span><br><span class="hljs-comment"># 第三个参数 23 </span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_57f3e0f010237aaa5bc996aaa2b7b754.png"></p><p>上面的代码不能打印帮助信息，可以添加</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment">#usage: If ‘TRUE’, argument ‘opt’ will be ignored and a usage</span><br><span class="hljs-comment">#         statement (character string) will be generated and returned</span><br><span class="hljs-comment">#         from ‘spec’.</span><br></code></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>getopt<span class="hljs-punctuation">)</span><br><br>spac <span class="hljs-operator">=</span> matrix<span class="hljs-punctuation">(</span><br><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;first&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;f&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;integer&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;This is first!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;second&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;s&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;character&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;This is second!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;third&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;t&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;double&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;This is third!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;help&quot;</span><span class="hljs-punctuation">,</span>   <span class="hljs-string">&quot;h&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;logical&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-string">&quot;This is Help!&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  byrow<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> ncol<span class="hljs-operator">=</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><br><br>opt <span class="hljs-operator">=</span> getopt<span class="hljs-punctuation">(</span>spac<span class="hljs-punctuation">)</span><br>cat<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;第一个参数&#x27;</span><span class="hljs-punctuation">,</span>opt<span class="hljs-operator">$</span>first<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;\n&#x27;</span><span class="hljs-punctuation">)</span><br>cat<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;第二个参数&#x27;</span><span class="hljs-punctuation">,</span>opt<span class="hljs-operator">$</span>second<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;\n&#x27;</span><span class="hljs-punctuation">)</span><br>cat<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;第三个参数&#x27;</span><span class="hljs-punctuation">,</span>opt<span class="hljs-operator">$</span>third<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;\n&#x27;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 添加帮助信息</span><br><span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span> <span class="hljs-operator">!</span><span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>opt<span class="hljs-operator">$</span>help<span class="hljs-punctuation">)</span> <span class="hljs-operator">||</span> <span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>opt<span class="hljs-operator">$</span>first<span class="hljs-punctuation">)</span> <span class="hljs-operator">||</span> <span class="hljs-built_in">is.null</span><span class="hljs-punctuation">(</span>opt<span class="hljs-operator">$</span>third<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    cat<span class="hljs-punctuation">(</span>paste<span class="hljs-punctuation">(</span>getopt<span class="hljs-punctuation">(</span>spec<span class="hljs-operator">=</span>spac<span class="hljs-punctuation">,</span> usage <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;\n&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>    quit<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_23331c2b8d395b6cfed0a5dd63e097ae.png"></p><h2 id="getoptlong"><a href="#getoptlong" class="headerlink" title="getoptlong"></a>getoptlong</h2><blockquote><p><a href="https://github.com/jokergoo/GetoptLong">https://github.com/jokergoo/GetoptLong</a></p></blockquote><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs R">install.packages<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;GetoptLong&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># CRAN</span><br>devtools<span class="hljs-operator">::</span>install_github<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;jokergoo/GetoptLong&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-comment">#github</span><br></code></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R">GetoptLong<span class="hljs-punctuation">(</span>...<span class="hljs-punctuation">,</span> <br>         help_head <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> <br>         help_foot <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> <br>         envir <span class="hljs-operator">=</span> parent.frame<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>         argv_str <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> template_control <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>         help_style <span class="hljs-operator">=</span> GetoptLong.options<span class="hljs-operator">$</span>help_style<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2024/05/26/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E7%BB%98%E5%9B%BE%E7%B3%BB%E7%BB%9F/"/>
    <url>/2024/05/26/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E7%BB%98%E5%9B%BE%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="R绘图系统"><a href="#R绘图系统" class="headerlink" title="R绘图系统"></a>R绘图系统</h1><blockquote><p>R绘图系统有4种</p></blockquote><ol><li>R基础绘图系统<ul><li>也称为基本绘图系统或Base Plotting System。</li><li>它对应于R的内置<code>graphics</code>包。</li><li>特点是需要事先计划，直观地实时反映绘图和分析数据的逻辑。</li><li>绘图过程通常包括两个步骤：首先使用如<code>plot()</code>函数画出图的主体，然后在此基础上进行修饰和添加。</li><li>适用于绘制2D图形。</li></ul></li><li>Lattice绘图系统<ul><li>Lattice Plotting System。</li><li>特点是一次函数调用即可生成图形。</li><li>特别适用于观测变量间的交互，例如在变量z的不同水平下，变量y如何随变量x变化。</li></ul></li><li>ggplot2绘图系统<ul><li>基于“图形的语法”（The Grammar of Graphics）的绘图系统。</li><li>将数据映射到几何客体（如点、线、条）的美学属性（如颜色、形状、大小）。</li><li>结合了基本绘图系统和Lattice绘图系统的特点。</li><li>自动处理标题、文字说明、空间等，但也允许通过添加注释进行修改。</li></ul></li><li>Grid绘图系统<ul><li>虽然在参考文章中提到了Grid绘图系统，但详细描述并不多。Grid系统提供了一系列不同的绘图函数，但并没有提供一套完整的绘图函数，因此通常不是直接用于绘图，而是作为其他绘图系统（如lattice和ggplot2）的基础。</li></ul></li><li>其他绘图系统和包<ul><li>除了上述四种主要的绘图系统外，R还有大量的扩展包，这些包提供了各种各样的绘图功能和选项，包括交互式绘图、3D绘图、动画等。</li></ul></li></ol><h2 id="R基础绘图"><a href="#R基础绘图" class="headerlink" title="R基础绘图"></a>R基础绘图</h2><h3 id="单变量绘图"><a href="#单变量绘图" class="headerlink" title="单变量绘图"></a>单变量绘图</h3><h2 id="grid绘图系统"><a href="#grid绘图系统" class="headerlink" title="grid绘图系统"></a>grid绘图系统</h2><h3 id="grid中的视口函数"><a href="#grid中的视口函数" class="headerlink" title="grid中的视口函数"></a>grid中的视口函数</h3><h4 id="grid-circle"><a href="#grid-circle" class="headerlink" title="grid.circle()"></a>grid.circle()</h4><p>根据给定的位置和半径绘图。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.circle<span class="hljs-punctuation">(</span><br>    x <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.9</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    y<span class="hljs-operator">=</span><span class="hljs-number">0.5</span><span class="hljs-operator">+</span><span class="hljs-number">0.4</span><span class="hljs-operator">*</span><span class="hljs-built_in">sin</span><span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-operator">*</span><span class="hljs-built_in">pi</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    r<span class="hljs-operator">=</span><span class="hljs-built_in">abs</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-operator">*</span><span class="hljs-built_in">cos</span><span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-operator">*</span><span class="hljs-built_in">pi</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_77c734368e3d40ce4cdbd28d9b655414.png"></p><p>使用gpar函数修改颜色。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.circle<span class="hljs-punctuation">(</span><br>    x <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.9</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    y<span class="hljs-operator">=</span><span class="hljs-number">0.5</span><span class="hljs-operator">+</span><span class="hljs-number">0.4</span><span class="hljs-operator">*</span><span class="hljs-built_in">sin</span><span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-operator">*</span><span class="hljs-built_in">pi</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    r<span class="hljs-operator">=</span><span class="hljs-built_in">abs</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-operator">*</span><span class="hljs-built_in">cos</span><span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-operator">*</span><span class="hljs-built_in">pi</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>    gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_328e8931201b46b6fbff616f0e0d4413.png"></p><h4 id="gpar"><a href="#gpar" class="headerlink" title="gpar()"></a>gpar()</h4><table><thead><tr><th>col</th><th>线条和边框的颜色。</th></tr></thead><tbody><tr><td>fill</td><td>用于填充矩形、多边形等的颜色</td></tr><tr><td>alpha</td><td>Alpha 通道透明度</td></tr><tr><td>lty</td><td>线型</td></tr><tr><td>lwd</td><td>行宽</td></tr><tr><td>lex</td><td>应用于线宽的乘数</td></tr><tr><td>lineend</td><td>线端样式(圆形、对接、方形)</td></tr><tr><td>linejoin</td><td>线连接样式(圆形、斜接、斜角)</td></tr><tr><td>linemitre</td><td>线斜接限制(数量大于 1)</td></tr><tr><td>fontsize</td><td>文本大小(以点为单位)</td></tr><tr><td>cex</td><td>应用于字体大小的乘数</td></tr><tr><td>fontfamily</td><td>字体家族</td></tr><tr><td>fontface</td><td>字体(粗体、斜体……)</td></tr><tr><td>lineheight</td><td>行高是文本大小的倍数</td></tr><tr><td>font</td><td>Font Face(fontface 的别名；为了向后兼容)</td></tr></tbody></table><h4 id="line"><a href="#line" class="headerlink" title="line"></a>line</h4><p>grid.move.to函数绘制线条的起点位置，grid.line.to绘制线条的结束点。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.move.to<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>             draw <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>grid.line.to<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>             arrow <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>             gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> draw <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.move.to<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br>grid.line.to<span class="hljs-punctuation">(</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>arrow <span class="hljs-operator">=</span> arrow<span class="hljs-punctuation">(</span>type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;closed&quot;</span><span class="hljs-punctuation">,</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">25</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_68c0bfbe45a315208ddc8e2077520d04.png"></p><h4 id="grid-curve"><a href="#grid-curve" class="headerlink" title="grid.curve"></a>grid.curve</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.curve<span class="hljs-punctuation">(</span>...<span class="hljs-punctuation">)</span><br>curveGrob<span class="hljs-punctuation">(</span>x1<span class="hljs-punctuation">,</span> y1<span class="hljs-punctuation">,</span> x2<span class="hljs-punctuation">,</span> y2<span class="hljs-punctuation">,</span> default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>          curvature <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> angle <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span> ncp <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> shape <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><br>          square <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> squareShape <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>          inflect <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span> arrow <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> open <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>          debug <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">,</span><br>          name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>arcCurvature<span class="hljs-punctuation">(</span>theta<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><table><thead><tr><th><code>x1</code></th><th>指定起始点 x-location 的数值向量或单位对象。</th></tr></thead><tbody><tr><td><code>y1</code></td><td>指定起始点 y-location 的数值向量或单位对象。</td></tr><tr><td><code>x2</code></td><td>指定终点x-location的数值向量或单位对象。</td></tr><tr><td><code>y2</code></td><td>指定终点y-location的数值向量或单位对象。</td></tr><tr><td><code>default.units</code></td><td>一个字符串，指示仅以数值形式给出 <code>x1</code> 、 <code>y1</code> 、 <code>x2</code> 或 <code>y2</code> 时使用的默认单位。</td></tr><tr><td><code>curvature</code></td><td>给出曲率量的数值。负值产生左手曲线，正值产生右手曲线，零产生直线。</td></tr><tr><td><code>angle</code></td><td>0 到 180 之间的数值，给出曲线控制点的倾斜量。小于 90 的值使曲线向起点倾斜，大于 90 的值使曲线向终点倾斜。</td></tr><tr><td><code>ncp</code></td><td>用于绘制曲线的控制点的数量。更多控制点可创建更平滑的曲线。</td></tr><tr><td><code>shape</code></td><td>由 -1 到 1 之间的值组成的数值向量，用于控制曲线相对于其控制点的形状。有关更多详细信息，请参阅<code>grid.xspline</code>。</td></tr><tr><td><code>square</code></td><td>控制是否以 city-block 方式或倾斜方式创建曲线控制点的逻辑值。当 <code>ncp</code> 为 1 并且 <code>angle</code> 为 90 时，这通常是 <code>TRUE</code> ，否则可能应设置为 <code>FALSE</code> (请参见下面的示例)。</td></tr><tr><td><code>squareShape</code></td><td><code>shape</code> 值，用于控制曲线相对于在 <code>square</code> 为 <code>TRUE</code> 时插入的任何其他控制点的行为。</td></tr><tr><td><code>inflect</code></td><td>一个逻辑值，指定曲线是否应切成两半并反转(请参见下面的示例)。</td></tr><tr><td><code>arrow</code></td><td>说明放置在曲线两端的箭头的列表，由 <code>arrow</code> 函数生成。</td></tr><tr><td><code>open</code></td><td>一个逻辑值，指示是否闭合曲线(连接起点和终点)。</td></tr><tr><td><code>debug</code></td><td>指示是否应绘制调试信息的逻辑值。</td></tr><tr><td><code>name</code></td><td>字符标识符。</td></tr><tr><td><code>gp</code></td><td>类 <code>&quot;gpar&quot;</code> 的对象，通常是调用函数 <code>gpar</code> 的输出。这本质上是图形参数设置的列表。</td></tr><tr><td><code>vp</code></td><td>网格视口对象(或 NULL)。</td></tr><tr><td><code>...</code></td><td>要传递给 <code>curveGrob</code> 的参数。</td></tr><tr><td><code>theta</code></td><td>角度(以度为单位)。</td></tr></tbody></table><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.curve<span class="hljs-punctuation">(</span>x1 <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           y1<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           x2<span class="hljs-operator">=</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><br>           y2<span class="hljs-operator">=</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><br>           arrow<span class="hljs-operator">=</span>arrow<span class="hljs-punctuation">(</span>type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;closed&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span>lwd<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>           angle<span class="hljs-operator">=</span><span class="hljs-number">130</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_4e670b373f9b8b3c960457e374907968.png"></p><h4 id="grid-segments"><a href="#grid-segments" class="headerlink" title="grid.segments"></a>grid.segments</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.segments<span class="hljs-punctuation">(</span>x0 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> y0 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>              x1 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> y1 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>              default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>              arrow <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>              name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> draw <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>segmentsGrob<span class="hljs-punctuation">(</span>x0 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> y0 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>              x1 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> y1 <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>              default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>              arrow <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><table><thead><tr><th><code>x0</code></th><th>表示线段起始 x-values 的数字。</th></tr></thead><tbody><tr><td><code>y0</code></td><td>表示线段起始 y-values 的数字。</td></tr><tr><td><code>x1</code></td><td>表示线段停止x-values的数字。</td></tr><tr><td><code>y1</code></td><td>表示线段停止y-values的数字。</td></tr><tr><td><code>default.units</code></td><td>一个字符串。</td></tr><tr><td><code>arrow</code></td><td>说明放置在线段两端的箭头的列表，由 <code>arrow</code> 函数生成。</td></tr><tr><td><code>name</code></td><td>字符标识符。</td></tr><tr><td><code>gp</code></td><td>类 <code>&quot;gpar&quot;</code> 的对象，通常是调用函数 <code>gpar</code> 的输出。这本质上是图形参数设置的列表。</td></tr><tr><td><code>draw</code></td><td>指示是否应生成图形输出的逻辑值。</td></tr><tr><td><code>vp</code></td><td>网格视口对象(或 NULL)。</td></tr></tbody></table><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.segments<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><br>              arrow <span class="hljs-operator">=</span> arrow<span class="hljs-punctuation">(</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>type <span class="hljs-operator">=</span> <span class="hljs-string">&quot;closed&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>              gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_5a931f7c6fc00aa446c3897242aa7dd9.png"></p><h4 id="grid-ployline"><a href="#grid-ployline" class="headerlink" title="grid.ployline"></a>grid.ployline</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R">polylineGrob<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>             y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>             id<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> id.lengths<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>             default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>             arrow <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>             gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><table><thead><tr><th><code>x</code></th><th>指定 x 值的数值向量或单位对象。</th></tr></thead><tbody><tr><td><code>y</code></td><td>指定 y 值的数值向量或单位对象。</td></tr><tr><td><code>default.units</code></td><td>指示仅以数字向量形式给出 <code>x</code> 或 <code>y</code> 时要使用的默认单位的字符串。</td></tr><tr><td><code>arrow</code></td><td>描述要放置在线条两端的箭头的列表，由 <code>arrow</code> 函数生成。</td></tr><tr><td><code>name</code></td><td>字符标识符。</td></tr><tr><td><code>gp</code></td><td>类 <code>&quot;gpar&quot;</code> 的对象，通常是调用函数 <code>gpar</code> 的输出。这基本上是图形参数设置的列表。</td></tr><tr><td><code>draw</code></td><td>指示是否应生成图形输出的逻辑值。</td></tr><tr><td><code>vp</code></td><td>网格视口对象（或 NULL）。</td></tr><tr><td><code>id</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分成多行的数值向量。所有具有相同 <code>id</code> 的位置都属于同一线路。</td></tr><tr><td><code>id.lengths</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分成多行的数值向量。指定组成单独行的连续位置块。</td></tr><tr><td><code>...</code></td><td>参数传递至 <code>polylineGrob</code> 。</td></tr></tbody></table><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.polyline<span class="hljs-punctuation">(</span>x<span class="hljs-operator">=</span>outer<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>             y<span class="hljs-operator">=</span>outer<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>             id.lengths<span class="hljs-operator">=</span><span class="hljs-built_in">rep</span><span class="hljs-punctuation">(</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>             gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span> lwd<span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_d29712265d28d6fe36e0b4e9b855c6dc.png"></p><h4 id="grid-xpline"><a href="#grid-xpline" class="headerlink" title="grid.xpline"></a>grid.xpline</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.xspline<span class="hljs-punctuation">(</span>...<span class="hljs-punctuation">)</span><br>xsplineGrob<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            id <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> id.lengths <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>            default.units <span class="hljs-operator">=</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>            shape <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> open <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span> arrow <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> repEnds <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>            name <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> vp <span class="hljs-operator">=</span> <span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><table><thead><tr><th><code>x</code></th><th>指定样条控制点x-locations的数值向量或单位对象。</th></tr></thead><tbody><tr><td><code>y</code></td><td>指定样条控制点y-locations的数值向量或单位对象。</td></tr><tr><td><code>id</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分成多个 xsplines 的数值向量。具有相同 <code>id</code> 的所有位置都属于同一 xspline。</td></tr><tr><td><code>id.lengths</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分隔成多个 xspline 的数值向量。指定构成单独xspline 的连续位置块。</td></tr><tr><td><code>default.units</code></td><td>指示 <code>x</code> 或 <code>y</code> 仅作为数值向量给出时使用的默认单位的字符串。</td></tr><tr><td><code>shape</code></td><td>值介于 -1 和 1 之间的数值向量，用于控制样条线相对于控制点的形状。</td></tr><tr><td><code>open</code></td><td>指示样条线是直线还是闭合形状的逻辑值。</td></tr><tr><td><code>arrow</code></td><td>说明要放置在 xspline 两端的箭头的列表，由 <code>arrow</code> 函数生成。</td></tr><tr><td><code>repEnds</code></td><td>一个逻辑值，指示是否应复制第一个和最后一个控制点来绘制曲线(请参阅下面的详细信息)。</td></tr><tr><td><code>name</code></td><td>字符标识符。</td></tr><tr><td><code>gp</code></td><td>类 <code>&quot;gpar&quot;</code> 的对象，通常是调用函数 <code>gpar</code> 的输出。这本质上是图形参数设置的列表。</td></tr><tr><td><code>vp</code></td><td>网格视口对象(或 NULL)。</td></tr><tr><td><code>...</code></td><td>要传递给 <code>xsplineGrob</code> 的参数。</td></tr></tbody></table><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>x <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.25</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.75</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.75</span><span class="hljs-punctuation">)</span><br>y <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.75</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.75</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span><br><br>xsplineTest <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>s<span class="hljs-punctuation">,</span> i<span class="hljs-punctuation">,</span> j<span class="hljs-punctuation">,</span> open<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>layout.pos.col<span class="hljs-operator">=</span>j<span class="hljs-punctuation">,</span> layout.pos.row<span class="hljs-operator">=</span>i<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  grid.points<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">,</span> default.units<span class="hljs-operator">=</span><span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span> pch<span class="hljs-operator">=</span><span class="hljs-number">16</span><span class="hljs-punctuation">,</span> size<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;mm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  grid.xspline<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">,</span> shape<span class="hljs-operator">=</span>s<span class="hljs-punctuation">,</span> open<span class="hljs-operator">=</span>open<span class="hljs-punctuation">,</span> gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;grey&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  grid.text<span class="hljs-punctuation">(</span>s<span class="hljs-punctuation">,</span> gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;grey&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            x<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> unit<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;mm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            y<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span>y<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> unit<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;mm&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            hjust<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>            vjust<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>  popViewport<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>width<span class="hljs-operator">=</span><span class="hljs-number">.5</span><span class="hljs-punctuation">,</span> x<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> just<span class="hljs-operator">=</span><span class="hljs-string">&quot;left&quot;</span><span class="hljs-punctuation">,</span><br>                      layout<span class="hljs-operator">=</span>grid.layout<span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> respect<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>layout.pos.row<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Open Splines&quot;</span><span class="hljs-punctuation">,</span> y<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> just<span class="hljs-operator">=</span><span class="hljs-string">&quot;bottom&quot;</span><span class="hljs-punctuation">)</span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>width<span class="hljs-operator">=</span><span class="hljs-number">.5</span><span class="hljs-punctuation">,</span> x<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> just<span class="hljs-operator">=</span><span class="hljs-string">&quot;right&quot;</span><span class="hljs-punctuation">,</span><br>                      layout<span class="hljs-operator">=</span>grid.layout<span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> respect<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>layout.pos.row<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Closed Splines&quot;</span><span class="hljs-punctuation">,</span> y<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> just<span class="hljs-operator">=</span><span class="hljs-string">&quot;bottom&quot;</span><span class="hljs-punctuation">)</span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>xsplineTest<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_f94decc7bb0065535df11335806b6433.png"></p><h4 id="grid-path"><a href="#grid-path" class="headerlink" title="grid.path"></a>grid.path</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R">pathGrob<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> y<span class="hljs-punctuation">,</span><br>         id<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> id.lengths<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>         pathId<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> pathId.lengths<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span><br>         rule<span class="hljs-operator">=</span><span class="hljs-string">&quot;winding&quot;</span><span class="hljs-punctuation">,</span><br>         default.units<span class="hljs-operator">=</span><span class="hljs-string">&quot;npc&quot;</span><span class="hljs-punctuation">,</span><br>         name<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span> gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> vp<span class="hljs-operator">=</span><span class="hljs-literal">NULL</span><span class="hljs-punctuation">)</span><br>grid.path<span class="hljs-punctuation">(</span>...<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><table><thead><tr><th><code>x</code></th><th>指定 x-locations 的数值向量或单位对象。</th></tr></thead><tbody><tr><td><code>y</code></td><td>指定 y-locations 的数值向量或单位对象。</td></tr><tr><td><code>id</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分隔为 sub-paths 的数值向量。所有具有相同<code>id</code>的位置都属于相同的sub-path。</td></tr><tr><td><code>id.lengths</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分隔为 sub-paths 的数值向量。指定组成单独sub-paths的连续位置块。</td></tr><tr><td><code>pathId</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分隔成不同路径的数值向量。所有具有相同 <code>pathId</code> 的位置都属于同一路径。</td></tr><tr><td><code>pathId.lengths</code></td><td>用于将 <code>x</code> 和 <code>y</code> 中的位置分隔成路径的数值向量。指定组成单独路径的连续位置块。</td></tr><tr><td><code>rule</code></td><td>指定填充规则的字符值： <code>&quot;winding&quot;</code> 或 <code>&quot;evenodd&quot;</code> 。</td></tr><tr><td><code>default.units</code></td><td>指示 <code>x</code> 或 <code>y</code> 仅作为数值向量给出时使用的默认单位的字符串。</td></tr><tr><td><code>name</code></td><td>字符标识符。</td></tr><tr><td><code>gp</code></td><td>类 <code>&quot;gpar&quot;</code> 的对象，通常是调用函数 <code>gpar</code> 的输出。这本质上是图形参数设置的列表。</td></tr><tr><td><code>vp</code></td><td>网格视口对象(或 NULL)。</td></tr><tr><td><code>...</code></td><td>传递给 <code>pathGrob()</code> 的参数。</td></tr></tbody></table><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>angle <span class="hljs-operator">&lt;-</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-operator">*</span><span class="hljs-built_in">pi</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">10</span><span class="hljs-punctuation">]</span><br>grid.path<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-number">0.25</span><span class="hljs-operator">+</span><span class="hljs-number">0.15</span><span class="hljs-operator">*</span><span class="hljs-built_in">cos</span><span class="hljs-punctuation">(</span>angle<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span><span class="hljs-number">0.5</span><span class="hljs-operator">+</span><span class="hljs-number">0.3</span><span class="hljs-operator">*</span><span class="hljs-built_in">sin</span><span class="hljs-punctuation">(</span>angle<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;grey&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>grid.path<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.75</span><span class="hljs-operator">+</span><span class="hljs-number">0.15</span><span class="hljs-operator">*</span><span class="hljs-built_in">cos</span><span class="hljs-punctuation">(</span>angle<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-number">.7</span><span class="hljs-punctuation">,</span><span class="hljs-number">.7</span><span class="hljs-punctuation">,</span><span class="hljs-number">.8</span><span class="hljs-punctuation">,</span><span class="hljs-number">.8</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          y<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.5</span><span class="hljs-operator">+</span><span class="hljs-number">0.3</span><span class="hljs-operator">*</span><span class="hljs-built_in">sin</span><span class="hljs-punctuation">(</span>angle<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-number">.4</span><span class="hljs-punctuation">,</span><span class="hljs-number">.6</span><span class="hljs-punctuation">,</span><span class="hljs-number">.6</span><span class="hljs-punctuation">,</span><span class="hljs-number">.4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          id <span class="hljs-operator">=</span> <span class="hljs-built_in">rep</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">9</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_55d3e61ab3b6ec761d9955633ace66d0.png"></p><h4 id="grid-point"><a href="#grid-point" class="headerlink" title="grid.point"></a>grid.point</h4><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><h4 id="viewpor"><a href="#viewpor" class="headerlink" title="viewpor()"></a>viewpor()</h4><p>viewport()创建新的视图，grid会默认生成一个根视图，这个视图对应整个页面，绘图是在整个页面，绘图是在整个页面中进行的，使用默认的绘图参数设置，直到创建新的视图为止。</p><h4 id="pushViewport"><a href="#pushViewport" class="headerlink" title="pushViewport()"></a>pushViewport()</h4><p>pushViewport()调入一个viewport()对象，并用它在糊涂设备上创建一个区域，这个区域成为后续图形输出的绘图背景。</p><h4 id="popViewport"><a href="#popViewport" class="headerlink" title="popViewport()"></a>popViewport()</h4><p>popViewport()函数有一个整数参数，默认的整数参数的值是1，指返回上一级的viewport()，整数参数为0，指返回最上级（root）viewport。</p><p>使用上面的三个视图函数绘图。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;top-left corner&quot;</span><span class="hljs-punctuation">,</span>x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;left&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;top&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">## 创建第一个视图</span><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>width <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;vp1&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>grid.rect<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;top-left coener&quot;</span><span class="hljs-punctuation">,</span>x<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;left&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;top&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">## 创建第二个视图</span><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>width <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;vp2&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>grid.rect<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;top-left coener&quot;</span><span class="hljs-punctuation">,</span>x<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;left&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;top&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">## 创建第三个视图</span><br>pushViewport<span class="hljs-punctuation">(</span>viewport<span class="hljs-punctuation">(</span>width <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>height <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>angle <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;vp3&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>grid.rect<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;top-left coener&quot;</span><span class="hljs-punctuation">,</span>x<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>y <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;left&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;top&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">## </span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;bottom-right coener&quot;</span><span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;bottom&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">##</span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;bottom-right coener&quot;</span><span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;bottom&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;green&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">##</span><br>popViewport<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br>grid.text<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;bottom-right coener&quot;</span><span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>x <span class="hljs-operator">=</span> unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;npc&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">-</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mm&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>just <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;right&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;bottom&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span><span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><img src="https://markdown.liuchengtu.com/work/uploads/upload_603d37deb937380236d3e7372244546d.png"></p><h4 id="upViewport函数和downViewport函数"><a href="#upViewport函数和downViewport函数" class="headerlink" title="upViewport函数和downViewport函数"></a>upViewport函数和downViewport函数</h4><p>upViewport()和downViewport()和popViewport函数的区别在于，popViewpoprt()会从页面中移除当前视图，但是upViewport和downViewport不会。</p><h4 id="seekViewport"><a href="#seekViewport" class="headerlink" title="seekViewport()"></a>seekViewport()</h4><p>seekViewport用于遍历视图树，在交互过程总会比较方便。</p><h3 id="视图列表，栈，树"><a href="#视图列表，栈，树" class="headerlink" title="视图列表，栈，树"></a>视图列表，栈，树</h3><ul><li>vpList()</li><li>vpStack()</li><li>vpTree()</li></ul><h2 id="grid绘图对象模型"><a href="#grid绘图对象模型" class="headerlink" title="grid绘图对象模型"></a>grid绘图对象模型</h2><h3 id="绘图元件grob"><a href="#绘图元件grob" class="headerlink" title="绘图元件grob"></a>绘图元件grob</h3><h4 id="grid-ls"><a href="#grid-ls" class="headerlink" title="grid.ls()"></a>grid.ls()</h4><p>grid.list()会显示的列出所有的绘图元件</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.circle<span class="hljs-punctuation">(</span>r<span class="hljs-operator">=</span><span class="hljs-number">.4</span><span class="hljs-punctuation">,</span>name<span class="hljs-operator">=</span><span class="hljs-string">&quot;mycircle&quot;</span><span class="hljs-punctuation">)</span><br>grid.ls<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># mycircle</span><br></code></pre></td></tr></table></figure><h4 id="grid-edit"><a href="#grid-edit" class="headerlink" title="grid.edit()"></a>grid.edit()</h4><p>grid.edit()修改列表中的绘图元件</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs R">grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>grid.circle<span class="hljs-punctuation">(</span>r<span class="hljs-operator">=</span><span class="hljs-number">.4</span><span class="hljs-punctuation">,</span>name<span class="hljs-operator">=</span><span class="hljs-string">&quot;mycircle&quot;</span><span class="hljs-punctuation">)</span><br>grid.ls<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># mycircle</span><br>grid.edit<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;mycircle&quot;</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><img src="https://markdown.liuchengtu.com/work/uploads/upload_96befd38beafcfaef7a37e45c348c91a.png" style="zoom:50%;" /><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs R">suffix <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">rep</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;odd&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;even&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span> <span class="hljs-operator">&lt;-</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;circle&quot;</span><span class="hljs-punctuation">,</span>suffix<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span><br>grid.newpage<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  grid.circle<span class="hljs-punctuation">(</span>name <span class="hljs-operator">=</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">[</span>i<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>r<span class="hljs-operator">=</span><span class="hljs-punctuation">(</span><span class="hljs-number">9</span><span class="hljs-operator">-</span>i<span class="hljs-punctuation">)</span><span class="hljs-operator">/</span><span class="hljs-number">20</span><span class="hljs-punctuation">,</span>gp<span class="hljs-operator">=</span>gpar<span class="hljs-punctuation">(</span>col<span class="hljs-operator">=</span> <span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> fill<span class="hljs-operator">=</span>gray<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment"># grid.ls()</span><br>grid.edit<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;circleodd&quot;</span><span class="hljs-punctuation">,</span>gp <span class="hljs-operator">=</span> gpar<span class="hljs-punctuation">(</span>fill<span class="hljs-operator">=</span><span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>global <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p> <img src="https://markdown.liuchengtu.com/work/uploads/upload_7b72d116d31c0da411ee56e9e9a0ce53.png"></p><h3 id="图形树gTrees"><a href="#图形树gTrees" class="headerlink" title="图形树gTrees"></a>图形树gTrees</h3><h4 id="捕捉和输出"><a href="#捕捉和输出" class="headerlink" title="捕捉和输出"></a>捕捉和输出</h4><h4 id="grid-grab和grid-grabExpr"><a href="#grid-grab和grid-grabExpr" class="headerlink" title="grid.grab和grid.grabExpr"></a>grid.grab和grid.grabExpr</h4>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>测试文章02</title>
    <link href="/2024/01/09/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/"/>
    <url>/2024/01/09/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/</url>
    
    <content type="html"><![CDATA[<p><img src="/./images/test.png"></p><p>this is a test</p>]]></content>
    
    
    <categories>
      
      <category>R语言</category>
      
    </categories>
    
    
    <tags>
      
      <tag>R语言</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2023/09/03/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E8%AF%AD%E8%A8%80%E4%B8%AD%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87%E4%BA%8B%E4%BB%B6/"/>
    <url>/2023/09/03/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E8%AF%AD%E8%A8%80%E4%B8%AD%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87%E4%BA%8B%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="R语言中键盘和鼠标事件"><a href="#R语言中键盘和鼠标事件" class="headerlink" title="R语言中键盘和鼠标事件"></a>R语言中键盘和鼠标事件</h1>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2023/08/14/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E4%B8%AD%E7%9A%84%E9%9D%9E%E6%A0%87%E5%87%86%E8%AF%84%E4%BC%B0/"/>
    <url>/2023/08/14/R%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/R%E4%B8%AD%E7%9A%84%E9%9D%9E%E6%A0%87%E5%87%86%E8%AF%84%E4%BC%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="R中的非标准评估"><a href="#R中的非标准评估" class="headerlink" title="R中的非标准评估"></a>R中的非标准评估</h1><h2 id="什么是非标准评估"><a href="#什么是非标准评估" class="headerlink" title="什么是非标准评估"></a>什么是非标准评估</h2><p>非标准评估（Non-standard evaluation，简称NSE）是R语言中的一个重要概念，涉及到如何处理变量、表达式和函数的名称。在标准的编程语言中，通常使用变量的名称来引用和操作变量，但在非标准评估中，变量的名称可能不是直接的字符串，而是以某种形式传递给函数或表达式。<font color="red"> 简单的说就是在编写函数的时候，有时候参数的传入是字符串，但是我们在函数体内传入的不是字符串，此时就需要使用标准评估进项转化。</font></p><p><strong>Tidy Evaluation (Tidy Eval)，不是一个宏包，而是一个非标准评估的框架，也叫延迟评估。主要目的是更方便地与tidyverse里的函数配合使用，事实上，很多时候我们不一定需要用到它</strong></p><ol><li>**enquo()**：<code>enquo</code> 是 “enquoting” 的缩写，用于创建一个引用（quosure）对象，将变量捕捉到一个对象中，以便在非标准评估环境中使用。它可以用来保存传递给函数的参数，并在函数内部使用。</li><li>**!!**（bang-bang）：<code>!!</code> 运算符，也叫 “unquote-splice” 运算符，用于将一个引用（quosure）解引用，使其成为正常的R表达式。它在函数内部用于执行非标准评估，将引用的值插入到表达式中。</li><li>**!!!**（triple-bang）：<code>!!!</code> 运算符，也叫 “unquote-splice” 运算符，用于将引用列表（list of quosures）解引用并展开成单个表达式。它允许您将多个引用嵌入到表达式中，以进行多个非标准评估操作。</li><li>**sym()**：<code>sym</code> 函数用于将字符转换为符号（symbol）。符号是一个表示R语言变量名的对象，可以在非标准评估环境中使用。</li><li>**syms()**：<code>syms</code> 函数用于将多个字符转换为一组符号。这在需要处理多个变量名时很有用，例如在循环中构建非标准评估的表达式</li></ol><h2 id="enquo"><a href="#enquo" class="headerlink" title="enquo()"></a>enquo()</h2><p>enquo是rlang包中用于非标准评估的函数之一，用于将变量捕获为引用对象(quosure)，以便在函数内部使用。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>rlang<span class="hljs-punctuation">)</span><br><br>data <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span>value <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>calculate_mean <span class="hljs-operator">&lt;-</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> column<span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span><br>  column_quo <span class="hljs-operator">&lt;-</span> enquo<span class="hljs-punctuation">(</span>column<span class="hljs-punctuation">)</span>  <span class="hljs-comment"># 捕获变量为引用对象</span><br>  <br>  mean_value <span class="hljs-operator">&lt;-</span> data <span class="hljs-operator">%&gt;%</span><br>    summarise<span class="hljs-punctuation">(</span>mean_value <span class="hljs-operator">=</span> mean<span class="hljs-punctuation">(</span><span class="hljs-operator">!</span><span class="hljs-operator">!</span>column_quo<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span>  <span class="hljs-comment"># 使用 !! 解引用引用对象</span><br>  <br>  <span class="hljs-built_in">return</span><span class="hljs-punctuation">(</span>mean_value<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br><br>result <span class="hljs-operator">&lt;-</span> calculate_mean<span class="hljs-punctuation">(</span>data<span class="hljs-punctuation">,</span> column <span class="hljs-operator">=</span> value<span class="hljs-punctuation">)</span><br>print<span class="hljs-punctuation">(</span>result<span class="hljs-operator">$</span>mean_value<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 输出20</span><br></code></pre></td></tr></table></figure><p>在R中，<code>!!</code>（双感叹号）是 <code>rlang</code> 包中用于非标准评估（Non-Standard Evaluation，NSE）的一个关键运算符，它用于解引用引用（quosure）对象，将其嵌入到表达式中。在非标准评估环境中，<code>!!</code> 通常与 <code>enquo()</code> 函数一起使用，以便在函数内部引用外部变量。</p><p><font color="green">在上面的函数中value是环境变量名称没如果需要需要将value当中data数据框中的一列进行应用，需要对数据进行应用（quote）和解引用（unqote）两步</font></p><ul><li>第一步，用 <code>enquo()</code>把用户传递过来的参数引用起来（<strong>引用</strong>可以理解为<strong>冷冻</strong>起来）</li><li>第二步，用 <code>!!</code> 解开这个引用（<strong>解引用</strong>可以理解为<strong>解冷</strong>），然后使用参数的内容</li></ul><p>这个<code>quote-unquote</code>的过程让环境变量名变成了数据变量，也可以理解为在函数评估过程中，数据变量（data-variable）遮盖了环境变量（env-variable），即数据遮盖（data masking），看到value，正常情况下，本来应该是到环境变量里去找这个valuel对应的值，然而，数据遮盖机制，插队了，让代码去数据变量中去找valuel以及对应的值。</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
